<!DOCTYPE html>
<html>
<head>
    <title>Graph Engine</title>
    <script type="text/javascript" src="deps/vivagraph.js"></script>
	<script type="text/javascript" src="custom/configloader.json"></script>
	<script type="text/javascript" src="custom/defaultConfig.json"></script>
	<script type="text/javascript" src="custom/config/Schema.json"></script>
	<script type="text/javascript" src="custom/config/Data.json"></script>
    <!--
    This example uses jQuery, but it's only for convenience of listenting
    to DOM events. The jQuery can be replaced with your favorite library.
     -->
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript">

//==========Globals ==================================================================================================================================================================			
		//const UI_SHADOW_INDEX = 0;
		var LINK_INDEX_0 = 0;
		var LINK_INDEX_1 = 0;
		var MARKER_INDEX_0 = 0;
		var binaryToggle = true;
		//.....Functional variables.......
		var labelsList = []; //list of "neoLabel" objects
		var nodeList = []; //list of "node" objects
		var monitoredNodes = [];//list of "node" objects
		var toolPanels = [];
		var monitoredLinks = []; //list of "link" objects
		var animUpdateNodes = [];//list of "node" objects
		var animUpdateLinks = []; //list of "link" objects
		var checkedNodes = []; //list of "node" objects
		var checkedLinks = []; //list of "node" objects
		//var highlightedLinks = [];
		var linkList = []; //list of "link" objects
		var timeoutElements = []; //list of "timeoutElement" objects
		var masterConfigs = [];
		//var connections = [];
		var selectedNodeID = '';
		var selectedNodeData = '';
		var selectedNode = '';
		var selectedNodeUI = '';
		var bRelate = false;
		var bPlanRelate = false;
		var counter = 10;	
		var detailsUI;
		var detailsNode;
		var processUniqueId = 0; //...must be incremented every time its used
		
		//......Connection settings........
		//var connections = []; //array of neo4jConnectionType
		//var defaultNeo4jUsername = 'neo4j';
		//var defaultNeo4jPassword = 'password1234$';
		//var neo4jUserToken = '';
		//var neo4jServerURL = 'http://localhost:7474';

		//......Filter settings.............
		var viewOptions = new viewOptionsType();
		var interactionOptions = new interactionOptionsType();

		//......Display settings............
		var currentTheme = new theme();
		var MaxLabelLength = 5; //the amount of characters allowed before elipse
		var labelSize = 30;
		var CommonUI = {};
	
		//SINGLETONS...
		var GRAPH = '';
		var graphics = '';
		var layout = '';
		var renderer = '';
		var graphContainer;

		
//STARTUP SEQUENCE
		var config_ext;
		
		Configuration(setConfigSettings); //get config, setup common UI
		//Configuration(connectUser);
		//setup UI
		checkTimeoutElements() //start monitoring timeout elements
		
	
//MODELS	
		//Node model
		function datax() {
		  this.nodeType = 'data';
		  this.source; //a label describing which database the node comes from/
		  //this.dbdestination = ''; //a label describing which database the node performs opertions on/
		  this.id = 0;
		  this.labels = []; //string array of labels
		  this.nodeSize = 25;
		  this.nodeColor = '#808080';
		  this.nodeBorderColor = '#808080';
		  this.nodeShape = 'circle';
		  this.height = 25;
		  this.width = 25;
		  this.nodeColorRGB = {r:100,g:100,b:100};
		  this.nodeOpacity = '1'
		  this.textColor = '#ffffff';
		  this.displayLabel = '';
		  this.isPinned = false; 
		  this.properties = [];
		  this.toLinks = [];
		  this.fromLinks = [];
		  this.totalToLinks = 0; //fetched from database
		  this.totalFromLinks = 0; //fetched from database
		  this.toNodes = [];
		  this.fromNodes = [];
		  this.subNodes = [];
		  this.superNodes = [];
		  this.UI= new nodeUiElements();
		  this.config = {}
		  this.sourceConfig = currentTheme.sourceConfig; 
		  this.config.nodeDisplayBody = {};
		  this.config.nodeDisplayValues = {};
		  return this;
		}
		
		function property(key, value)
		{
			this.key = key;
			this.value = value;
			return this;
		}
		function nodeUiElements()
		{
			this.fullUI;
			this.bodyUI;
			this.imageUI;
			this.focusUI;
			this.checkUI;
			this.displayTextUI;
			this.popoutUI;
			this.popoutInfoUI;
			this.popoutBodyUI;
			this.popoutTextUI;
			return this;
		}
		
		function LinkUiElements()
		{
			this.fullUI;
			this.pathUI;
			this.focusUI;
			this.toMarkerUI;
			this.fromMarkerUI;
			this.midMarkerUI;
			this.nameTextUI;
			this.subTextUI;
			this.popoutBodyUI;
			this.popoutTextUI;
			return this;
		}
		
		//Link model
		function datay(fromNodeId, toNodeId, linkId, name, sourceConfig){
			this.linkType = 'data';
			//this.source; //...neo4jConnectionType
			this.fromNodeID = fromNodeId;
			this.toNodeID = toNodeId ? toNodeId :-1;
			this.id = linkId ? linkId : -1;
			this.color = currentTheme.linkColor;
			this.thickness = 1;
			this.name =  name ? name : '';
			this.displayLabel = '';
			this.properties = [];
			this.UI = {};
			this.checked = false; //...flag which indicates if the link is checked.
			this.displayingData = false; //...flag which indicates if the link label is currently displayingData.
			this.config = {}
			this.sourceConfig = currentTheme.sourceConfig;
			//this.config.linkDisplayBody = {};
			this.config.linkDisplayValues = {};
			
			if (sourceConfig){
				this.color = sourceConfig.displaySettings.linkColor
			}
			return this;
		}
		
		function timeoutElement(_element, _duration)
		{
			this.duration = _duration; //in seconds
			this.activationPoint = +new Date(); //+new Date()
			this.element = _element; //UI element
		}
		
		function neo4jConnectionType(name, url, username, password)
		{
			this.name = name;
			this.username = username;
			this.password = password;
			this.server = url;
			this.userToken =  window.btoa(username + ':' + password);
		}
		
		function neoLabel(setName, setColor, setColorRGB, setSourceConfig)
		{
			this.sourceConfig = setSourceConfig;
			this.instanceCount = 0;
			this.name = setName;
			this.color = setColor;
			this.colorRGB = setColorRGB;
			return this;
		}
		
		/*function linkType(fromNodeID, toNodeID, linkData, dataLinkid)
		{
			this.FromNodeID = fromNodeID;
			this.ToNodeID = toNodeID;
			this.data = linkData;
			return this;
		}*/
		
		
		function viewOptionsType()
		{
			this.highlightRelated = true;
			this.highlightAncestors = false;
			this.highlightdescendants = false;
			this.navigateDirection = 'both';
			return this;
		}
		
		function interactionOptionsType()
		{
			this.checkNodes = false;
			return this;
		}
		
		function theme(entityRgbRange, graphBackground, entityLabelColor)
		{
			this.entityRgbRange = (entityRgbRange)?entityRgbRange: {min:100,max:200};
			/*The 4bit rgb range from which label colors can be automatically generated.*/
			this.graphBackground = (graphBackground)?graphBackground: '#1a1a1a';
			this.entityLabelColor = (entityLabelColor)?entityLabelColor: 'white';
			//this.entityShape = (entityShape)?entityShape: 'rect';
			this.opaque = false;
			/*choices: 
				rect (entities are rectangular)
				circle (entities are circles)
			*/
			this.labelSizing = "fontsize"; 
			/*choices: 
				"hyphenate" (make labels shorter)
				"fontsize" (make the font size smaller)
				"" (no sizing, labels may extend past the boundaries of the node)
			*/
			this.shadow = true;
			this.glow = false;
			this.linkColor = 'red';
			this.rounded = false;
			this.showLabels = true;
		}
		

//FUNCTIONS...
		
		function setConfigSettings(config)
		{
			currentTheme.sourceConfig = config;
			currentTheme.backgroundImage=config.displaySettings.backgroundImage;
			currentTheme.loadNodePopouts =config.displaySettings.loadNodePopouts;
			currentTheme.loadRelationPopouts = config.displaySettings.loadRelationPopouts;
			currentTheme.entityRgbRange =config.displaySettings.entityRgbRange;
			currentTheme.linkThickness = config.displaySettings.linkThickness;
			currentTheme.entityRgbRange =config.displaySettings.entityRgbRange;
			currentTheme.graphBackground =config.displaySettings.graphBackground;
			currentTheme.entityLabelColor =config.displaySettings.entityLabelColor;
			//currentTheme.entityShape = config.displaySettings.entityShape;
			currentTheme.opaque =config.displaySettings.opaque;
			currentTheme.labelSizing =config.displaySettings.labelSizing;
			currentTheme.shadow =config.displaySettings.shadow;
			currentTheme.entityBorderColor = config.displaySettings.entityBorderColor;
			currentTheme.glow =config.displaySettings.glow;
			currentTheme.linkColor =config.displaySettings.linkColor;
			currentTheme.rounded =config.displaySettings.rounded;
			currentTheme.showLabels=config.displaySettings.showLabels;
			currentTheme.showRelationships = config.displaySettings.showRelationships;
			currentTheme.showRelationProperties = config.displaySettings.showRelationProperties;
			currentTheme.haze = config.displaySettings.haze;
			currentTheme.highlightHaze = config.displaySettings.highlightHaze;
			currentTheme.linkMainTextColor = config.displaySettings.linkMainTextColor;
			currentTheme.linkSubTextColor = config.displaySettings.linkSubTextColor;

			//setup connections...
			//config.neo4jconnections.forEach(function (conn){
			//	var connection = new neo4jConnectionType(conn.sourceName, conn.server, conn.username, conn.password);
			//	connections.push(connection);
			//	//set default connection...
			//	if (connection.name == config.startupOptions.defaultConnection){
			//		currentTheme.currentConnection = connection
			//	}
			//});

			//setting up panels...
			$topBar = document.getElementById('topBar');
			$topBar.addEventListener('dragenter', handleDragEnter, false);
			$topBar.addEventListener('dragover', handleDragOver, false);
			$topBar.addEventListener('dragleave', handleDragLeave, false);
			$topBar.addEventListener('drop', handleDrop, false);
			//$topBar.addEventListener('dragend', handleDragEnd, false);
			
			config.viewOptions.panels.forEach(function(panel){
				//jed3
				//$elParent = document.getElementById(panel.parent)	
				$elPanel = document.getElementById(panel.name);
				//elParent.innerHtml += elPanel;
				//$elPanel.style.visibility = (panel.visible)?'visible':'hidden';
				
				if (panel.visible){
					$parentContainer = document.getElementById(panel.parent);
					if ($parentContainer){
						if (panel.parent == "topBar"){
							
						}
						else{
							$parentContainer.appendChild($elPanel);
						}
					}
					
					$elPanel.setAttribute('draggable', true);
					$elPanel.addEventListener('dragstart', handleDragStart, false);
					//$elPanel.addEventListener('dragenter', handleDragEnter, false);
					//$elPanel.addEventListener('dragover', handleDragOver, false);
					//$elPanel.addEventListener('dragleave', handleDragLeave, false);
					//$elPanel.addEventListener('drop', handleDrop, false);
					$elPanel.addEventListener('dragend', handleDragEnd, false);
					toolPanels.push($elPanel);
				}
				else{
					$elPanel.remove();
					var isOpen = $elPanel.classList.contains('slide-in');
					$elPanel.setAttribute('class', isOpen ? 'toolPanel slide-out' : 'toolPanel slide-in');
				}
				
				////{"panels":[{"name":"panelSelectionOptions", "parent":"leftColumn", "visibility":true}]}
			});

			//Set global variable
			config_ext = config;
			
			setupCommonUI();

			//GET ALL LABELS>>
			masterConfigs.forEach(function (cnf){
				if (cnf.viewOptions.prefetchLabelSelectors){
					Neo4jGetAllLabels(cnf); //..get all entity names from the DB
				}
				
				//GET STARTUP NODES>>
				cnf.startupOptions.startupSearch.forEach(function(search, index){
					Neo4jGetNodesByDetails(search.label, search.properties, cnf)
				});
				
				//RUN STARTUP QUERIES>>
				cnf.startupOptions.startupQueries.forEach(function(search, index){
					Neo4jQuerySimpleSearch(search.fromEntity, search.whereProperty, search.equalsValue, cnf);
				});
			});
			
		}
		
		
		//................Tool panels - Drag and drop................
		function handleDragOver(e) {
		  if (e.preventDefault) {
			e.preventDefault(); // Necessary. Allows us to drop.
		  }
		  e.dataTransfer.dropEffect = 'move';  // See the section on the DataTransfer object.
		  return false;
		}
		function handleDragStart(e) {
		  this.style.opacity = '0.4';  // this / e.target is the source node.
		}
		function handleDragLeave(e) {
		  this.classList.remove('over');  // this / e.target is previous target element.
		}
		function handleDragEnter(e) {
		  // this / e.target is the current hover target.
		  this.classList.add('over');
		}
		function handleDrop(e) {
		  // this / e.target is current target element.
		  if (e.stopPropagation) {
			e.stopPropagation(); // stops the browser from redirecting.
		  }
		  // See the section on the DataTransfer object.
		  return false;
		}
		function handleDragEnd(e) {
		  // this/e.target is the source node.
		  this.style.opacity = '0.9';
		  toolPanels.forEach(function (col) {
			col.classList.remove('over');
		  });
		}
		//................................................................................
		
		//function setupUI()
		//{
			/*var $slider = document.getElementById('slider');
			var $leftColumn = document.getElementById('leftColumn');
			var $toggle = document.getElementById('toggle');	
			$toggle.addEventListener('click', function() {
				var isOpen = $slider.classList.contains('slide-in');
				if(isOpen){
					$leftColumn.appendChild($slider);
				}
				else{
					$leftColumn.removeChild($slider);
				}
				$slider.setAttribute('class', isOpen ? 'toolPanel slide-out' : 'toolPanel slide-in');
			});*/
		//}
		


		//Get config file...
		function Configuration(callback)
		{
			$(document).ready(function(e) {
				configManager = configManager; //config manager from file
				
				if (configManager.configs.length == 0) {
					alert("Error: unable to load configurations");
					return;
				}
				
				masterConfigs = [];
				var DefaultConfig = configManager.configs[0];
				
				//Merge configs, so that all configs are equal, except for their differences...
				configManager.configs.map(function (cnf){masterConfigs.push($.extend(true, {}, DefaultConfig, cnf));} )
				
				//Update the config selector on the UI...
				var selectorElement = document.getElementById("configSelector");
				masterConfigs.forEach(function (cnf){
					selectorElement.innerHTML += '<option value="'+cnf.configName+'">' + cnf.configName + '</option>';
				});
				
				//setupUI();
				
				callback(masterConfigs[0]);	
				
			});
		}
		
		function setupCommonUI(){
					//Common UI...
			CommonUI.focusUI = Viva.Graph.svg('circle')
							.attr('cx', 0) //...for circle
							.attr('cy', 0)//...for circle
							.attr('r',50)
							.attr('fill','transparent')//'#4dffc3')
							.attr('stroke',currentTheme.sourceConfig.displaySettings.focusColor)
							if (!currentTheme.sourceConfig.displaySettings.opaque) {CommonUI.focusUI.attr('stroke-opacity','0.5')}
							//.attr('stroke-opacity',0.5);
							if (currentTheme.sourceConfig.displaySettings.entityShape == "rect") {
								CommonUI.focusUI.attr('width',50 * 3);
								CommonUI.focusUI.attr('height',50 * 2);
								CommonUI.focusUI.attr('rx',50/4);
								CommonUI.focusUI.attr('x',-(50*3/2));
								CommonUI.focusUI.attr('y',-(50*2/2));
							}
						
			CommonUI.linkFocusUI = Viva.Graph.svg('path')
							   .attr('stroke', currentTheme.sourceConfig.displaySettings.focusColor)
							   .attr('stroke-width', '5')
							   
			CommonUI.checkUI = Viva.Graph.svg('circle')
							.attr('cx', 0) //...for circle
							.attr('cy', 0)//...for circle
							.attr('r',50)
							.attr('fill','transparent')//'#4dffc3')
							.attr('stroke',currentTheme.sourceConfig.displaySettings.highlightColor)
							.attr('stroke-width', '5')
							if (!currentTheme.sourceConfig.displaySettings.opaque) {CommonUI.checkUI.attr('stroke-opacity','0.5')}
							if (currentTheme.sourceConfig.displaySettings.highlightHaze) {CommonUI.checkUI.attr('filter','url(#hazeEffect)');}
							
			//MARKER: TEXT
			CommonUI.linkMidMarker = Viva.Graph.svg('marker')
				.attr('class', 'markertextmain')
				//.attr('id', linklabelId )
				.attr('viewBox', "-4 -6 8 12")
				.attr('refX', "3")
				.attr('refY', "0.5")
				.attr('markerWidth', "500")
				.attr('markerHeight', "100")
				.attr('markerUnits', "userSpaceOnUse")
				.attr('orient', "auto");
			
			CommonUI.linkName = Viva.Graph.svg('text')
					.attr('class','markertextlabel')
					.attr('x', '0')
					.attr('y', '0.5')
					.attr('fill',currentTheme.sourceConfig.displaySettings.linkMainTextColor)
					.attr('font-family','Arial, Helvetica, sans-serif')
					.attr('font-size','1.5')

			//		.text(link.data.name);
			//if (currentTheme.sourceConfig.displaySettings.showRelationships == "on-highlight") {markerLabel.attr('fill','transparent')}
			
			//var propertyList = link.data.properties.forEach(function(prop){var x = ''; prop})
			CommonUI.linkProps = Viva.Graph.svg('text')
					.attr('class','markertextsub')
					.attr('x', '0')
					.attr('y', '.5')
					.attr('fill',currentTheme.sourceConfig.displaySettings.linkSubTextColor)
					.attr('font-family','Arial, Helvetica, sans-serif')
					.attr('font-size','1')
			//		.text('');
			//markerProperties.innerHTML = propertyListToSvgList(link.data.properties, '<tspan x="0" dy="1.2em">', '</tspan>');
					
			CommonUI.popoutInfoUI = Viva.Graph.svg('g');

			CommonUI.popoutTextUI = Viva.Graph.svg('text')
						//.attr('class', 'slidetext')
						.attr('y', 0) //node.data.nodeSize/2 + 5)
						.attr('x', 0)// - node.data.displayLabel.length)
						.attr('fill',currentTheme.sourceConfig.displaySettings.entityPopoutTextColor)
						.attr('stroke-width','0')
						.attr('font-family','Arial, Helvetica, sans-serif')
						.attr('font-size','10')
						.attr('opacity', 0)
						.text('--');
					//popoutTextUI.innerHTML = propertyListToSvgList(node.data.properties, '<tspan x="50" dy="1.2em">', '</tspan>');

			CommonUI.popoutBodyUI = Viva.Graph.svg('rect')
                        //.attr('class', 'slidebody')
                        .attr('width', 0)
						.attr('x', 0)
                        .attr('y', 0)
                        .attr('rx', 7)
                        .attr('height', 0)
						.attr('fill','#141414')
						//.attr('width','20%')

                    if (!currentTheme.sourceConfig.displaySettings.opaque) {CommonUI.popoutBodyUI.attr('fill-opacity',0.3);}
					
			CommonUI.popoutInfoUI.append(CommonUI.popoutBodyUI);
			CommonUI.popoutInfoUI.append(CommonUI.popoutTextUI);
		
		}
				
		function changeConfig()
		{
			var selectedConfigName = document.getElementById("configSelector").value;
			masterConfigs.map(function (cnf){if (cnf.configName == selectedConfigName){currentTheme.sourceConfig = cnf; applyConfigUpdates(cnf)} });
		}
		function applyConfigUpdates(_sourceConfig)
		{
			graphContainer = document.getElementById('graphContainer');
			graphContainer.style.background=_sourceConfig.displaySettings.graphBackground;
			if (_sourceConfig.displaySettings.backgroundImage!=null){
				graphContainer.style['background-image'] =  'url('+_sourceConfig.displaySettings.backgroundImage+')'
			};
		}
		
		
		/*every second, checks the list of timeout elements, and removes any which have timed out*/
		function checkTimeoutElements()
		{
			setTimeout(function(){ 
				
				var i = 0;
				while(i < timeoutElements.length)
				{
					var tele = timeoutElements[i];
					var currenttime = +new Date();
					if (currenttime > tele.activationPoint + (tele.duration *1000))
					{	//remove element...
						tele.element.remove();
						timeoutElements.splice(i, 1);
					}
					else (i++);
				}
				checkTimeoutElements(); 
			}, 1000);
		}
		
		
		function removeMonitoredNode(nodeid)
		{
			var searchedIndex = -1;
			monitoredNodes.map(function (node, index){if (node.id == nodeid) {searchedIndex = index;}})			
			if (searchedIndex > -1) {
				monitoredNodes.splice(searchedIndex, 1);
				var vislist = document.getElementById('nodelist.monitored');
				for (var i = 0; i < vislist.children.length; i++ ){
					if (vislist.children[i].children[0].children[2].innerHTML == nodeid
					&& vislist.children[i].children[0].children[1].innerHTML == 'node:'){
						vislist.children[i].remove();
					}
				}
			}	
		}
		
		function removeMonitoredLink(linkid)
		{
			var searchedIndex = -1;
			monitoredLinks.map(function (link, index){if (link.data.id == linkid) {searchedIndex = index;}})			
			if (searchedIndex > -1) {
				monitoredLinks.splice(searchedIndex, 1);
				var vislist = document.getElementById('nodelist.monitored');
				for (var i = 0; i < vislist.children.length; i++ ){
					if (vislist.children[i].children[0].children[2].innerHTML == linkid
					&& vislist.children[i].children[0].children[1].innerHTML == 'link:'){
						vislist.children[i].remove();
					}
				}
			}	
		}

		function monitorNode(node)
		{
			var alreadymonitored = false;
			monitoredNodes.map(function(n){if (n.id == node.id) alreadymonitored = true;});
			if (!alreadymonitored){
				monitoredNodes.push(node);
				var removeButton = '<button class="fortext tooltip" onclick="removeMonitoredNode('+ node.id +')" >X<div class="tooltiptext">stop monitoring</div></button>'
				addValueToList('nodelist.monitored', removeButton, 'node:',  node.id)
			}
		}
		
		function monitorLink(link)
		{
			var alreadymonitored = false;
			monitoredLinks.map(function(n){if (n.data.id == link.data.id) alreadymonitored = true;});
			if (!alreadymonitored){
				monitoredLinks.push(link);
				var removeButton = '<button class="fortext tooltip" onclick="removeMonitoredLink('+ link.data.id +')" >X<div class="tooltiptext">stop monitoring</div></button>'
				addValueToList('nodelist.monitored', removeButton, 'link:',  link.data.id)
			}
		}
		
		function monitorCheckedItems()
		{
			//add nodes...
			if (selectedNode) {monitorNode(selectedNode);}
			checkedNodes.forEach(function (node){
				monitorNode(node);
			});	
			//add links...
			checkedLinks.forEach(function (link){
				monitorLink(link);
			});

			pollDatabase();
		}
		
		function clearAllMonitored()
		{
			while (monitoredNodes.length >0){
				removeMonitoredNode(monitoredNodes[0].id);
			}
			while (monitoredLinks.length >0){
				removeMonitoredLink(monitoredLinks[0].data.id)
			}
		}
		
		/*The following 3 functions form a closed loop*/
		function pollDatabase()
		{
			setTimeout(function(){ Neo4jCheckMonitoredNodes();}, config_ext.monitoringOptions.pollInterval * 1000);
		}
		function Neo4jCheckMonitoredNodes(_sourceConfig)
		{
			if (monitoredNodes.length == 0){return;}
			var id = 0;
			var callback = function(nodesResult, sourceConfig){
				addSingleNodesFromResults(nodesResult, sourceConfig);
				if(id >= monitoredNodes.length){
					performAnimations();
					setTimeout(function(){ Neo4jCheckMonitoredLinks(); }, config_ext.monitoringOptions.pollInterval * 1000);
					return;
				}
				var command = 'MATCH (n) WHERE ID(n) = '+ getNeoId(monitoredNodes[id++].id) + ' RETURN id(n), labels(n), n';
				Neo4j_Command([command], callback, sourceConfig);
			};
			var command = 'MATCH (n) WHERE ID(n) = '+ getNeoId(monitoredNodes[id++].id) + ' RETURN id(n), labels(n), n';
			Neo4j_Command([command], callback, _sourceConfig);
		}
		function Neo4jCheckMonitoredLinks(_sourceConfig)
		{
			if (monitoredLinks.length == 0){return;}
			var id = 0;
			var callback = function(relationsResult, sourceConfig){
				addSingleRelationFromResults(relationsResult);
				if(id >= monitoredLinks.length){
					performAnimations();
					setTimeout(function(){ pollDatabase(); }, config_ext.monitoringOptions.pollInterval * 1000);
					return;
				}
				var command = 'MATCH (n)-[r]-(m) WHERE ID(r) = '+ getNeoId(monitoredLinks[id++].data.id) + ' RETURN id(n), id(m), id(r), type(r), r';
				Neo4j_Command([command], callback, sourceConfig);
			};
			var command = 'MATCH (n)-[r]-(m) WHERE ID(r) = '+ getNeoId(monitoredLinks[id++].data.id) + ' RETURN id(n), id(m), id(r), type(r), r';
			Neo4j_Command([command], callback, _sourceConfig);
		}
		/*loop*/
		
		function addSatelliteToNode(node)
		{
			var rippleCircle = Viva.Graph.svg('circle')
						.attr('cx', 0)
						.attr('cy', 0)
						.attr('r', node.data.nodeSize)
						.attr('fill','transparent')//node.data.nodeColor)//'#4dffc3')
						.attr('stroke','red')
						.attr('stroke-width','5')
						.attr('stroke-opacity','0.7')
				var circletiny = Viva.Graph.svg('circle')
						.attr('cx', node.data.nodeSize)
						.attr('cy', node.data.nodeSize)
						.attr('r', 5)
						.attr('fill','red')//node.data.nodeColor)//'#4dffc3')
						.attr('stroke','red')
						.attr('opacity',0.5)
						.attr('stroke-width',0)
				var endArrow =  Viva.Graph.svg('path')
							.attr('stroke-width',0)
							.attr('d', 'M 0 -0.7 L 2 0 L 0 0.7 z')
							.attr('fill',node.data.nodeColor);
							
				var gSattelite = Viva.Graph.svg('g')
				gSattelite.append(circletiny);
				gSattelite.attr('dx',100);
				gSattelite.attr('dy',100);
				timeoutElements.push(new timeoutElement(rippleCircle, 5));
				timeoutElements.push(new timeoutElement(gSattelite, 60));
				node.data.UI.fullUI.insertBefore(rippleCircle, node.data.UI.bodyUI);
				node.data.UI.fullUI.insertBefore(gSattelite, node.data.UI.bodyUI);
				gSattelite.attr('class','rotatee');
				rippleCircle.attr('class','droplet');
		}
		
		function performAnimations()
		{	
			//Node Update-Animations...
			animUpdateNodes.forEach(function (node) {
				addSatelliteToNode(node);
			});
			animUpdateNodes = [];
			
			//Link Update-Animations...
			animUpdateLinks.forEach(function (link) {				
				var circletiny2 = Viva.Graph.svg('circle')
						.attr('cx', 1)
						.attr('cy', 1)
						.attr('r', .5)
						.attr('fill','red')//node.data.nodeColor)//'#4dffc3')
						.attr('stroke','red')
						.attr('opacity',0.5)
						.attr('stroke-width',0)
				var gSattelite2 = Viva.Graph.svg('g')
				gSattelite2.append(circletiny2);
				timeoutElements.push(new timeoutElement(gSattelite2, 60));
				link.data.UI.midMarkerUI.append(gSattelite2);
				gSattelite2.attr('class','rotatee');
			});
			animUpdateLinks = [];
			
		}
		
		function testFunction(){
			var x = function callback(){};
			Neo4jGetRelationCounts(selectedNodeID, x);
		}
		
		function animateTest(node)
		{	
			if(!node){node = selectedNode;}
			//animUpdateNodes.forEach(function (node) {
				//var node = selectedNode;
				var nodeUI = graphics.getNodeUI(node.id);
				circlex = Viva.Graph.svg('circle')
						.attr('cx', 0)
						.attr('cy', 0)
						.attr('r', node.data.nodeSize)
						.attr('fill','transparent')//node.data.nodeColor)//'#4dffc3')
						.attr('stroke','red')
						.attr('stroke-width','5')
						.attr('stroke-opacity','0.7')
				nodeUI.append(circlex);
				circlex.attr('class','droplet');
				

				
				var groupx = Viva.Graph.svg('g')
				var x1 = -13;
				var y1 = 10;
				var x2 = 37;
				var c = 48;
				var dpath1 = '';
				dpath1 += 'M '+ x1 +' '+ y1 +' C '; //x1, y1
				dpath1 += x1 +' '+ c +','; //control-x1, control-y1
				dpath1 += x2 +' '+ c +',';//control-x2, control-y2
				dpath1 += x2 +' '+y1; //x2, y2
				var dpath2 = 'M' + 0 + ',' + 0 +
                ' A 10,' + node.data.nodeSize + ',-30,0,1,' + node.data.nodeSize*2 + ',' + node.data.nodeSize*2;
				var dpath3 = "M80 80 A 45 45, 0, 0, 0, 125 125 L 125 80 Z"   
				var dpath4 = "M10 315 L 110 215 A 30 50 0 0 1 162.55 162.45 L 172.55 152.45 A 30 50 -45 0 1 215.1 109.9 L 315 10"
				//var dpath = '';
				//dpath += 'M '+0+' '+0 +' C '; //x1, y1
				//dpath += 0+' '+40+','; //control-x1, control-y1
				//dpath += 50+' '+40+',';//control-x2, control-y2
				//dpath += 50+' '+0; //x2, y2
				var pathx = Viva.Graph.svg('path')
					.attr('d',dpath1)
					//.attr('d','M'+0+' '+0+' C '+0+' '+50+', '+50+' '+0+', '+50+' '+ 50)	
					//M70 110 
					//C 70 140, 
					//110 140, 
					//110 110
					.attr('stroke', 'blue')
				//groupx.append(pathx);
				//groupx.append(circlex);
				
				
				circley = Viva.Graph.svg('circle')
						.attr('cx', 0) //node.data.nodeSize/2)
						.attr('cy', 0) //node.data.nodeSize/2)
						.attr('r', node.data.nodeSize)
						.attr('fill','blue')//node.data.nodeColor)//'#4dffc3')
						.attr('stroke','red')	
				//groupx.append(circley);
				
				circletiny = Viva.Graph.svg('circle')
						.attr('cx', 20)
						.attr('cy', 30)
						.attr('r', 5)
						.attr('fill','red')//node.data.nodeColor)//'#4dffc3')
						.attr('stroke','red')
						.attr('opacity',0.5)
						.attr('stroke-width',0)
				groupx.append(circletiny);
				groupx.attr('dx',100);
				groupx.attr('dy',100);
				nodeUI.append(groupx);
				groupx.attr('class','rotatee');

		}
		

		function panelAddKeyValue(panelId, panelScope){
			var panel = document.getElementById(panelId);
			var nextIndex = panel.children.length;
			panel.innerHTML += "<td><input id='"+panelScope+".property.key."+nextIndex+"' class='dynamic' value=''></input></td><td><input id='"+panelScope+".property.value."+nextIndex+"' class='dynamic2' value=''></input></td><td></td>";
		}
		function panelRemoveKeyValue(panelId){
			var panel = document.getElementById(panelId);
			if (panel.children.length == 0) {return;}
			panel.children[0].remove();
		}
		
		function removeLastElement()
		{
			var ui = selectedNodeUI.children[selectedNodeUI.children.length-1];
			selectedNode.data.UI.focusUI.remove();
		}

		function createJsonFromSelectedNodes()
		{
			//get the rootmost objects amongst the check nodes...
			var rootMostNodes = [];
			var processedNodes = [];
			checkedNodes.forEach(function(node) { //iterate through checked nodes...
				if (processedNodes.map(function(n) {return n.id}).indexOf(node.id) == -1){ //...node has not been processed yet
					processedNodes.push(node); //...add node to processed list
					var isRootNode = true;
					node.data.fromNodes.forEach(function (fromnode){ //...iterate through current node's fromNodes
						if (checkedNodes.map(function(n) {return n.id}).indexOf(node.id) > -1) //...current fromNode is in the checkedNodes list, therefore its not a rootmost node
						{	
							isRootNode = false;
							return;
						}
					})
					if (isRootNode) {rootMostNodes.push(node);}
				}
			});
			if (rootMostNodes.length == 0 && checkedNodes.length != 0) {rootMostNodes.push(checkedNodes[0]);}  //resolve a cyclic scenario by just picking the first checked node.

			var rootObject = {};
			processedNodes  = [];
			var labels = [];
			rootMostNodes.map(function(n, index) {if (labels.indexOf(n.data.labels[0]) == -1){labels.push(n.data.labels[0]);} });
			
			labels.forEach(function(label){
				var useArray = false;
				var count = 0;
				rootMostNodes.map(function(n){if(n.data.labels[0]==label){count++;}});
				if (count > 1) {useArray = true;}
				if (useArray) {rootObject[label] = [];}
				rootMostNodes.forEach(function (node) {
					if (node.data.labels[0] == label){
						if (useArray) 
							rootObject[label].push(createJsonFromNode(node, {}, processedNodes));
						else
							rootObject[label] = createJsonFromNode(node, {}, processedNodes);
					}
				})
			});			
			var jsonstring = JSON.stringify(rootObject);
			var dialog = document.getElementById('myDialog');
			var dialogText = document.getElementById('myDialogText');
			dialogText.innerHTML = jsonstring
			dialog.showModal();
		}

		function createJsonFromNode(node, parentObject, processedNodes, parentNode)
		{
		
			var entityName = node.data.labels[0]; 
			var thisObject = {};
			parentObject[entityName] = thisObject;
			thisObject['$type'] = entityName;
			processedNodes.push(node);
			var relationships = [];
			if (parentNode){	
				node.data.fromLinks.forEach(function(link){
					if (link.fromId == parentNode.id)
					{
						relationship = {};
						relationship['$name'] = link.data.name;
						link.data.properties.forEach(function(prop){
							relationship[prop.key] = prop.value;
						} );
						relationships.push(relationship);
					}
				})
			}
			if (relationships.length >0){
				thisObject['$rel'] = relationships
			}
			
			node.data.properties.forEach(function(prop){
				thisObject[prop.key] = prop.value;
			});

			//process child nodes...
			var labels = [];
			node.data.toNodes.map(function(n, index) {if (labels.indexOf(n.data.labels[0]) == -1){labels.push(n.data.labels[0]);} });
			
			labels.forEach(function(label){
				
				var useArray = false;
				var count = 0;
				node.data.toNodes.map(function(n){if(n.data.labels[0]==label){count++;}});
				if (count > 1) {useArray = true;}
				if (useArray) {thisObject[label] = [];}
				
				node.data.toNodes.forEach(function (childNode){
					if(childNode.data.labels[0] == label && count > 0)
					{
						if (processedNodes.indexOf(childNode.id) == -1)
						{
							if (checkedNodes.map(function(n){return n.id}).indexOf(childNode.id) > -1)
							{
								if (useArray) 
									thisObject[label].push(createJsonFromNode(childNode, {}, processedNodes, node));
								else 
									thisObject[label] = createJsonFromNode(childNode, {}, processedNodes, node);
							}
						}
					}
				})
			})
			return thisObject;
		}
		
		function getType(p) {
			if (Array.isArray(p)) return 'array';
			else if (typeof p == 'string') return 'string';
			else if (p != null && typeof p == 'object') return 'object';
			else return 'other';
		}

		function jsonStringToObject(jsonString)
		{
			return JSON.parse(jsonString);
		}
		
		function submitJsonForGraph()
		{
			var jsonString = document.getElementById('dlg.text.json').value;
			jsonToGraph(jsonString);
			closeDialog('json2GraphDlg');
		}
		
		function jsonToGraph(jsonString, _sourceConfig){
			
			var graphData = processJsonToGraph('root', jsonStringToObject(jsonString), null, 0);
			//ADD NODES...
			graphData.nodes.map(function(nData){
				//match node to existing nodes

				if (nData.temp.matchedNodes > 0){//...update existing node
					//there is no parent, but there are existing matching nodes, therefore make all the matching nodes our root nodes. (we will update all their paths)
					nData.temp.matchedNodes.forEach(function (existingNode){
						//update existing node
						existingNode.data.properties = mergeProperties(existingNode.data.properties, existingNode.data.temp.properties)
						addDataNode(existingNode.id, existingNode.data, _sourceConfig);
					});
				}
				else { //create new node...
					nData.properties = nData.temp.properties;
					addDataNode(nData.id, nData, _sourceConfig)
				}
			});
			
			//ADD LINKS...
			graphData.links.map(function(lData){
				addDataLink(lData.fromNodeID, lData.toNodeID, lData, _sourceConfig)
			});
		}
		
		function processJsonToGraph(name, obj, parentNodeData, level)
		{
			var stillRoot = parentNodeData ? false : true;
			if (!stillRoot){if (!parentNodeData.temp.parentNodeData) {stillRoot = true;}}
			var fromNodeId = parentNodeData ? parentNodeData.id : 'root';
			level++;
			var type = getType(obj);
			var graphData = {nodes:[], links:[]};
			var relationsAdded = false;
			//create a node (will only be applied if this is actually an object (not a primitive or array))
			var nodeData = new datax();
			nodeData.labels = [name];
			nodeData.id = 'newnode_'+ (++processUniqueId);
			nodeData.temp = {};
			nodeData.temp.stillRoot = stillRoot;
			nodeData.temp.matchedNodes = []; //if '$matchon' is specified then this list will be existing matching nodes
			nodeData.temp.parentNodeData = parentNodeData;
			nodeData.temp.properties = [];
			
			nodesListData = [];
			
			//Process object...
			if (type == 'object'){
				//Find existing nodes by matching label
				
				var nodeDataProperties = [];
				//Filter matching nodes by key properties...
				for (var propName in obj){	
					if (propName == '$matchon'){//...meta data (matchon)...
						//...$matchon should be an array of strings, who's values specify which fields in the current entity, to match on.
						var matchPropertyList = []
						var onPath = false;
						obj['$matchon'].forEach(function (matchPropName){
							if (matchPropName == '$onpath'){
								onPath = true;
							}else{
								matchPropertyList.push(new property(matchPropName, obj[matchPropName]));
							}
						});
						
						var eligibleNodesList = nodeList; //...Search all nodes by default
						if (onPath==true){
							//Only search nodes on the existing path (child nodes of the parent node)...
							eligibleNodesList = getNodesByMatchingLabels((stillRoot)? nodeList : parentNodeData.toNodes , nodeData.labels);
						}
						
						nodeData.temp.matchedNodes = getNodesByMatchingProperties(eligibleNodesList, matchPropertyList);				
						nodeData.temp.matchedNodes.map(function(mn){
							mn.data.temp = {}
							mn.data.temp.matchedNodes = [mn];
							mn.data.temp.properties = [];
							mn.data.temp.parentNodeData = parentNodeData;
							nodesListData.push(mn.data);
						});
					}
					
					else if (propName == '$rel'){//...meta data (relationship)...
						obj[propName].forEach(function (relation){ //...iterate throguh relationships
							var newLinkData = new datay(fromNodeId, newNode.id, ++processUniqueId, relation['$name']);
							newLinkData.properties = [];
							//iterate through relationship properties...
							for (var relPropName in relation){//.forEach(function(prop){
								newLinkData.properties.push(new property(relPropName, relation[relPropName]));
							}
							graphData.links.push(newLinkData); //...add specified link
							relationsAdded = true;
						})
					}
					
					else { //...Since this property is not a meta property, add it to the data proerties list...
						nodeDataProperties.push(propName);
					}
				}
				
				if (nodesListData.length == 0){ //...no existing nodes exist matching this node
					//Create a new node...
					nodesListData = [nodeData]; //...add new node
					//nodeData.temp.matchedNodes = [nodeData]
				}
				
				//get all the properties for the object
				nodesListData.forEach(function (newNode){ 
					
					//for (var propName in obj){
					nodeDataProperties.forEach(function(nodePropName){
						//process non-meta property
						//else { //...property is not meta data... (could be anything)
						var subGraphData = processJsonToGraph(nodePropName, obj[nodePropName], newNode, level)
						if (subGraphData){
							subGraphData.nodes.map(function (n){graphData.nodes.push(n);});
							subGraphData.links.map(function (l){graphData.links.push(l);});
						}
					});

					//ADD THIS NODE...
					if (parentNodeData) { //node has a parent, which means its not a root object (because a valid object will at least have the root node as a parent)
						graphData.nodes.push(newNode);
					}
					
					//ADD A RELATIONSHIP (if not already added, and not a root connection)...
					if (!relationsAdded){ //...no relationships were explicitly mentioned

						if (parentNodeData && parentNodeData.temp.parentNodeData) //...there is actually a parent, and a grandparent, to create a link to
						{

							//link this node to the parent node (will only be applied if this is actually an object (not a primitive or array))
							var defaultLink = new datay(fromNodeId, newNode.id, 'newlink_'+ (++processUniqueId), 'DEFAULT')						
							graphData.links.push(defaultLink);
						}
					}
				})//...next new/existing node
				
				return graphData;
			}
			//Process array...
			else if (type == 'array'){
				//iterate through elements...
				obj.forEach(function(element){
					var subGraphData;
					subGraphData = processJsonToGraph(nodeData.labels[0],element, parentNodeData, level)
					if (subGraphData){
						subGraphData.nodes.map(function (n){graphData.nodes.push(n);});
						subGraphData.links.map(function (l){graphData.links.push(l);});
					}
				})
				return graphData;
			}
			//Process primitive...
			else{ //...property is a primitive
				if(parentNodeData){
					var subGraphData = parentNodeData.temp.properties.push(new property(name, obj));
					return graphData; //return nothing since its only a property
				}
			}

		}
		
		function closeDialog(dialogName)
		{
			document.getElementById(dialogName).close();
		}
		
		function neoPropertyList(obj)
		{
			var propArray = [];
			for (var thiskey in obj) {
				propArray.push(new property(thiskey, obj[thiskey]));
			}
			return propArray;
		}
		function propertyListToSvgList(propertyList, prefix, suffix)
		{
			var proplist = ''; 
			propertyList.forEach(function(prop){
				proplist += prefix + prop.key + ": " + prop.value + suffix;
			})
			return proplist;
		}
		

		
		function getNeoLabel(byName, sourcePrefix)
		{
			var x;
				labelsList.forEach(function(labelobj, index){
				if (labelobj.name == byName &&  labelobj.sourceConfig.prefix == sourcePrefix){
					x = labelobj;
					return labelobj;
				}
			});
			return x;
		}
		function getDataLink(id)
		{
			for (var i = 0; i < linkList.length; i++){
				if (linkList[i].data.id == id){
					return linkList[i];
				}
			}
		}
		function getDataLinks(fromNodeID, toNodeID, direction)
		{
		
			var x = [];
			linkList.forEach(function(link, index){
				switch (direction){
					case 'same':
						if (link.fromId == Number(fromNodeID) && link.toId == Number(toNodeID)){
							x.push(link);
						}
						break;
					case 'opposite':
						if (link.toId == Number(fromNodeID) && link.fromId == Number(toNodeID)){
							x.push(link);
						}
						break;
					default:
						if ((link.fromId == Number(fromNodeID) && link.toId == Number(toNodeID)) ||
							(link.toId == Number(fromNodeID) && link.fromId == Number(toNodeID))){
							x.push(link);
						}
						break;
					}
			});
			return x;
		}
		
		function mergeProperties(basePropertyList, newPropertyList){
			var updatedList = [];
			var addedList = [];
			
			newPropertyList.forEach(function (newprop){
				var newPropExists = false;
				basePropertyList.forEach(function (baseprop){
					if (baseprop.key == newprop.key){
						newPropExists = true;
						if (baseprop.value != newprop.value){
							baseprop.value = newprop.value;
							updatedList.push(baseprop);
						}
					}
				});
				if (!newPropExists){
					basePropertyList.push(newprop)
					addedList.push(newprop);
					baseprop.push(newprop)
				}
			})
			return basePropertyList;
		}
		
		function getNodesByMatchingLabels(nodesList, labels){
			var returnNodeList = [];		
			//iterate through 
			nodesList.forEach(function(node){
				var nodeEligible = true;
				labels.forEach(function (label){
					var labelFound = false;
					node.data.labels.forEach(function(nodelabel){
						if (nodelabel == label)
							labelFound = true;
					});
					if (!labelFound){nodeEligible = false}
				});
				if (nodeEligible){returnNodeList.push(node);}
			});
			return returnNodeList;
		}
		
		function getNodesByMatchingProperties(nodesList, properties){
			var returnNodeList = [];		
			//iterate through 
			nodesList.forEach(function(node){
				var nodeEligible = true;
				properties.forEach(function (prop){
					var propFound = false;
					node.data.properties.forEach(function(nodeprop){
						if (prop.key == nodeprop.key && prop.value == nodeprop.value){
							propFound = true;	
						}
					});
					if (!propFound){nodeEligible = false;}
				});
				if(nodeEligible){returnNodeList.push(node);}
			});
			return returnNodeList;
		}
		
		function getNodePropertyValue(propertyList, propertyName)
		{
			var x;
			if (!propertyList) return;
			propertyList.forEach(function (prop, index){
				if (prop.key == propertyName)
				{
					x = prop.value;
					return x;
				}
			}); 
			return x;
		}
		
		function getDataNode(nodeID)
		{
			for (var i = 0; i < nodeList.length; i++){
				if (nodeList[i].id == nodeID){
					return nodeList[i];
				}
			}
		}
		
		function neo_APIcall()
		{
			this.statements = [];
			return this;
		}
		
		function neo_Statement(statement)
		{
			this.statement = statement;
			return this;
		}
//CUSTOM GRAPH FUNCTIONS	
		function removeNodeFromStage(nodeID)
		{
			if (!nodeID) {nodeID = selectedNodeID;}
			var node = GRAPH.getNode(nodeID);
			
			var allNodeLists = nodeList.concat(node.data.toNodes.concat(node.data.fromNodes));
			var i = -1;
			while (i++ < nodeList.length){if (nodeList[i].id == nodeID) {nodeList.splice(i, 1);}}
			while (i++ < monitoredNodes.length){if (monitoredNodes[i].id == nodeID) {monitoredNodes.splice(i, 1);}}
			while (i++ < checkedNodes.length){if (checkedNodes[i].id == nodeID) {checkedNodes.splice(i, 1);}}
			nodeList.forEach(function(node) {
				while (i++ < node.data.toNodes.length){if (node.data.toNodes[i].id == nodeID) {node.data.toNodes.splice(i, 1);}}
				while (i++ < node.data.fromNodes.length){if (node.data.fromNodes[i].id == nodeID) {node.data.fromNodes.splice(i, 1);}}
				while (i++ < node.data.fromNodes.length){if (node.data.fromNodes[i].id == nodeID) {node.data.fromNodes.splice(i, 1);}}
				while (i++ < node.data.toLinks.length){if (node.data.toLinks[i].toNodeID == nodeID) {node.data.toLinks.splice(i, 1);}}
				while (i++ < node.data.fromLinks.length){if (node.data.fromLinks[i].fromNodeID == nodeID) {node.data.fromLinks.splice(i, 1);}}
			});
			
			var relativeLinks = node.data.toLinks.concat(node.data.fromLinks);
			relativeLinks.forEach(function (link){
				GRAPH.removeLink(link.id);
			});
			GRAPH.removeNode(nodeID);
		}
		
		function addDataLabel(labelName, _addInstanceCount, _sourceConfig)
		{	
			var existingLabelSelector = getNeoLabel(labelName, _sourceConfig.prefix);
			if(existingLabelSelector) 
			{
				if(_addInstanceCount){existingLabelSelector.instanceCount += _addInstanceCount};
				var fetchbutton = document.getElementById('labelSelector.fetcher.' + labelName)
				if (fetchbutton) {fetchbutton.innerHTML = existingLabelSelector.instanceCount;}
				return;
			}

			var rgb = {r: Math.ceil(getRandomArbitrary(_sourceConfig.displaySettings.entityRgbRange.min, _sourceConfig.displaySettings.entityRgbRange.max)),
								   g: Math.ceil(getRandomArbitrary(_sourceConfig.displaySettings.entityRgbRange.min, _sourceConfig.displaySettings.entityRgbRange.max)),
								   b: Math.ceil(getRandomArbitrary(_sourceConfig.displaySettings.entityRgbRange.min, _sourceConfig.displaySettings.entityRgbRange.max))
						}
			var randomColor = rgb2hex(rgb.r, rgb.g, rgb.b);
			var newDataLabel = new neoLabel(labelName, randomColor, rgb, _sourceConfig);
			if (_addInstanceCount) {newDataLabel.instanceCount += _addInstanceCount;}
			//Add new data label to labels-list
			labelsList.push(newDataLabel);
						
			return newDataLabel;
		}
		
		function refreshLabelSelectors(){
			//Order label selectors...
			labelsList.sort(sort_by('name', false, function(a){ if (a) {return a.toUpperCase()} }));
			//Add selector to HTML...
			var qbuilderFromEntitySelector = document.getElementById('qbuilder.from.entity');
			//var qbuilderToEntitySelector = document.getElementById('qbuilder.to.entity');
			var LabelsDiv = document.getElementById('selectorLabels');
			
			var color = 'gray';
			var button_onclick = "Neo4jGetNodesByLabel(false, '"+ currentTheme.sourceConfig.prefix +"')";
			var fetchButton = '<button id="labelSelector.fetcher.All" class="forlabelselector tooltip" onclick="'+button_onclick+'"> <div class="tooltiptext">Fetch from database</div></button>'
			
			if (LabelsDiv) {LabelsDiv.innerHTML = '<tr><td><div onclick="highlightLabel()" id="labelSelectorPanel" style="background-color:'+ color +';">All</div></td><td>' + fetchButton + '</tr><td></tr>';}
			if (qbuilderFromEntitySelector) {qbuilderFromEntitySelector.innerHTML = '<option value=""></option>';}
			
			labelsList.forEach(function(label,index){
				color = label.sourceConfig.displaySettings.selectorColor;
				
				button_onclick = "Neo4jGetNodesByLabel('"+label.name+"', '"+ label.sourceConfig.prefix +"')";
				fetchButton = '<button id="labelSelector.fetcher.'+label.name+'" class="forlabelselector tooltip" style="background-color:'+label.color+'" onclick="'+button_onclick+'">'+label.instanceCount+'<div class="tooltiptext">Fetch from database</div></button>'
				if (LabelsDiv) {LabelsDiv.innerHTML+= '<tr><td><div onclick="highlightLabel('+index+')" id="labelSelectorPanel" style="background-color:'+color+';">' + label.name +'</div></td><td>'+fetchButton+'</td></tr>';}
				if (qbuilderFromEntitySelector) {qbuilderFromEntitySelector.innerHTML += '<option value="' + label.name + label.sourceConfig.prefix + '">' +( label.name + " (" +label.sourceConfig.prefix+ ")") + '</option>';}
			});
		}
		
		function addDataNode(nodeId, nodeData, _sourceConfig)
		{
			nodeData.sourceConfig = _sourceConfig ? _sourceConfig : currentTheme.sourceConfig ;
			var dataNode = getDataNode(nodeId);
			var nodeUI;
			var isNewNode = false;
			if (dataNode){
				var newLabels = [];
				nodeUI = graphics.getNodeUI(nodeId);
				nodeData.labels.forEach(function (newLabel) {
					var hasLabel = false;
					for (var i = 0; i < nodeData.labels.length; i++){
					//nodeData.labels.forEach(function (existingLabel) { 	
						if (nodeData.labels[i] == newLabel){
							hasLabel = true;
							break;
						}
					};
					if (!hasLabel) {newLabels.push(newLabel)}
				});

				var updatedProperties = getUpdatedProperties(dataNode.data.properties, nodeData.properties);
				if (newLabels.length > 0 || updatedProperties.length > 0){
					if (nodeData.UI.displayTextUI) {
						nodeData.UI.displayTextUI.innerHTML = propertyListToSvgList(nodeData.properties, '<tspan x="50" dy="1.2em">', '</tspan>');
					}
					dataNode.data.labels = nodeData.labels;
					dataNode.data.properties = nodeData.properties;
					//$(nodeUI).hide.show(0);
					animUpdateNodes.push(dataNode);
				}
				else{//no changes have been made to the node...
					return; //NOTE: DO NOT RETURN THE DATA-NODE
				}
				//return;

			}
			else 
			{
				isNewNode = true;
				nodeUI = graphics.getNodeUI(nodeId);
			}
			
			//find config for node if any is specified...
			_sourceConfig.startupOptions.nodeDisplayBody.map(function (nconfig) {if (nconfig.label == nodeData.labels[0]) {nodeData.config.nodeDisplayBody = nconfig;}});
			_sourceConfig.startupOptions.nodeDisplayValues.map(function (nconfig) {if (nconfig.label == nodeData.labels[0]) {nodeData.config.nodeDisplayValues = nconfig;}});
			//set display label...
			nodeData.displayLabel = "";
			nodeData.labels.forEach(function(label, index){
				addDataLabel(label, undefined, nodeData.sourceConfig);
				refreshLabelSelectors();
				if (nodeData.displayLabel) {nodeData.displayLabel += ','}
				if(!nodeData.displayLabel) {nodeData.displayLabel = '';}
				if (nodeData.config.nodeDisplayValues.displayField){
					if (nodeData.displayLabel!=""){nodeData.displayLabel + '\n';}
					var propertyValue = getNodePropertyValue(nodeData.properties, nodeData.config.nodeDisplayValues.displayField);
					nodeData.displayLabel += propertyValue ? propertyValue : ' ';
				}
				if(nodeData.config.nodeDisplayValues.displayValue){
					if (nodeData.displayLabel!=""){nodeData.displayLabel + '\n';}
					nodeData.displayLabel += nodeData.config.nodeDisplayValues.displayValue;
				}
				if(nodeData.displayLabel=="") {
					nodeData.displayLabel = label;
				}
			});
			//nodeData.displayLabel;
			var aNeoLabel = getNeoLabel(nodeData.labels[0], _sourceConfig.prefix);
			if (aNeoLabel) {
				nodeData.nodeColor = aNeoLabel.color; 
				nodeData.nodeColorRGB = aNeoLabel.colorRGB;
				nodeData.nodeBorderColor = rgb2hex(nodeData.nodeColorRGB.r-20, nodeData.nodeColorRGB.g-20, nodeData.nodeColorRGB.b-20);
			}
			
			if (isNewNode){
				dataNode = addNodeToGraph(nodeId,nodeData);	
				nodeList.push(dataNode);
				if (_sourceConfig.viewOptions.prefetchCounts==true){
					var updateIndicatorNode = function (toCount, fromCount){
						dataNode.data.totalToLinks = toCount;
						dataNode.data.totalFromLinks = fromCount;
					}
					Neo4jGetRelationCounts(dataNode.id, updateIndicatorNode);
				};
				return dataNode; //RETURN ONLY IF NODE IS NEW
			}
		}
		
		function removeSubNode(subNode, updateSuperNode = false)
		{
			if (updateSuperNode == true){
				subNode.superNodes.forEach(function(superNode,index){
					if (superNode){
						superNode.subNodes.map(function(sn, i){
							if (sn.id == subNode.id) {
								superNode.subNodes.splice(i,1);
							}
						})
					}
				})
			}
			
			subNode.data.fromLinks.forEach(function(link){GRAPH.removeLink(link.id)});
			subNode.data.toLinks.forEach(function(link){GRAPH.removeLink(link.id)});
			GRAPH.removeNode(subNode.id);			
		}
		
		function addSubNode(parentNode, id, color, displayLabel)
		{			

			var subNodeData = new datax();
			subNodeData.nodeSize = 5;
			subNodeData.nodeType = 'subnode';
			subNodeData.id = id; //'sub' + parentNode.id;
			subNodeData.labels = ['subnode'];
			subNodeData.nodeColor = color;
			
			
			subNodeData.displayLabel = displayLabel;
			subNodeData.superNodes.push(parentNode);
			//CREATE NODE
			var subNode = addNodeToGraph(subNodeData.id,subNodeData);	
			parentNode.data.subNodes.push(subNode)
			
			//popout effect
			layout.pinNode(subNode, true);
			var pos = layout.getNodePosition(parentNode.id);
			binaryToggle = !binaryToggle;
			//layout.setNodePosition(subNode.id, pos.x + 10 * (binaryToggle)?-1:1, pos.y + 10* (binaryToggle)?-1:1);
			layout.setNodePosition(subNode.id, pos.x + 10 * ((binaryToggle)?-1:1), pos.y + 10* ((binaryToggle)?-1:1));
			layout.pinNode(subNode, false);

			
			
			var linkData = new datay(parent.id, subNodeData.id, parent.id +' ' + subNodeData.id);
			linkData.linkType = 'sub';
			linkData.color = color;
			//linkData.fromNodeID = parent.id;
			//linkData.toNodeID = subNodeData.id;
			var toRelLink = GRAPH.addLink(parentNode.id, subNodeData.id, linkData);
			subNode.data.fromLinks.push(toRelLink);
			
			var nodespring = layout.getSpring(parentNode.id, subNodeData.id);
			nodespring.length = 30;
		}
		
		function Neo4jExtractProperties(nodesResult) //extract properties from a collection of nodes, from a cypher node search
		{
			var propertyList = [];
			for (var i = 0; i < nodesResult.results.length; i++){		
				var result = nodesResult.results[i];
				for (var d = 0; d < result.data.length; d++){
					var row = result.data[d].row;
					propertyList = propertyList.concat(new neoPropertyList(row[0]));
				}
			}
			
			return propertyList;
		}
		function Neo4jExtractValues(nodesResult) //extract properties from a collection of nodes, from a cypher node search
		{
			var valueList = [];
			for (var i = 0; i < nodesResult.results.length; i++){		
				var result = nodesResult.results[i];
				for (var d = 0; d < result.data.length; d++){
					var row = result.data[d].row;
					valueList.push(row[0]);
				}
			}
			return valueList;
		}
		
		function Neo4jQbuilder_ClearValue(selectType)
		{
			var scope = selectType.split('.');
			document.getElementById('qbuilder.' + scope[1] + '.value').value = '';
			//document.getElementById('qbuilder.'+scope[1]+'.selectvalue').innerHTML = '<option value=""></option>';
		}
		
		function Neo4jQbuilder(selectType, _sourceConfig)
		{
			var scope = selectType.split('.'); //...scope[0] = "qbuilder", scope[1] = "from"/"to", scope[2] = "entity"/"property"/"value"
			var selectedEntityValue = document.getElementById('qbuilder.' + scope[1] + '.entity').value;
			var sourcePrefix = selectedEntityValue.substring(selectedEntityValue.length-3);
			var entityName = ':' + selectedEntityValue.substring(0, selectedEntityValue.length-3);
			//if (entityName && entityName != ''){entityName = ':' +entityName;} 
			
			if (scope[2] == 'entity'){
				//get properties...
				document.getElementById('qbuilder.' + scope[1] + '.value').value = '';
				var childElementName = 'qbuilder.'+scope[1]+'.property';
				var propertyElement = document.getElementById(childElementName);
				propertyElement.innerHTML = '<option value=""></option>';
				//document.getElementById('qbuilder.'+scope[1]+'.value').innerHTML = '';
				document.getElementById('qbuilder.'+scope[1]+'.selectvalue').innerHTML = '<option value=""></option>';
				
				//var selectedEntityValue = document.getElementById(selectType).value;
				//var sourcePrefix = selectedEntityValue.substring(selectedEntityValue.length-3);
				//var entityName = selectedEntityValue.substring(0, selectedEntityValue.length-3);
			
				
				var command = "MATCH (n"+ entityName + ") return n";
				var listedProperties = [];
				var callback = function(nodesResult, sourceConfig){
					var propertyList = Neo4jExtractProperties(nodesResult)
					propertyList.sort(sort_by('key', false, function(a){return a.toUpperCase()})).forEach(function(prop){
						if (listedProperties.indexOf(prop.key) == -1) {
							listedProperties.push(prop.key);
							propertyElement.innerHTML += '<option value="'+prop.key+'">' + prop.key + '</option>';
						}
					});
				};
				Neo4j_Command([command], callback, getConfigByPrefix(sourcePrefix));
			}
			if (scope[2] == 'property'){
				var valueElementName = 'qbuilder.' + scope[1] + '.selectvalue';
				document.getElementById('qbuilder.' + scope[1] + '.value').value = '';
				//var selectedEntity = document.getElementById('qbuilder.'+scope[1]+'.entity').value;
				var selectedProperty = document.getElementById('qbuilder.'+scope[1]+'.property').value;
				//valueElementName.innerHTML = '<option value=""></option>';
				var listedValues = [];
				if (!selectedProperty){ return;}
				var command = "MATCH (n"+entityName+") return distinct n." + selectedProperty;
				var callback = function(nodesResult, sourceConfig){
					var valueList = Neo4jExtractValues(nodesResult)
					var valueElement = document.getElementById(valueElementName);
					valueElement.innerHTML = '<option value=""></option>';	
					valueList.sort().forEach(function(prop){
						if (listedValues.indexOf(prop) == -1){ 
							listedValues.push(prop)
							valueElement.innerHTML += '<option value="'+prop+'">' + prop + '</option>';
						}
					});
				};
				Neo4j_Command([command], callback, getConfigByPrefix(sourcePrefix));
			}
		}
		
		function ButtonSimpleSearch()
		{
			//var fromEntity = document.getElementById('qbuilder.from.entity').value;
			var selectedEntityValue = document.getElementById('qbuilder.from.entity').value;
			var sourcePrefix = selectedEntityValue.substring(selectedEntityValue.length-3);
			var entityName = selectedEntityValue.substring(0, selectedEntityValue.length-3);
			
			var fromProperty = document.getElementById('qbuilder.from.property').value;
			var fromValue = document.getElementById('qbuilder.from.value').value;
			Neo4jQuerySimpleSearch(entityName, fromProperty, fromValue, getConfigByPrefix(sourcePrefix));
		}
		
		function Neo4jQuerySimpleSearch(fromEntity, whereProperty, equalsValue, _sourceConfig)
		{
			var propertyBlock = (whereProperty)?'{'+whereProperty+':'+parseDataType(equalsValue)+'}':'';
			
			if (fromEntity && fromEntity != ''){fromEntity = ':' + fromEntity;}
			var command = 'MATCH (n'+fromEntity + propertyBlock + ') RETURN id(n), labels(n), n';
			var callback = function(nodesResult, sourceConfig){
				addSingleNodesFromResults(nodesResult, sourceConfig)
				
				//Recurse...
				var command = 'MATCH (n'+fromEntity + propertyBlock+')-[r]-(m) RETURN id(startnode(r)), labels(startnode(r)), startnode(r) , id(r), type(r), r, id(endnode(r)), labels(endnode(r)), endnode(r)';
				var callback2 = function(nodesResult, sourceConfig){addNodesFromResults(nodesResult, sourceConfig)};
				Neo4j_Command([command], callback2, sourceConfig);
			};
			Neo4j_Command([command], callback, _sourceConfig);
		}
		
		/*function Neo4jQueryRecursiveSearch(_sourceConfig)
		{
			var fromEntity = document.getElementById('qbuilder.from.entity').value;
			var fromProperty = document.getElementById('qbuilder.from.property').value;
			var fromValue = document.getElementById('qbuilder.from.value').value;
			var propertyBlock = (fromProperty)?'{'+fromProperty+':'+parseDataType(fromValue)+'}':'';
			
			var processedNodes = [];
			var command = 'MATCH (n:'+fromEntity + propertyBlock+')-[r]-(m) RETURN id(startnode(r)), labels(startnode(r)), startnode(r) , id(r), type(r), r, id(endnode(r)), labels(endnode(r)), endnode(r)';
			
			var callback = function(nodesResult, sourceConfig){
				var nodeList = addNodesFromResults(nodesResult, sourceConfig);
				nodeList.forEach(function (nodex){				
					if (processedNodes.indexOf(nodex.id) == -1) { //...node has already been processed.
						command = 'MATCH (n)-[r]-(m) WHERE ID(n) = '+ getNeoId(nodex.id) +' RETURN id(startnode(r)), labels(startnode(r)), startnode(r) , id(r), type(r), r, id(endnode(r)), labels(endnode(r)), endnode(r)';
						Neo4j_Command([command], callback, sourceConfig);
						processedNodes.push(nodex.id);
					}
					else
					{
						//old
					}
				});
			};
			Neo4j_Command([command], callback, _sourceConfig);
		}
		*/
		
		function addValueToList(listElementId, col1, col2, col3)
		{
			var propertyElement = document.getElementById(listElementId);
			//check if element already exists in list...
			for (var i = 0; i < propertyElement.children.length; i++ ){
				if (propertyElement.children[i].children[0].children[2].innerHTML == col3){
					return;
				}
			}
			//element does not already exist in list, therefore add it...
			var html = '<tr>'
			html += '<td>'+col1+'</td>'	
			html += '<td>'+col2+'</td>'	
			html += '<td>'+col3+'</td>'	
			html += '</tr>';
			propertyElement.innerHTML +=html;

		}		
		
		function Neo4jCreateEntity()
		{
			var _sourceConfig = currentTheme.sourceConfig;
			var entityName = document.getElementById('new.entity.name').value;
			if (!entityName || entityName == ''){alert('Save failed!\nNo entity name specified.'); return;}
			var propIndex = 0;
			var propertyElement = document.getElementById('new.entity.property.key.' + propIndex);
			var propList = '';
			
			while (propertyElement)
			{
				var propertyValueElement = document.getElementById('new.entity.property.value.' + propIndex);
				if (!propertyValueElement || propertyValueElement.value == '') {alert('Save failed!\nInvalid property name.'); return;}
				if (propList != '') {propList += ','}
				propList += propertyElement.value + ':' + parseDataType(propertyValueElement.value);
				propIndex++;
				propertyElement = document.getElementById('new.entity.property.key.' + propIndex);	
			}
			if (propList != '') {propList = '{' + propList + '}';}

			var callback = function(nodesResult, sourceConfig){
				addSingleNodesFromResults(nodesResult, sourceConfig);
			};
			var command = 'CREATE (n:' + entityName + propList + ') return id(n), labels(n), n'
			Neo4j_Command([command], callback, _sourceConfig);
		}
		
		
		function Neo4jUpdateEntity(nodeID)
		{
			if (!nodeID){nodeID = selectedNodeID;}
			var node = GRAPH.getNode(nodeID);
			var _sourceConfig = node.sourceConfig;
			var entityName = document.getElementById('new.entity.name').value;
			if (!entityName || entityName == ''){alert('Save failed!\nNo entity name specified.'); return;}
			var propIndex = 0;
			var propertyElement = document.getElementById('new.entity.property.key.' + propIndex);
			var propList = '';
			
			while (propertyElement)
			{
				var propertyValueElement = document.getElementById('new.entity.property.value.' + propIndex);
				if (!propertyValueElement || propertyValueElement.value == '') {alert('Save failed!\nInvalid property name.'); return;}
				if (propList != '') {propList += ','}
				propList += ' n.' + propertyElement.value + '=' + parseDataType(propertyValueElement.value);
				propIndex++;
				propertyElement = document.getElementById('new.entity.property.key.' + propIndex);	
			}
			if (propList != '') {propList = ' SET ' + propList + '';}

			var callback = function(nodesResult, sourceConfig){
				addSingleNodesFromResults(nodesResult, sourceConfig)
			};
			var command = 'MATCH (n) WHERE ID(n)=' + getNeoId(nodeID) + propList + ' return id(n), labels(n), n'
			Neo4j_Command([command], callback, _sourceConfig);
		}
		
		function Neo4jCreateRelation(nodeID1, nodeID2, planOnly, _sourceConfig)
		{
			var node1 = GRAPH.getNode(nodeID1);
			var node2 = GRAPH.getNode(nodeID2);
			if (node1.sourceConfig.prefix != node2.sourceConfig.prefix){
				alert('Save failed!\nYou cannot relate nodes from different sources.'); return;
			} 
			var relationName = document.getElementById('new.relation.name').value;
			if (!relationName || relationName == ''){alert('Save failed!\nNo relation name specified.'); return;}
			var propIndex = 0;
			var propertyElement = document.getElementById('new.relation.property.key.' + propIndex);
			var propList = '';

			while (propertyElement)
			{
				var propertyValueElement = document.getElementById('new.relation.property.value.' + propIndex);
				if (!propertyValueElement || propertyValueElement.value == '') {alert('Save failed!\nInvalid property name.'); return;}
				if (propList != '') {propList += ','}
				propList += propertyElement.value + ':' + parseDataType(propertyValueElement.value);
				propIndex++;
				propertyElement = document.getElementById('new.relation.property.key.' + propIndex);	
			}
			if (propList != '') {propList = '{' + propList + '}';}

			if (!planOnly){
				var callback = function(nodesResult, sourceConfig){
					Neo4jFetchRelation(nodeID1, nodeID2, sourceConfig);
				}
				var command = 'MATCH (n) WHERE ID(n) = ' + getNeoId(nodeID1) + ' MATCH (m) WHERE ID(m) = '+ getNeoId(nodeID2) + ' CREATE (n)-[r:'+ relationName + propList +']->(m) RETURN id(startnode(r)), labels(startnode(r)), startnode(r) , id(r), type(r), r, id(endnode(r)), labels(endnode(r)), endnode(r)'
				Neo4j_Command([command], callback, _sourceConfig);
			}
			else{
				addPlannedLink(nodeID1, nodeID2, relationName, propList)
			}
		}
		
		
		
		function addNodesFromResults(nodesResults, _sourceConfig)
		{
			var newNodes = [];
			for (var i = 0; i < nodesResults.results.length; i++){
				
				var result = nodesResults.results[i];
				for (var d = 0; d < result.data.length; d++){
					var row = result.data[d].row;
					
					var I_N_ID = 0;
					var I_N_LABELS = 1;
					var I_N_PROPS = 2;
					var I_R_ID = 3;
					var I_R_LABELS = 4;
					var I_R_PROPS = 5;
					var I_M_ID = 6;
					var I_M_LABELS = 7;
					var I_M_PROPS = 8;
					
					//Node N...
					var datN = new datax;
					datN.id =_sourceConfig.prefix + row[I_N_ID];
					if (row[I_N_LABELS]){datN.labels = row[I_N_LABELS];}
					if (row[I_N_PROPS]){datN.properties = new neoPropertyList(row[I_N_PROPS]);}
					var fromNode = addDataNode(datN.id, datN, _sourceConfig);
					if (fromNode){newNodes.push(fromNode);}
					//if (!GRAPH.getNode(row[I_N_ID])){
					//	var pos = layout.getNodePosition(row[I_N_ID]);
					//	layout.setNodePosition(row[I_N_ID], pos.x, pos.y);
					//}
					//Node M...
					var datM = new datax();
					datM.id =_sourceConfig.prefix + row[I_M_ID];
					if (row[I_M_LABELS]){datM.labels = row[I_M_LABELS];}
					if (row[I_M_PROPS]){datM.properties = new neoPropertyList(row[I_M_PROPS]);}
					var toNode = addDataNode(datM.id, datM, _sourceConfig);
					if (toNode){newNodes.push(toNode);}
					
					//link R...
					var linkdata = new datay(datN.id, datM.id, _sourceConfig.prefix + row[I_R_ID], row[I_R_LABELS], _sourceConfig);
					//linkdata.fromNodeID = datN.id;
					//linkdata.toNodeID = datM.id;
					//linkdata.id = _sourceConfig.prefix + row[I_R_ID];
					//linkdata.name = row[I_R_LABELS];
					linkdata.properties = new neoPropertyList(row[I_R_PROPS]);
					var link = addDataLink(datN.id, datM.id, linkdata, _sourceConfig);
				}
			}	
			return newNodes;
		}
		
		function addSingleNodesFromResults(nodesResults, _sourceConfig)
		{
			for (var i = 0; i < nodesResults.results.length; i++){
				
				var result = nodesResults.results[i];
				for (var d = 0; d < result.data.length; d++){
					var row = result.data[d].row;
					var I_N_ID = 0;
					var I_N_LABELS = 1;
					var I_N_PROPS = 2;
					//Node N...
					var dat = new datax();
					dat.id =_sourceConfig.prefix +row[I_N_ID];
					if (row[I_N_LABELS]){dat.labels = row[I_N_LABELS];}
					if (row[I_N_PROPS]){dat.properties = new neoPropertyList(row[I_N_PROPS]);}
					addDataNode(dat.id, dat, _sourceConfig);
				}
			}
		}
		
		function addSingleRelationFromResults(nodesResults, _sourceConfig)
		{
			for (var i = 0; i < nodesResults.results.length; i++){
				
				var result = nodesResults.results[i];
				for (var d = 0; d < result.data.length; d++){
					var row = result.data[d].row;
					var I_N_ID = 0;
					var I_M_ID = 1;
					var I_R_ID = 2;
					var I_R_TYPE = 3;
					var I_R_PROPS = 4;
					//Node N...
					var dat = new datay(_sourceConfig.prefix + row[I_N_ID], _sourceConfig.prefix + row[I_M_ID], _sourceConfig.prefix + row[I_R_ID], row[I_R_TYPE], _sourceConfig);
					//dat.fromNodeID = _sourceConfig.prefix + row[I_N_ID];
					//dat.toNodeID = _sourceConfig.prefix + row[I_M_ID];
					//dat.id = _sourceConfig.prefix + row[I_R_ID];
					//if (row[I_R_TYPE]){dat.name = row[I_R_TYPE];}
					if (row[I_R_PROPS]){dat.properties = new neoPropertyList(row[I_R_PROPS]);}
					var node = addDataLink(dat.fromNodeID, dat.toNodeID, dat, _sourceConfig);
				}
			}
		}
		
		function getUpdatedProperties(propListFrom, propListTo)
		{
			
			var updatedProperties = [];
			propListFrom.forEach(function(fromProp){				
				var foundProp = false;
				propListTo.forEach(function(toProp){
					if (fromProp.key == toProp.key){
						foundProp = true;
						if (fromProp.value != toProp.value)
						{
							updatedProperties.push({property:toProp, updateType:'update'});
						}
					}
						
				})
				if (!foundProp){ //toProps did not have the property, the property must have been deleted.
					updatedProperties.push({property:fromProp, updateType:'delete'});
				}
			});
			
			//check for new properties (will be in the ToList but not the FromList)
			propListTo.forEach(function(toProp){
				var foundProp = false;
				propListFrom.forEach(function(fromProp){
					if (fromProp.key == toProp.key){
						foundProp = true;
					}
				});
				if (!foundProp){ //fromProps did not have the property, the property must be new.
					updatedProperties.push({property:toProp, updateType:'create'});
				}
			});
			
			return updatedProperties;
		}
		
		function addWindowNode()
		{
		
			var nodeId = 'DetailsWindow';
			var data = new datax();
			data.height = 200;
			data.width = 200;
			data.nodeShape = 'rect';
			data.nodeType = 'window';
			data.isPinned = true;
			detailsNode = addNodeToGraph(nodeId, data);
			layout.pinNode(detailsNode, true);
			return graphics.getNodeUI(nodeId);	
		}
		
		function fixLinkIndexes(fromNodeID, toNodeID){ //Get sibling details...
			
			var totalSiblings = 0;
			var leftSiblings = 0;
			var rightSiblings = 0;
			//get sibling information
			linkList.forEach(function (link){
				if (link.toId == toNodeID && link.fromId == fromNodeID){
					totalSiblings++;
					leftSiblings++
				}
				else if (link.toId == fromNodeID && link.fromId == toNodeID){
					totalSiblings++;
					rightSiblings++
				}
			});
			
			linkList.forEach(function (link){
				if (link.toId == toNodeID && link.fromId == fromNodeID){
					//this is a left sibling
					if (totalSiblings == 1){ //there is only one sibling so its position will be center 
						link.data.UI.fullUI.attr('linkPos',0);
					}else{
						//add the position of the sibling, (counting down so that widest is always underneath)
						link.data.UI.fullUI.attr('linkPos', leftSiblings--);
					}
				}
				else if (link.toId == fromNodeID && link.fromId == toNodeID){
					if (totalSiblings == 1){ //there is only one sibling so its position will be center 
						link.data.UI.fullUI.attr('linkPos',0);
					}else{
						//add the position of the sibling, (counting down so that widest is always underneath)
						link.data.UI.fullUI.attr('linkPos', rightSiblings--);
					}
				}
			});
		}
		
		function addPlannedLink(fromNodeID, toNodeID, linkName, linkProperties)
		{
			var plannedLinkData = new datay()
			plannedLinkData.fromNode = fromNodeID;
			plannedLinkData.toNode = toNodeID;
			plannedLinkData.id = fromNodeID + '_' + toNodeID + ' ' + linkName;
			plannedLinkData.name = linkName;
			plannedLinkData.displayLabel = linkName;
			plannedLinkData.linkType = 'planned';
			//plannedLinkData.properties = linkProperties;
			plannedLinkData.color = 'red';
			link = GRAPH.addLink(fromNodeID, toNodeID, plannedLinkData);
			linkList.push(link);
		}
		
		function addDataLink(fromNodeID, toNodeID, linkData, _sourceConfig)
		{
			linkData.sourceConfig = _sourceConfig? _sourceConfig : currentTheme.sourceConfig;
			var bIsNew = false;
			var link;
			var existingLink = getDataLink(linkData.id);
			if (existingLink){
				//var linkUI = graphics.getLinkUI(linkData.id);
				//check if any properties changed 
				var updatedProperties = getUpdatedProperties(linkData.properties, existingLink.data.properties);
				if (linkData.name != existingLink.data.name || updatedProperties.length > 0){
					existingLink.data.name = linkData.name;
					existingLink.data.displayLabel = linkData.name;
					existingLink.data.properties = linkData.properties;
					//$(linkUI).hide().show(0);
					animUpdateLinks.push(existingLink);
				}
				link = existingLink;
				fromNodeID = existingLink.data.fromNodeID;
				toNodeID = existingLink.data.toNodeID;
			}
			else{
				bIsNew = true;
				link = GRAPH.addLink(fromNodeID, toNodeID, linkData);
				link.data.fromNodeID = fromNodeID;
				link.data.toNodeID = toNodeID;
				link.data.displayLabel = linkData.name;
				linkList.push(link); //new linkType(fromNodeID,toNodeID, linkData, linkData.id)); 
				fixLinkIndexes(fromNodeID, toNodeID);
				//fixTextWidth4Link(link);
			}

			var toNode = GRAPH.getNode(toNodeID);
			var fromNode = GRAPH.getNode(fromNodeID);
			
			config_ext.startupOptions.linkDisplayValues.map(function (lconfig) {
				var useConfig = true;
				if (lconfig.labelFrom){useConfig = (lconfig.labelFrom == fromNode.data.labels[0])?useConfig:false}else{useConfig = false;}
				if (lconfig.labelTo){useConfig = (lconfig.labelTo == toNode.data.labels[0])?useConfig:false}else{useConfig = false;}
				if (lconfig.type){useConfig = (lconfig.type == link.data.name)?useConfig:false}else{useConfig = false;}
				if (useConfig){
					link.data.config = lconfig;
					link.data.displayLabel = lconfig.displayField;
					var propertyValue = getNodePropertyValue(link.data.properties, lconfig.displayField);
					link.data.displayLabel = propertyValue ? propertyValue : ' ';
				}			
			});
			refreshLinkVisual(link);

			if (bIsNew)
			{
				toNode.data.fromLinks.push(link);
				toNode.data.fromNodes.push(fromNode);
				fromNode.data.toLinks.push(link);
				fromNode.data.toNodes.push(toNode);
				
				//Node sizing...
				if (config_ext.viewOptions.nodeSizing == 'relationCount'){increaseNodeSize(fromNodeID); increaseNodeSize(toNodeID);}
				if (config_ext.viewOptions.nodeSizing == 'outRelationCount' ) {increaseNodeSize(fromNodeID);}
				if (config_ext.viewOptions.nodeSizing == 'inRelationCount' ) {increaseNodeSize(toNodeID);}
			}
			
			fixTextWidth4Link(link);
		}
		
		function refreshLinkVisual(link)
		{
			if(link.data.UI.nameTextUI){link.data.UI.nameTextUI.innerHTML = link.data.displayLabel;}
			if(link.data.UI.subTextUI){link.data.UI.subTextUI.innerHTML = propertyListToSvgList(link.data.properties, '<tspan x="0" dy="1.2em">', '</tspan>');}
			
			//link.data.UI.subTextUI.attr('x', link.data.UI.subTextUI.getBBox().width/2)
			//toggle twice to refresh link...
			toggleLink(link);
			toggleLink(link);
		}
		
		function getGraphId(prefix, fromNeoId)
		{
			return prefix + fromNeoId;
		}
		function getNeoId(fromGraphId)
		{
			return fromGraphId.substring(3); 
		}
		
		function unPinNode()
		{
			layout.pinNode(selectedNode, false);
			selectedNode.data.isPinned = false;
		}
		
		function updateViewOptions()
		{
			viewOptions.highlightRelated = document.getElementById('vo.hr').checked;
			viewOptions.highlightAncestors = document.getElementById('vo.ha').checked;
			viewOptions.highlightdescendants = document.getElementById('vo.hd').checked;
		}
		function updateViewOptions_Nav(navoption)
		{
			viewOptions.navigateDirection = navoption;
		}
		
		function updateInteractionOptions()
		{
			interactionOptions.checkNodes = document.getElementById('vo.ch').checked;
		}
		
		function unPinAllNodes()
		{
			nodeList.forEach(function(node){
				layout.pinNode(node, false);
				node.data.isPinned = false;
			});
		}
		
		
		function uncheckAll(){
			//check nodes
			nodeList.forEach(function(node){
				uncheckNode(node);
			});
			//check links
			linkList.forEach(function(link){
				uncheckLink(link);
			});
		}
		function checkAll(){
			//check nodes
			nodeList.forEach(function(node){
				checkNode(node);
			});
			//check links
			linkList.forEach(function(link){
				checkLink(link);
			});
		}
		
		function getDataRootNodes()
		{
			var rootNodes = [];
			nodeList.forEach(function(node){
				if (node.data.fromNodes.length == 0)
				{
					rootNodes.push(node);
				}
			});
			return rootNodes;
		}
		
		
		function arrangeBy(rootNode, processedNodeIds, maxxRight, maxxLeft, level, startY)
		{
			
			if (!rootNode){
				squares = [];
				var startPos = layout.getNodePosition(nodeList[0].id);
				var rootNodes = getDataRootNodes();
				processedNodeIds = [];
				
				var startpos = startPos.x;
				nodeList.forEach(function(node){
					layout.pinNode(node, true);
					node.data.isPinned = true;
					startpos += 100;
					layout.setNodePosition(node.id, startpos, startPos.y);
				});
			
				maxxRight = startPos.x;
				maxxLeft = startPos.x;
				startY = startPos.y;
				rootNodes.forEach(function(rootNode, index){
					//layout.setNodePosition(rootNode.id, maxxRight, startPos.y);
					//processedNodeIds.push(rootNode.id);
					maxxRight = arrangeBy(rootNode, processedNodeIds, maxxRight, maxxLeft, 0, startY);
					//layout.setNodePosition(rootNode.id, maxxRight, startPos.y);
				});
			}
			else{
				

				level++;
				//layout.pinNode(rootNode, true);
				processedNodeIds.push(rootNode.id);
				var rootNodePos = layout.getNodePosition(rootNode.id);
				var cb = rootNodePos.x - ((rootNode.data.toNodes.length*100) /2)
				rootNode.data.toNodes.forEach(function(childNode, index){
					var childNodePos = layout.getNodePosition(childNode.id);
					childNodePos.x = cb + (100 * index);
					if (childNodePos.x + 100 >= maxxRight) {maxxRight = childNodePos.x + 100;}
					if (childNodePos.x <= maxxLeft) {maxxLeft = maxxLeft - 100; maxxRight = maxxRight + 100;}
					var childLevel = startY + (level * 150);
					if (childLevel > childNodePos.y) {childNodePos.y = childLevel};
					layout.setNodePosition(childNode.id, childNodePos.x, childNodePos.y);
					
					if (processedNodeIds.indexOf(childNode.id) < 0){
						arrangeBy(childNode, processedNodeIds, maxxRight, maxxLeft, level, startY);
					}
					else //cyclic relation
					{
						//layout.pinNode(node, false);
						//node.data.isPinned = false;
					}
				});
			}
			return maxxRight;
			/*/------------------------------------------------------------------------------------
			var startPos = layout.getNodePosition(nodeList[0].id);
			var rootNodes = getDataRootNodes();
			var allNodes = [];
			var xpos = startPos.x;

			rootNodes.forEach(function(node){
				allNodes.push(node.id);
			});

			nodeList.forEach(function(node){
				xpos = xpos + node.data.nodeSize * 2;
				var currentNodePos = layout.getNodePosition(node.id);
				layout.setNodePosition(node.id, xpos, startPos.y);
				layout.pinNode(node, true);
				node.data.isPinned = true;
				node.data.maxlevel = 0;
			});
				
			for (var i = 0; i< 2; i++)
			{
				nodeList.forEach(function(node){
					node.data.toNodes.forEach(function(othernode, index){
						if (othernode.data.maxlevel <= node.data.maxlevel){othernode.data.maxlevel = node.data.maxlevel+1}
						var currentParentPos = layout.getNodePosition(othernode.id);
						var currentNodePos = layout.getNodePosition(othernode.id);
						//var newYPos = (currentParentPos<currentNodePos)?currentParentPos.y:currentNodePos.y + 100;
						var newYPos = startPos.y + (othernode.data.maxlevel * 100);
						//var newXPos = (currentParentPos.x + currentNodePos.y)/2;
						layout.setNodePosition(othernode.id, currentNodePos.x, newYPos);
					});
				});
			}

			return;
			*/
		}
		
		function addNodeToGraph(nodeId, nodeData)
		{
			var node = GRAPH.getNode(nodeId);
			//if (!node){
			node = GRAPH.addNode(nodeId, nodeData);
			//}else{ //...node already exists
			//	//refresh nodes appearance
			//	if (node.data.UI.fullUI){

			//		$(node.data.UI.fullUI).hide().show();
			//	}
			//}
			fixTextWidth4Node(node);
			return node;
		}
		
		
		function increaseNodeSize(nodeId)
		{
			if (!nodeId){nodeId = selectedNodeID;}
			var node = GRAPH.getNode(nodeId);
			node.data.nodeSize = node.data.nodeSize + 50/node.data.nodeSize;
			//node.data.UI.popoutBodyUI.attr('x', node.data.nodeSize/2)
            //            .attr('y', -node.data.nodeSize)
			//node.data.UI.popoutBodyUI.attr('x', node.data.nodeSize/2)
            //            .attr('y', -node.data.nodeSize)
						
			node.data.UI.bodyUI.attr('r', node.data.nodeSize) //...for circle
			node.data.UI.imageUI.attr('x', -node.data.nodeSize)
						.attr('y', -node.data.nodeSize)
						.attr('rx', node.data.nodeSize)
						.attr('width', node.data.nodeSize * 2)
						.attr('height', node.data.nodeSize * 2)
			
			node.data.toLinks.forEach(function (link){
				link.data.UI.fullUI.attr('fromNodeRadius', node.data.nodeSize);
			});
			node.data.fromLinks.forEach(function (link){
				link.data.UI.fullUI.attr('toNodeRadius', node.data.nodeSize);
			});
			
			//addNodeToGraph(node.id,node.data);
			increaseNodeSprings(node.id);
			fixTextWidth4Node(node);
			//node.data.toLinks.forEach(function(link){
				//var linkUI = graphics.getLinkUI(link.id);
				//linkUI.attr('stroke-width',node.data.nodeSize/5);
			//});			
		}		

		function decreaseNodeSize(nodeId)
		{
			if (!nodeId){nodeId = selectedNodeID;}
			var node = GRAPH.getNode(nodeId);
			node.data.nodeSize = node.data.nodeSize / 1.1;
			addNodeToGraph(node.id,node.data);
			decreaseNodeSprings(node.id);
		}	
		
		function highlightLabel(labelIndex)
		{
			var label = labelsList[labelIndex];
			//checkedNodes.forEach(function(node){
				//var nodeUI = graphics.getNodeUI(node.id);
				//if (node.data.UI.fullUI) {node.data.UI.fullUI.attr('stroke','transparent');}
			//});
			
			//fadedNodes = [];
			
			//checkedNodes = [];
			nodeList.forEach(function(node){
				//var nodeUI = graphics.getNodeUI(node.id);
				//node.data.toLinks.forEach(function(link){
				//	var linkUI = graphics.getLinkUI(link);
				//	linkUI.attr('stroke-opacity','0.1');
				//});
				
				//if (node.data.labels.indexOf(label.name) > -1){	
				node.data.UI.fullUI.attr('fill-opacity',1);
				node.data.UI.bodyUI.attr('fill-opacity',1);
				//}
				if (label && node.data.labels.indexOf(label.name) == -1){
					node.data.UI.fullUI.attr('fill-opacity',0.2)
					node.data.UI.bodyUI.attr('fill-opacity',0.2);
					//fadedNodes.push(node);
				}
			});
			
			
		}
		
		//function addLabelSelector(labelName)
		//{
			//if (getNeoLabel(labelName)) return;

		//}
//USEFULL FUNCTIONS
		//convert string to Base64
		//var encodedData = window.btoa(stringToEncode);

		function calculateDistance(pos1, pos2){
			return Math.sqrt(Math.pow(pos2.x - pos1.x,2) + Math.pow(pos2.y - pos1.y,2));
		}
		
		function parseDataType(n) {
			if (n=="true"){return true;}
			if (n=="false"){return false;}
			if (n=="null"){return null;}
			if (n=="undefined"){return undefined;}
			if (!isNaN(parseFloat(n)) && isFinite(n)) return Number(n);
			return '"' + n + '"';
		}

		var sort_by = function(field, reverse, primer){
		   var key = primer ? 
			   function(x) {return primer(x[field])} : 
			   function(x) {return x[field]};
		   reverse = !reverse ? 1 : -1;
		   return function (a, b) {
			   return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
			 } 
		}

		// Returns a random number between min (inclusive) and max (exclusive)
		function getRandomArbitrary(min, max) {
			return Math.random() * (max - min) + min;
		}
		//RGB to #HEX
		function rgb2hex(red, green, blue) {
				var rgb = blue | (green << 8) | (red << 16);
				return '#' + (0x1000000 + rgb).toString(16).slice(1)
		  }

		
		function sleepFor( sleepDuration ){
			var now = new Date().getTime();
			while(new Date().getTime() < now + sleepDuration){ /* do nothing */ } 
		}
		

//AJAX CALLS
		
		function Neo4j_Command(statements, successCallback, _sourceConfig, failCallback)
		{
			var sourceConfig = _sourceConfig ? _sourceConfig : currentTheme.sourceConfig;
			var body = new neo_APIcall(); 
			statements.forEach(function(statement){
				body.statements.push(new neo_Statement(statement));
				//console.log(statement);
			});
			
			$.ajax({
					url: sourceConfig.neo4jconnection.server + "/db/data/transaction/commit",
					type: 'post',
					data: JSON.stringify(body),
					headers: {
						"Accept":'application/json; charset=UTF-8',
						"Content-Type": 'application/json',
						"Authorization": 'Basic ' + window.btoa(sourceConfig.neo4jconnection.username + ':' + sourceConfig.neo4jconnection.password) //_connection.userToken
					},
					dataType: 'json',				
					
					success: function (returnbody){
						if (successCallback){
							successCallback(returnbody, sourceConfig);
						}
					},
					error: function (returnbody){
						if (failCallback){
							failCallback(returnbody, sourceConfig);
						}
					}()
				});
		}

		function Neo4jFetchEntitiesForNode(nodeId, _sourceConfig)
		{
			if (!nodeId) {nodeId = selectedNodeID;}
			var command = '';
			switch(viewOptions.navigateDirection){
			case 'child':
				command = 'MATCH (n)-[r]->(m) WHERE ID(n) = ' + getNeoId(nodeId) + ' RETURN id(startnode(r)), labels(startnode(r)), startnode(r) , id(r), type(r), r, id(endnode(r)), labels(endnode(r)), endnode(r)';
				break;
			case 'parent':
				command = 'MATCH (n)<-[r]-(m) WHERE ID(n) = ' + getNeoId(nodeId) + ' RETURN id(startnode(r)), labels(startnode(r)), startnode(r) , id(r), type(r), r, id(endnode(r)), labels(endnode(r)), endnode(r)';
				break;
			default:
				command = 'MATCH (n)-[r]-(m) WHERE ID(n) = ' + getNeoId(nodeId) + ' RETURN id(startnode(r)), labels(startnode(r)), startnode(r) , id(r), type(r), r, id(endnode(r)), labels(endnode(r)), endnode(r)';
				break;
			}
			var callback2 = function(nodesResult, sourceConfig){
				var newNodes = addNodesFromResults(nodesResult, sourceConfig)
				//popout effect
				newNodes.forEach(function (newNode){
					layout.pinNode(newNode, true);
					var pos = layout.getNodePosition(nodeId);
					layout.setNodePosition(newNode.id, pos.x, pos.y-10);
					layout.pinNode(newNode, false);
				});
				
			};
			Neo4j_Command([command], callback2, _sourceConfig);
		}
		
		/*_direction = "left"(node1:toNode, node2:toNode) /"right"/"both"
		*/
		function Neo4jGetRelationCounts(nodeId, callback, _sourceConfig)
		{
			command = 'MATCH (n)-[r]->(m) where id(n) = '+getNeoId(nodeId)+' RETURN count(n) UNION MATCH (n)<-[r]-(m) where id(n) = '+getNeoId(nodeId)+ ' RETURN count(n)'

			var callback2 = function(nodesResults, sourceConfig){
				for (var i = 0; i < nodesResults.results.length; i++){	
						var result = nodesResults.results[i];
						var fromLinksCount = (result.data[0])? result.data[0].row[0]: 0; 
						var toLinksCount = (result.data[1])? result.data[1].row[0]: 0;
						callback(fromLinksCount, toLinksCount, sourceConfig);
				}	
			};
			Neo4j_Command([command], callback2, _sourceConfig);	
		}

		function Neo4jGetNodeById(nodeid, _sourceConfig)
		{
			var callback = function (nodesResult, sourceConfig) {
				addSingleNodesFromResults(nodesResult, sourceConfig);
			}
			
			var command = 'MATCH (n) WHERE ID(n) = '+getNeoId(nodeid)+'  RETURN id(n), labels(n), (n)';
			Neo4j_Command([command], callback, _sourceConfig);
		}

		function getConfigByPrefix(configPrefix)
		{
			for (var i = 0; i < masterConfigs.length; i++){
				if (masterConfigs[i].prefix == configPrefix){
					return masterConfigs[i];
				}
			}
		}
		
		function Neo4jGetNodesByLabel(byLabel, sourceConfigPrefix)
		{
			var _sourceConfig = getConfigByPrefix(sourceConfigPrefix)
			var callback = function (nodesResult, sourceConfig) {
				addSingleNodesFromResults(nodesResult, sourceConfig);
			}
			var matchPattern = 'n';
			if (byLabel && byLabel != '') {matchPattern += ":" + byLabel;}
			var command = 'MATCH ('+matchPattern+') RETURN id(n), labels(n), (n)';
			Neo4j_Command([command], callback, _sourceConfig);
		}
		
		function Neo4jGetNodesByDetails(label, properties, _sourceConfig)
		{
			var callback = function (nodesResult, sourceConfig) {
				addSingleNodesFromResults(nodesResult, sourceConfig);
			}
			var matchPattern = 'n';
			if (label) {matchPattern += ":" + label;}
			var command = 'MATCH ('+matchPattern+')';
			if (properties){
				if (properties.length > 0)
				{
					var conditions;
					properties.forEach(function (prop) {
						if (conditions) {conditions += ' AND'} else {conditions = ''}
						conditions += ' n.' + prop.key + '=' + parseDataType(prop.value);
					});
					command += ' WHERE' + conditions;
				}
			}
			command += ' RETURN id(n), labels(n), (n)';
			Neo4j_Command([command], callback, _sourceConfig);
		}

		function Neo4jInitAllNodes(_sourceConfig)
		{
			var callback = function (nodesResult, sourceConfig) {
				addSingleNodesFromResults(nodesResult, sourceConfig);
				Neo4jInitAllRelations(_sourceConfig);
			}
			var command = 'MATCH (n) RETURN id(n), labels(n), (n)';
			Neo4j_Command([command], callback, _sourceConfig);
		}

		function Neo4jInitAllRelations(_sourceConfig)
		{
			var callback = function (relationsResult, sourceConfig) {
				addSingleRelationFromResults(relationsResult, sourceConfig);
			}
			var command = 'MATCH (n)-[r]-(m) RETURN id(n), id(m), id(r), type(r), r';
			Neo4j_Command([command], callback, _sourceConfig);
		}
		
		
		function Neo4jCreateNode(labelName, _sourceConfig)
		{
			var callback = function (nodesResult, sourceConfig) {
				addSingleNodesFromResults(nodesResult, sourceConfig);
			}
			var command = 'CREATE (n:' + labelName + ') RETURN id(n), labels(n), n';
			Neo4j_Command([command], callback, _sourceConfig);
		}
	
		function Neo4jDeleteNode(nodeID, _sourceConfig)
		{
			var callback = function (nodesResult, sourceConfig) {
				//addSingleNodesFromResults(nodesResult);
				removeNodeFromStage(nodeID)
			}
			var command = 'MATCH (n) where ID(n) = '+ getNeoId(nodeID) +' DETACH DELETE (n) RETURN ID(n)';
			Neo4j_Command([command], callback, _sourceConfig);
			
			
		}


		
		
//UI MANIPULATION

		
		function createNode(){
			var newNodeValue = document.getElementById('newNodeData').value;
			Neo4jCreateNode(newNodeValue);
		}
		
		function getEntityNode(){
			var newNodeValue = document.getElementById('nodeLabel').value;
			Neo4jGetNodesByLabel(newNodeValue);
		}
		
		function deleteNode(){
			Neo4jDeleteNode(selectedNodeID);
		}
		
		function refreshNodeAppearance(nodeId){
			var node = GRAPH.getNode(nodeId?nodeId:selectedNodeID);
			addNodeToGraph(node.id,node.data);
		}
		
		function Neo4jRowReturn(returnbody, callback) {
			for (var r = 0; r < returnbody.results.length; r++){
				var result = returnbody.results[r];
				for (var c = 0; c < result.data.length; c++){
					callback(result.data[c].row);
				}
			}
		}
					
		function relateSelectedToNode(){
			bRelate = true;
		}
		
		function planRelateSelectedToNode(){
			bPlanRelate = true;
		}
		
		function fontGrow()
		{
			if (!selectedNode.data.UI.displayTextUI){return;}
			var fontsize = Number(selectedNode.data.UI.displayTextUI.attr('font-size'));
			selectedNode.data.UI.displayTextUI.attr('font-size', fontsize + 1);
		}
		function fontShrink()
		{
			if (!selectedNode.data.UI.displayTextUI){return;}
			var fontsize = Number(selectedNode.data.UI.displayTextUI.attr('font-size'));
			selectedNode.data.UI.displayTextUI.attr('font-size', fontsize - 1);
		}
		function fontDown()
		{
			if (!selectedNode.data.UI.displayTextUI){return;}
			var fontsize = Number(selectedNode.data.UI.displayTextUI.attr('y'));
			selectedNode.data.UI.displayTextUI.attr('y', fontsize + 1);
		}
		function fontUp()
		{
			if (!selectedNode.data.UI.displayTextUI){return;}
			var fontsize = Number(selectedNode.data.UI.displayTextUI.attr('y'));
			selectedNode.data.UI.displayTextUI.attr('y', fontsize - 1);
		}
		
		function Neo4jFetchRelation(fromNodeID, toNodeID, _sourceConfig)
		{
			command = 'MATCH (n)-[r]-(m) WHERE ID(n) = ' + getNeoId(fromNodeID) + ' and ID(m) = '+getNeoId(toNodeID)+' RETURN id(startnode(r)), labels(startnode(r)), startnode(r) , id(r), type(r), r, id(endnode(r)), labels(endnode(r)), endnode(r)';
			var callback2 = function(nodesResult, sourceConfig){
				addNodesFromResults(nodesResult, sourceConfig)
			};
			Neo4j_Command([command], callback2, _sourceConfig);
			
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function fixTextWidth4Link(link)
		{
			if(link.data.UI.nameTextUI && link.data.UI.midMarkerUI){
				var textWidth = link.data.UI.nameTextUI.getBBox().width;
				link.data.UI.nameTextUI.attr('x', -textWidth/2);
				link.data.UI.fullUI.attr('labelWidth',textWidth);
				
				if(link.data.UI.subTextUI){
					var i = 0;
					var boxWidth = link.data.UI.subTextUI.getBBox().width;
					while (link.data.UI.subTextUI.children[i]){
						$(link.data.UI.subTextUI.children[i]).attr('x', -boxWidth/2);
						i++;
					}
				}
			}
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function fixTextWidth4Node(node)
		{	
			//adjust display text...
			if (node.data.UI.bodyUI && node.data.UI.displayTextUI)
			{
				if (!node.data.sourceConfig.displaySettings.showLabels) {return;}
				var nodeRadius = node.data.nodeSize; //UI.fullUI.attr('r');//nodeUI.attr('r');
				var widthOfNode = Number(node.data.UI.bodyUI.getBBox().width);
				var minWidth = widthOfNode - widthOfNode * 0.1;
				var widthOfText = Number(node.data.UI.displayTextUI.getBBox().width);
				var text = node.data.UI.displayTextUI.text();
				var heightOfText = Number(node.data.UI.displayTextUI.getBBox().height);
				if (!text || text.length == 0) {return;}

				if (node.data.config.nodeDisplayBody.labelPos){
					switch(node.data.config.nodeDisplayBody.labelPos){
						case "above":
							node.data.UI.displayTextUI.attr('x', -widthOfText/2 ); //-minWidth/2);
							node.data.UI.displayTextUI.attr('y', -heightOfText - nodeRadius/3);
							break;
						case "under":
							node.data.UI.displayTextUI.attr('x', -widthOfText/2); //-minWidth/2);
							node.data.UI.displayTextUI.attr('y', nodeRadius + heightOfText);
							break;
						case "right":
							node.data.UI.displayTextUI.attr('x', nodeRadius + nodeRadius/3); //-minWidth/2);
							node.data.UI.displayTextUI.attr('y', heightOfText/3);
							break;
						case "left":
							node.data.UI.displayTextUI.attr('x', -(widthOfText + nodeRadius + nodeRadius/3)); //-minWidth/2);
							node.data.UI.displayTextUI.attr('y', heightOfText/3);
							break;
					}
				}
				else{
				
					var failer = 0;
					if (widthOfText > minWidth)
					{
						while (widthOfText >= minWidth)
						{
							failer++;
							if (node.data.sourceConfig.displaySettings.labelSizing == 'hyphenate')
							{
								text = (text).substring(0, text.length-2) + "'";
								node.data.UI.displayTextUI.text(text);
							}
							else if (node.data.sourceConfig.displaySettings.labelSizing == 'fontsize')
							{
								var fontsize = Number(node.data.UI.displayTextUI.attr('font-size'));
								node.data.UI.displayTextUI.attr('font-size', fontsize*0.9);
							}
							else return;
							widthOfText = Number(node.data.UI.displayTextUI.getBBox().width);
							if (failer > 1000) return;
						}
					}
					else if (node.data.sourceConfig.displaySettings.labelSizing == 'fontsize')
					{	failer = 0;		
						
						while (widthOfText < minWidth - (widthOfText *0.2))
						{
							failer++;
							var fontsize = Number(node.data.UI.displayTextUI.attr('font-size'));
							node.data.UI.displayTextUI.attr('font-size', fontsize*1.1);
							widthOfText = Number(node.data.UI.displayTextUI.getBBox().width);
							if (failer > 1000) return;
						}
					}					
					heightOfText = Number(node.data.UI.displayTextUI.getBBox().height);
					node.data.UI.displayTextUI.attr('x', -widthOfText/2);
					node.data.UI.displayTextUI.attr('y',  heightOfText/3 );
				}
			}
			
			//adjust size of popout text...
			if(node.data.UI.popoutBodyUI)
			{	
				var boxheight = 0;
				var boxwidth = 0;
				if (node.data.UI.popoutTextUI && node.data.UI.popoutTextUI.children.length > 0){
					boxheight = Number(node.data.UI.popoutTextUI.getBBox().height + 20);
					boxwidth = Number(node.data.UI.popoutTextUI.getBBox().width + 30);
				}
				node.data.UI.popoutBodyUI.attr('height',boxheight);
				node.data.UI.fullUI.attr('style','width:'+boxwidth + 'px;');
				node.data.UI.popoutBodyUI.attr('x', node.data.nodeSize + 10)
				node.data.UI.popoutTextUI.innerHTML = propertyListToSvgList(node.data.properties, '<tspan x="'+(node.data.nodeSize + 15)+'" dy="1.2em">', '</tspan>');
			}
			
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function Neo4jDeleteLabel(nodeId, labelName, _sourceConfig)
		{
			var command = "MATCH (n) where ID(n) = " + getNeoId(nodeId) + " REMOVE n:" + labelName;
			var callback = function(results, sourceConfig){
				Neo4jGetNodeById(selectedNodeID, sourceConfig)
			};
			Neo4j_Command([command], callback, _sourceConfig, callback);
		}	
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function Neo4jAddProperty(nodeId, _sourceConfig)
		{
			if (!nodeId) {nodeId=selectedNodeID}
			var elePropKey = document.getElementById('add.property.key').value;
			var elePropVal = document.getElementById('add.property.value').value;
			var elePropType = document.getElementById('add.property.type').value;
			if (!elePropType) {elePropType ="string";}
			if (elePropType == "string"){elePropVal = '"' + elePropVal + '"'}
			var command = "MATCH (n) where ID(n) = " + getNeoId(nodeId) + " SET n +={" + elePropKey + ":" + elePropVal + "}";
			
			var callback = function(results, sourceConfig){
				Neo4jGetNodeById(selectedNodeID, sourceConfig);
			};
			Neo4j_Command([command], callback, _sourceConfig, callback);
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function addPropertyToChecked()
		{
			checkedNodes.forEach(function(node){
				Neo4jAddProperty(node.id);
			});
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function addPropertyToAll()
		{
			nodeList.forEach(function(node){
				Neo4jAddProperty(node.id);
			});
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function showOnNode(nodeId, text)
		{
			var node = getDataNode(nodeId);
			node.data.displayLabel = text;
			refreshNodeAppearance(nodeId);
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function increaseNodeSprings(nodeid)
		{
			if (!nodeid){nodeid=selectedNodeID;}
			var node = getDataNode(nodeid);
			
			node.data.toNodes.forEach(function(toNode){
				var nodespring = layout.getSpring(nodeid, toNode.id);
				nodespring.length += 10;
			});
			node.data.fromNodes.forEach(function(toNode){
				var nodespring = layout.getSpring(toNode.id, nodeid);
				nodespring.length += 10;
			});
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function decreaseNodeSprings(nodeid)
		{
			if (!nodeid){nodeid=selectedNodeID;}
			var node = getDataNode(nodeid);
			
			node.data.toNodes.forEach(function(toNode){
				var nodespring = layout.getSpring(nodeid, toNode.id);
				nodespring.length -= 10;
			});
			node.data.fromNodes.forEach(function(toNode){
				var nodespring = layout.getSpring(toNode.id, nodeid);
				nodespring.length -= 10;
			});
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function increaseNodeMass(nodeid)
		{
			if (!nodeid){nodeid=selectedNodeID;}
			var nodebod = layout.getBody(nodeid);
			nodebod.mass++;
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function decreaseNodeMass(nodeid)
		{
			if (!nodeid){nodeid=selectedNodeID;}
			var nodebod = layout.getBody(nodeid);
			nodebod.mass--;
		}
		
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------				
		function Neo4jAddLabel(_sourceConfig)
		{
			var processingElement = document.getElementById('log');
			//node.data.labels.push(processingElement.value);
			if(!processingElement) return;
			if(!processingElement.value) return;
			
			var callback = function(results, sourceConfig){
				Neo4jGetNodeById(selectedNodeID, sourceConfig);
			};
			
			var command = "MATCH (n) where ID(n) = " + getNeoId(selectedNodeID) + " SET n:" + processingElement.value;
			Neo4j_Command([command], callback, _sourceConfig, callback );
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function Neo4jGetAllLabels(_sourceConfig)
		{
			//var command = "match (n) return distinct labels(n)";
			var callback = function(data, sourceConfig){
				data.results[0].data.forEach(function (dataobject){
					addDataLabel(dataobject.row[0][0], dataobject.row[1], sourceConfig);
				});
				refreshLabelSelectors();
			};
			
			var command = "match (n) return labels(n), count(labels(n))";
			Neo4j_Command([command], callback, _sourceConfig);
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function showNodeDetails(node)
		{
			var processingElement = document.getElementById('selectedNode');
			var labellist = ''
			var html = '<a class="panelheader">Selected Entity:</a> <a class="dataNameLabel">' + selectedNodeID + '</a>';
			//html += '<br/><a class="panelheader">Entity type</a>:<br/>' //+ labellist;
			html += '<table>'
			node.data.labels.forEach(function(label, index){
				if (index!=0){labellist += ', ';}
				var button_onclick = 'Neo4jDeleteLabel(' + node.id + ', \'' + label + '\')';
				html += '<tr>'
				html += '<td><button class="fortext tooltip" onclick="'+button_onclick+'" >X<div class="tooltiptext">delete label</div></button></td><td><a class="dataNameLabel">' + label + '</a></td>'	
				html += '</tr>'
			});
			html += '</table>'
			
			
			processingElement.innerHTML = html;
			
			html = '<a class="panelheader">Properties<a>:';
			html += '<table style="width:90%;">'
			var processingElement = document.getElementById('nodeDetails');
			node.data.properties.forEach(function(property, index){
				html += '<tr>'
				var button_onclick = 'showOnNode(\'' + node.id + '\', \'' + property.value + '\')';
				html += '<td><button class="fortext tooltip" onclick="'+button_onclick+'">O<div class="tooltiptext">display in node</div></button></td><td> <a class="dataNameLabel">' + property.key + '</a></td><td><a class="dataValueLabel"> ' + property.value + '</a></td>';
				html += '</tr>'
			});
			html += '</table>'
			processingElement.innerHTML = html;
			
			var updateElement = document.getElementById('new.entity.name');
			if (updateElement)
			{
				updateElement.value = node.data.labels[0];
			}
			//node.data.properties.forEach(function(property, index){
			//	html += '<tr>'
			//	var button_onclick = 'showOnNode(' + node.id + ', \'' + property.value + '\')';
			//	html += '<td><button class="fortext tooltip" onclick="'+button_onclick+'">O<div class="tooltiptext">display in node</div></button></td><td> <a class="dataNameLabel">' + property.key + '</a></td><td><a class="dataValueLabel"> ' + property.value + '</a></td>';
			//	html += '</tr>'
			//});
			
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function showLinkDetails(link)
		{
			var processingElement = document.getElementById('selectedLink');
			var labellist = ''
			var html = '<a class="panelheader">Selected Link:</a> <a class="dataNameLabel">' + link.data.id + '</a>';
			html += '<br/><a class="panelheader">Link type</a>: <a class="dataNameLabel">'+link.data.name+'</a>' 	
			processingElement.innerHTML = html;
			
			html = '<a class="panelheader">Properties<a>:';
			html += '<table style="width:90%;">'
			var processingElement = document.getElementById('linkDetails');
			link.data.properties.forEach(function(property, index){
				html += '<tr>'
				var button_onclick = 'showOnNode(' + link.data.id + ', \'' + property.value + '\')';
				html += '<td> <a class="dataNameLabel">' + property.key + '</a></td><td><a class="dataValueLabel"> ' + property.value + '</a></td>';
				html += '</tr>'
			});
			html += '</table>'
			processingElement.innerHTML = html;
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function highlightRelatedNodes(nodeId, isOn) {				   
		   // just enumerate all realted nodes and update link color:
		   GRAPH.forEachLinkedNode(nodeId, function(node, link){
			   var linkUI = graphics.getLinkUI(link.id);
			   if (linkUI) {
				   if (!link.data.checked) {
						linkUI.children[LINK_INDEX_0].attr('stroke', isOn ? '#cc3300' : link.data.color)
					}
			   }
		   });
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------		
		function highlightdescendantNodes(nodeId, isOn) {				   
		   // just enumerate all realted nodes and update link color:
		   var descendantNodes = [];
		   descendantNodes.push(nodeId);
		   var i = 0;
		   while (i < (descendantNodes.length))
		   {
				var descendantNode = getDataNode(descendantNodes[i]);
				descendantNode.data.toLinks.forEach(function(link){
					var linkUI = graphics.getLinkUI(link.id);
					if (linkUI) {
						if (!link.data.checked) {linkUI.children[LINK_INDEX_0].attr('stroke', isOn ? '#cc3300' : link.data.color)}
					}
				});
				
				descendantNode.data.toNodes.forEach(function (node){
					if (descendantNodes.indexOf(node.id)< 0){descendantNodes.push(node.id);}
				});
				
				i++;
		   }
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function highlightAncestorNodes(nodeId, isOn) {				   
		   var ancestorNodes = [];
		   ancestorNodes.push(nodeId);
		   var i = 0;
		   while (i < (ancestorNodes.length))
		   {
				var ancestorNode = getDataNode(ancestorNodes[i]);
				ancestorNode.data.fromLinks.forEach(function(link){
					var linkUI = graphics.getLinkUI(link.id);
					if (linkUI) {
						if (!link.data.checked) {linkUI.children[LINK_INDEX_0].attr('stroke', isOn ? '#cc3300' : link.data.color)}
					}
				});
				ancestorNode.data.fromNodes.forEach(function (node){
					if (ancestorNodes.indexOf(node.id)< 0){ancestorNodes.push(node.id);}
				});
				i++;
		   }
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function checkLink(link){
				showLinkData(link);
				link.data.UI.pathUI.attr('stroke-width', 5);
				link.data.UI.pathUI.attr('stroke', '#99ff33');
				link.data.checked = true;
				checkedLinks.push(link);
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function uncheckLink(link){
				hideLinkData(link);
				link.data.UI.pathUI.attr('stroke-width', 3);
				link.data.UI.pathUI.attr('stroke', link.data.color);
				link.data.checked = false;
				checkedLinks.map(function(l,index){if (l.data.id == link.data.id){checkedLinks.splice(index,1);}})
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function toggleLink(link, bvalue){
			if (bvalue == true && link.data.checked){return;}
			if (bvalue == false && !link.data.checked){return;}
			link.data.checked = !link.data.checked;
			if (link.data.checked) //link must be checked
			{
				checkLink(link);
			}
			else  //link must be unchecked
			{
				uncheckLink(link);
			}
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function highlightLink(link) { //...for mouse-hover only
			showLinkData(link);
			link.data.UI.pathUI.attr('stroke-width', 5);
			//link.data.UI.pathUI.attr('stroke', 'red');
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function unHighlightLink(link) { //...for mouse-hover only
			if (!link.data.checked){
				hideLinkData(link);
				link.data.UI.pathUI.attr('stroke-width', 3);
			}
			//link.data.UI.pathUI.attr('stroke', link.data.color);
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function hideLinkData(link)
		{
			link.data.UI.fullUI.attr('labelVisible','false');
			if (!link.data.displayingData){return;}
			link.data.displayingData = false;
			if(link.data.UI.nameTextUI){link.data.UI.nameTextUI.remove();}
			if(link.data.UI.subTextUI){link.data.UI.subTextUI.remove();}
			$(link.data.UI.fullUI).hide().show();
			//drawLink(link.data.UI.fullUI, {x:0,y:0}, {x:0,y:0});
		}
		
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function showLinkData(link)
		{
			link.data.UI.fullUI.attr('labelVisible','true');
			if (link.data.displayingData) {return;}
			link.data.displayingData = true;
			link.data.UI.nameTextUI = CommonUI.linkName.cloneNode();
			link.data.UI.nameTextUI.innerHTML = link.data.displayLabel;
			if(link.data.UI.midMarkerUI) {link.data.UI.midMarkerUI.append(link.data.UI.nameTextUI);}
			
			if(currentTheme.sourceConfig.displaySettings.showRelationProperties){			
				link.data.UI.subTextUI = CommonUI.linkProps.cloneNode();
				link.data.UI.subTextUI.innerHTML = propertyListToSvgList(link.data.properties, '<tspan x="0" dy="1.2em">', '</tspan>');
				if(link.data.UI.midMarkerUI) {link.data.UI.midMarkerUI.append(link.data.UI.subTextUI);}
			}
			fixTextWidth4Link(link);
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function checkNode(node)
		{
			checkedNodes.push(node);
				//if(node.data.UI.fullUI){node.data.UI.fullUI.attr('stroke','#99ff33');}
				if(!node.data.UI.checkUI){
					CommonUI.checkUI
						.attr('r', node.data.nodeSize + node.data.nodeSize/4)//...for circle
						.attr('stroke-width',node.data.nodeSize/5);
					node.data.UI.checkUI = CommonUI.checkUI.cloneNode();
					node.data.UI.fullUI.insertBefore(node.data.UI.checkUI, node.data.UI.bodyUI);
				}

				if (currentTheme.sourceConfig.displaySettings.loadNodePopouts){
					if (!node.data.UI.popoutBodyUI){loadNodePopout(node);}
					if(node.data.UI.popoutTextUI){
						node.data.UI.popoutTextUI.attr('class','showtext');
					}
					
				}
				
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function uncheckNode(node){

			if(node.data.UI.checkUI){
				node.data.UI.checkUI.remove();
				node.data.UI.checkUI = undefined;
			}
			if (currentTheme.sourceConfig.displaySettings.loadNodePopouts){
				if(node.data.UI.popoutTextUI){node.data.UI.popoutTextUI.attr('class','slidetext');}
			}
		}
		//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		function highlightSelectedNode(nodeId) {
		   
		   if (selectedNodeID != ''){
				if (nodeId == selectedNodeID) {return;} //...we've re-clicked the same node
				//DISPOSE PREVIOUS SELECTION
				//remove all sub nodes...
				if (config_ext.viewOptions.subnodes.relations=="ifany"){
					while (selectedNode.data.subNodes.length > 0){
						removeSubNode(selectedNode.data.subNodes[0], false);
						selectedNode.data.subNodes.splice(0,1);
					}
				};
				if (currentTheme.sourceConfig.displaySettings.showRelationships == "on-highlight" && !interactionOptions.checkNodes){
					//Remove previous selections visuals
					var relevantLinks = selectedNode.data.toLinks.concat(selectedNode.data.fromLinks);
					relevantLinks.forEach(function(link){
						unHighlightLink(link,false);
					});
				}
   
			   if (bRelate==true)
			   {
					if (nodeId != selectedNodeID){
						Neo4jCreateRelation(selectedNodeID, nodeId)
					}
					bRelate=false;
			   }
			   
			   if (bPlanRelate==true)
			   {
					if (nodeId != selectedNodeID){
						Neo4jCreateRelation(selectedNodeID, nodeId, true)
					}
					bPlanRelate=false;
			   }
			   
		   }
		   var node = GRAPH.getNode(nodeId);
		   if (interactionOptions.checkNodes){
				checkNode(node);
		   }
		   else{ //...not checking nodes...
			checkedNodes.forEach(function(nodex){
				uncheckNode(nodex);
			});
			checkedNodes = [];
		   }
		   
			//Display relationship details...
			node.data.toLinks.forEach(function(l){highlightLink(l,true)});
			node.data.fromLinks.forEach(function(l){highlightLink(l,true)});

			selectedNodeID = nodeId;
			selectedNodeData = node.data;
			selectedNode = node;
			selectedNode.data.UI.fullUI.insertBefore(CommonUI.focusUI, selectedNode.data.UI.bodyUI);
			selectedNode.data.UI.focusUI = CommonUI.focusUI
				.attr('r', node.data.nodeSize+ node.data.nodeSize/3)//...for circle
				.attr('stroke-width',node.data.nodeSize/5);

			if (!node.data.UI.popoutBodyUI)
			{
				loadNodePopout(node);
			}
			showNodeDetails(node);	

			//show sub nodes...
			if (config_ext.viewOptions.subnodes.relations=="ifany"){
				var diffCount = node.data.totalToLinks - node.data.toLinks.length;
				if (diffCount > 0) {
					addSubNode(node, 'subto' + node.id, '#80ffe5', diffCount);
				}
				diffCount = node.data.totalFromLinks - node.data.fromLinks.length;
				if (diffCount > 0) {
					addSubNode(node, 'subfrom' + node.id, '#99ccff', diffCount);
				}
			};
		}

		function loadNodePopout(node)
		{
			CommonUI.popoutTextUI.innerHTML = propertyListToSvgList(node.data.properties, '<tspan x="'+(node.data.nodeSize + 15)+'" dy="1.2em">', '</tspan>');
			
			node.data.UI.popoutBodyUI = CommonUI.popoutBodyUI.cloneNode(true);
			node.data.UI.fullUI.append(node.data.UI.popoutBodyUI);
			
			node.data.UI.popoutTextUI = CommonUI.popoutTextUI.cloneNode(true);
			node.data.UI.fullUI.append(node.data.UI.popoutTextUI);

			fixTextWidth4Node(node);
			node.data.UI.popoutBodyUI.attr('class', 'slidebody');
			node.data.UI.popoutTextUI.attr('class', 'slidetext');
		}
		//function fetchInfo(id) {
		//	var root = 'https://secure.gravatar.com/avatar/91bad8ceeec43ae303790f8fe238164b';
		//	return $.getJSON(root);
			//var root = 'https://secure.gravatar.com/avatar/' + node.data';
			//return $.getJSON(root + '/photos/' + id);
		//}
		
//========== graph ==================================================================================================================================================================		
		function main () {
			var graph = Viva.Graph.graph();
			
            //graph.addNode('anvaka', 'test1'); //'91bad8ceeec43ae303790f8fe238164b');
            //graph.addNode('indexzero',function(){var d = new Date(); return d.getTime() }()); // 'd43e8ea63b61e7669ded5b9d3c2e980f');
			//graph.addNode('asdasd', 'test3'); //'d43e8ea63b61e7669ded5b9d3c2e980f');
            //graph.addLink('anvaka', 'indexzero'); //'indexzero');
			//addDataNode

			// Custom physics... (include/exclude in the 'renderer' at the bottom of the script)
			var idealLength = 150;
			layout = Viva.Graph.Layout.forceDirected(graph, {
			   springLength: idealLength,
			   springCoeff : 0.00008,
			   //dragCoeff : 0.01,
			   //gravity : -1.2,
			   //theta : 1
			   springTransform: function (link, spring) {
                    spring.length = idealLength;// + link.data.connectionStrength;
               }
				  
			});

            graphics = Viva.Graph.View.svgGraphics();
                nodeSize = 24;
				
			
			//add static-type elements
			//var backgroundDataNode = new datax();
			//backgroundDataNode.id = 'backgroundImage';
			//backgroundDataNode.nodeType = 'window'
			//var backgroundNode = graph.addNode(backgroundDataNode.id, backgroundDataNode); //'91bad8ceeec43ae303790f8fe238164b');			
			//layout.pinNode(backgroundNode, true);
			
			//------------------------------------------------------------------------------------
			// we use this method to highlight all realted links
			// when user hovers mouse over a node:

			//------------------------------------------------------------------------------------
		
            //====== NODE DRAWING ========================================================================================================
			//Node elements...
			graphics.node(function(node) {		
				ui = Viva.Graph.svg('g');
				var cnf = node.data.sourceConfig.displaySettings;
				if (cnf.shadow) {ui.attr('filter','url(#shadowEffect)');} //shadow
				//Image elements...
				//img = Viva.Graph.svg('image')
                //     .attr('width', nodeSize)
                //     .attr('height', nodeSize)
                //     .link('https://secure.gravatar.com/avatar/' + node.data),
				if (node.data.nodeType == 'data')
				{
					var nodeConfig = node.data.config.nodeDisplayBody;
					if(nodeConfig.color){node.data.nodeColor = nodeConfig.color;}
					//Circle elements NODE-CIRCLE
					//circleGlow = Viva.Graph.svg('circle')
					//	.attr('cx', 0)
					//	.attr('cy', 0)
					//	.attr('r', node.data.nodeSize*1.7)
					//	.attr('fill','transparent');//node.data.nodeColor)//'#4dffc3')
					//if (cnf.glow) {circleGlow.attr('fill','url(#gradGlow)');}
					//if (!cnf.opaque) {circleGlow.attr('fill-opacity',0.5);}

					//rectblank = Viva.Graph.svg('rect')
					//	.attr('width', 0)
					//	.attr('height', 0);
						
					nodeBody = Viva.Graph.svg(cnf.entityShape)
						.attr('cx', 0)//...for circle
						.attr('cy', 0)//...for circle
						.attr('r', node.data.nodeSize) //...for circle
						.attr('fill',node.data.nodeColor)//node.data.nodeColor)//'#4dffc3')
						.attr('stroke-width',3)
						.attr('stroke', cnf.entityBorderColor==null?node.data.nodeBorderColor:currentTheme.entityBorderColor)
						
						//.attr('stroke-opacity',0.5);
						if (cnf.entityShape == "rect") {
							nodeBody.attr('width',node.data.nodeSize * 3);
							nodeBody.attr('height',node.data.nodeSize * 2);
							nodeBody.attr('rx',node.data.nodeSize/4);
							nodeBody.attr('x',-(node.data.nodeSize*3/2));
							nodeBody.attr('y',-(node.data.nodeSize*2/2));
						}
						if (cnf.haze) {nodeBody.attr('filter','url(#hazeEffect)');} //haze
						if (cnf.rounded) {nodeBody.attr('fill','url(#gradRound)');}
						if (!cnf.opaque) {nodeBody.attr('fill-opacity',cnf.entityOpacity);}
					
					nodeBodyImage = Viva.Graph.svg('image')
						.attr('x', -node.data.nodeSize)
						.attr('y', -node.data.nodeSize)
						.attr('rx', node.data.nodeSize)
						.attr('width', node.data.nodeSize * 2)
						.attr('height', node.data.nodeSize * 2)
						.link(nodeConfig.image?nodeConfig.image:'');
						if (cnf.rounded) {nodeBodyImage.attr('fill','url(#gradRound)');}
						if (!cnf.opaque) {nodeBodyImage.attr('fill-opacity',node.data.nodeOpacity);}
						
					//Text elements...
					displayText = Viva.Graph.svg('text')
						.attr('y', 0) 
						.attr('x', 0)
						.attr('fill',cnf.entityLabelColor)
						.attr('stroke-width','0')
						.attr('font-family','Arial, Helvetica, sans-serif')
						.attr('font-size','20')
						.text(node.data.displayLabel);
						/*
					popoutTextUI = Viva.Graph.svg('text')
						.attr('class', 'slidetext')
						.attr('y', -node.data.nodeSize) //node.data.nodeSize/2 + 5)
						.attr('x', 200)// - node.data.displayLabel.length)
						.attr('fill',cnf.entityPopoutTextColor)
						.attr('stroke-width','0')
						.attr('font-family','Arial, Helvetica, sans-serif')
						.attr('font-size','10')
						.text('--');
					popoutTextUI.innerHTML = propertyListToSvgList(node.data.properties, '<tspan x="50" dy="1.2em">', '</tspan>');

					popoutBodyUI = Viva.Graph.svg('rect')
                        .attr('class', 'slidebody')
                        .attr('x', node.data.nodeSize/2)
                        .attr('y', -node.data.nodeSize)
                        .attr('rx', 7)
                        .attr('height', 0)
						.attr('fill','#141414')
						.attr('width','20%')

                    if (!cnf.opaque) {popoutBodyUI.attr('fill-opacity',0.3);}
					*/
					
					//var defs = graphics.getSvgRoot().append('defs');
					//defs.append(midMarker);
						
					var visDefs = '<defs>';
					visDefs += '<filter id="hazeEffect" x="-1" y="-1" width="300%" height="300%"><feOffset result="offOut" in="FillPaint" dx="0" dy="0" /><feGaussianBlur result="blurOut" in="offOut" stdDeviation="10" /><feBlend in="SourceGraphic" in2="blurOut" mode="normal" /></filter>';
					visDefs += '<filter id="shadowEffect" x="-1" y="-1" width="300%" height="300%"><feOffset result="offOut" in="SourceAlpha" dx="20" dy="20" /><feGaussianBlur result="blurOut" in="offOut" stdDeviation="10" /><feBlend in="SourceGraphic" in2="blurOut" mode="normal" /></filter>';
					//visDefs += '<radialGradient id="gradGlow" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" style="stop-color:#ffffff; stop-opacity:1" /><stop offset="100%" style="stop-color:#66e0ff;stop-opacity:0" /></radialGradient>';
					visDefs += '<radialGradient id="gradRound" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="80%" style="stop-color:rgb('+node.data.nodeColorRGB.r+','+node.data.nodeColorRGB.g+','+node.data.nodeColorRGB.b+'); stop-opacity:1" /><stop offset="100%" style="stop-color:rgb('+(node.data.nodeColorRGB.r-100) +','+(node.data.nodeColorRGB.g-100)+','+(node.data.nodeColorRGB.b-100)+');stop-opacity:1" /></radialGradient>';
					visDefs += '</defs>'; 
					ui.innerHTML = visDefs;
					ui.attr('class', 'datanode')
					
					node.data.UI.fullUI = ui;
					node.data.UI.bodyUI = nodeBody;
					node.data.UI.imageUI = nodeBodyImage;
					node.data.UI.displayTextUI = displayText;
					//node.data.UI.popoutBodyUI = popoutBodyUI;
					//node.data.UI.popoutTextUI = popoutTextUI;

					//if (cnf.loadNodePopouts){ui.append(node.data.UI.bodyUI);}//else{ui.append(rectblank);}
					//if (cnf.loadNodePopouts){ui.append(node.data.UI.popoutBodyUI);}
					ui.append(node.data.UI.bodyUI);
					if (nodeConfig.image){ui.append(node.data.UI.imageUI);}
					//ui.append(node.data.UI.focusUI);
					if (cnf.showLabels){ui.append(node.data.UI.displayTextUI);}
					//if (cnf.loadNodePopouts){ui.append(node.data.UI.popoutTextUI);}
					
				//NODE EVENTS
					// events (http://www.w3.org/TR/SVG/interact.html#SVGEvents ),
					// including mouse events:
					$(ui).mousedown(function() { // MOUSE CLICK
						highlightSelectedNode(node.id);
						layout.pinNode(node, true);
						node.data.isPinned = true;
					}),
					//$(ui).mousedown(function() { // MOUSE CLICK
						//detailsUI.text = node.data.properties[0];
						//refreshNodeAppearance(detailsUI.attr('nodeid'));				
					//}),
					$(ui).dblclick(function() { // MOUSE CLICK
						Neo4jFetchEntitiesForNode(node.id, node.data.sourceConfig);	

				
					}),
					$(ui).hover(function() { // MOUSE HOVER
						if (viewOptions.highlightRelated){highlightRelatedNodes(node.id, true);}
						if (viewOptions.highlightdescendants){highlightdescendantNodes(node.id, true);}
						if (viewOptions.highlightAncestors){highlightAncestorNodes(node.id, true);}
					}, function() { // mouse out
						if (viewOptions.highlightRelated){highlightRelatedNodes(node.id, false);}
						if (viewOptions.highlightdescendants){highlightdescendantNodes(node.id, false);}
						if (viewOptions){highlightAncestorNodes(node.id, false);}
					});

				}
				else if (node.data.nodeType == 'window')
				//====== WINDOW NODES ========================================================================================================
				{

					/*
					//Circle elements NODE-CIRCLE
					circleGlow = Viva.Graph.svg('rect')
						.attr('x', -node.data.nodeSize *1.5)//...for rect
						.attr('y', -node.data.nodeSize*1.5)//...for rect
						.attr('width', node.data.width)//...for rect
						.attr('height', node.data.height)//...for rect
						.attr('fill','transparent')//node.data.nodeColor)//'#4dffc3')
						.attr('fill','url(#gradGlow)');

					windowBody = Viva.Graph.svg('rect')
						.attr('x', -node.data.nodeSize *1.5)//...for rect
						.attr('y', -node.data.nodeSize*1.5)//...for rect
						.attr('rx', node.data.nodeSize/4)//...for rect
						.attr('width', node.data.width)//...for rect
						.attr('height', node.data.height)//...for rect
						.attr('stroke-width','5')
						.attr('stroke-opacity','1')
						.attr('stroke-color','white')
					
					windowSelected = Viva.Graph.svg('rect')
						.attr('width','0')
						.attr('height','0');
						
					//Text elements...
					windowText = Viva.Graph.svg('text')
						.attr('y', -30) //node.data.nodeSize/2 + 5)
						.attr('x', node.data.nodeSize)// - node.data.displayLabel.length)
						.attr('fill','deepskyblue')
						.attr('stroke-width','0')
						.attr('font-family','Arial, Helvetica, sans-serif')
						.attr('font-size','10')
						.text(node.data.displayLabel);

					$(ui).click(function() { // MOUSE CLICK				
						//highlightSelectedNode(node.id);
						//layout.pinNode(node, true);
						//node.data.isPinned = true;
						
					}),
					ui.append(circleGlow);
					ui.append(windowBody);
					ui.append(windowSelected);
					ui.append(windowText);
					//ui.attr('id','NodeWindowX')
					ui.attr('id', node.id)
					//ui.attr('class','nodeWindow2');
					ui.attr('position', 'absolute');
					*/
					
					/*
					//processing window node...
					if (node.id == 'backgroundImage')
					{
						staticBackground = Viva.Graph.svg('image')
							.attr('nodetype', 'window')
							.attr('x', 0)
							.attr('y', 0)
							.attr('width', 500)
							.attr('height', 500)
							.link('custom/map.jpg');
						ui.append(staticBackground);
					}*/
				}
				//====== INDICATOR NODES ========================================================================================================
				else if (node.data.nodeType == 'subnode')
				{					
					var nodeConfig = node.data.config.nodeDisplayBody;
					if(nodeConfig.color){node.data.nodeColor = nodeConfig.color;}
					
					nodeBody = Viva.Graph.svg('circle')
						.attr('cx', 0)//...for circle
						.attr('cy', 0)//...for circle
						.attr('r', node.data.nodeSize) //...for circle
						.attr('fill',node.data.nodeColor)//node.data.nodeColor)//'#4dffc3')
						.attr('stroke-width',3)
						.attr('stroke', node.data.nodeColor)
					nodeBodyImage = Viva.Graph.svg('image')
						.attr('x', -node.data.nodeSize)
						.attr('y', -node.data.nodeSize)
						.attr('rx', node.data.nodeSize)
						.attr('width', node.data.nodeSize * 2)
						.attr('height', node.data.nodeSize * 2)
						.link(nodeConfig.image?nodeConfig.image:'');
						if (cnf.rounded) {nodeBodyImage.attr('fill','url(#gradRound)');}
						if (!cnf.opaque) {nodeBodyImage.attr('fill-opacity',node.data.nodeOpacity);}
						
					//Text elements...
					displayText = Viva.Graph.svg('text')
						.attr('y', 0) 
						.attr('x', 0)
						.attr('fill','black')
						.attr('stroke-width','0')
						.attr('font-family','Arial, Helvetica, sans-serif')
						.attr('font-size','20')
						.text(node.data.displayLabel);

					node.data.UI.fullUI = ui;
					node.data.UI.bodyUI = nodeBody;
					node.data.UI.imageUI = nodeBodyImage;
					node.data.UI.displayTextUI = displayText;

					ui.append(node.data.UI.bodyUI);
					if (nodeConfig.image){ui.append(node.data.UI.imageUI);}
					if (cnf.showLabels){ui.append(node.data.UI.displayTextUI);}
					
				//NODE EVENTS
					// events (http://www.w3.org/TR/SVG/interact.html#SVGEvents ),
					// including mouse events:
					$(ui).mousedown(function() { // MOUSE CLICK
						//highlightSelectedNode(node.id);
						node.data.UI.fullUI.attr('dragging', 'true');
					}),

					$(ui).mouseup(function() { // MOUSE CLICK
						node.data.UI.fullUI.attr('dragging', 'false');
						node.data.UI.fullUI.children[0].attr('r', node.data.nodeSize);
						fixTextWidth4Node(node);
						//var parentPos = layout.getNodePosition(node.data.superNodes[0].id);
						//var thisPos = layout.getNodePosition(node.id);
						//var distance = calculateDistance(parentPos, thisPos);
						//increaseNodeSize(node)
						//highlightSelectedNode(node.id);
					}),
					
					$(ui).dblclick(function() { // MOUSE CLICK
						//Neo4jFetchEntitiesForNode();				
					}),
					$(ui).hover(function() { // MOUSE HOVER
						//if (viewOptions.highlightRelated){highlightRelatedNodes(node.id, true);}
						//if (viewOptions.highlightdescendants){highlightdescendantNodes(node.id, true);}
						//if (viewOptions.highlightAncestors){highlightAncestorNodes(node.id, true);}
					}, function() { // mouse out
						//if (viewOptions.highlightRelated){highlightRelatedNodes(node.id, false);}
						//if (viewOptions.highlightdescendants){highlightdescendantNodes(node.id, false);}
						//if (viewOptions){highlightAncestorNodes(node.id, false);}
					});
					
					if (node.data.superNodes[0]){ui.attr('parentnodeid', node.data.superNodes[0].id)}
				}
				
				//====== PLANNED NODES ========================================================================================================
				if (node.data.nodeType == 'planned')
				{
					var nodeConfig = node.data.config.nodeDisplayBody;
					if(nodeConfig.color){node.data.nodeColor = nodeConfig.color;}

					nodeBody = Viva.Graph.svg('circle')
						.attr('cx', 0)//...for circle
						.attr('cy', 0)//...for circle
						.attr('r', node.data.nodeSize) //...for circle
						.attr('fill',node.data.nodeColor)//node.data.nodeColor)//'#4dffc3')
						.attr('stroke-width',3)
						.attr('stroke', cnf.entityBorderColor==null?node.data.nodeBorderColor:cnf.entityBorderColor)
						//.attr('stroke-opacity',0.5);
						if (cnf.haze) {nodeBody.attr('filter','url(#hazeEffect)');} //haze
						if (cnf.rounded) {nodeBody.attr('fill','url(#gradRound)');}
						if (!cnf.opaque) {nodeBody.attr('fill-opacity',node.data.nodeOpacity);}
					
					nodeBodyImage = Viva.Graph.svg('image')
						.attr('x', -node.data.nodeSize)
						.attr('y', -node.data.nodeSize)
						.attr('rx', node.data.nodeSize)
						.attr('width', node.data.nodeSize * 2)
						.attr('height', node.data.nodeSize * 2)
						.link(nodeConfig.image?nodeConfig.image:'');
						if (cnf.rounded) {nodeBodyImage.attr('fill','url(#gradRound)');}
						if (!cnf.opaque) {nodeBodyImage.attr('fill-opacity',node.data.nodeOpacity);}
						
					//Text elements...
					displayText = Viva.Graph.svg('text')
						.attr('y', 0) 
						.attr('x', 0)
						.attr('fill',cnf.entityLabelColor)
						.attr('stroke-width','0')
						.attr('font-family','Arial, Helvetica, sans-serif')
						.attr('font-size','20')
						.text(node.data.displayLabel);
						
					popoutTextUI = Viva.Graph.svg('text')
						.attr('class', 'slideText')
						.attr('y', -node.data.nodeSize) //node.data.nodeSize/2 + 5)
						.attr('x', 0)// - node.data.displayLabel.length)
						.attr('fill','#0077b3')
						.attr('stroke-width','0')
						.attr('font-family','Arial, Helvetica, sans-serif')
						.attr('font-size','10')
						.text('--');
					popoutTextUI.innerHTML = propertyListToSvgList(node.data.properties, '<tspan x="50" dy="1.2em">', '</tspan>');

					popoutBodyUI = Viva.Graph.svg('rect')
                        .attr('class', 'slideout')
                        .attr('x', node.data.nodeSize/2)
                        .attr('y', -node.data.nodeSize)
                        .attr('rx', node.data.nodeSize/4)
                        .attr('height', 0)
						.attr('fill','#141414')
                    if (!cnf.opaque) {popoutBodyUI.attr('fill-opacity',0.3);}
					
					
					//var defs = graphics.getSvgRoot().append('defs');
					//defs.append(midMarker);
						
					var visDefs = '<defs>';
					visDefs += '<filter id="hazeEffect" x="-1" y="-1" width="300%" height="300%"><feOffset result="offOut" in="FillPaint" dx="0" dy="0" /><feGaussianBlur result="blurOut" in="offOut" stdDeviation="10" /><feBlend in="SourceGraphic" in2="blurOut" mode="normal" /></filter>';
					visDefs += '<filter id="shadowEffect" x="-1" y="-1" width="300%" height="300%"><feOffset result="offOut" in="SourceAlpha" dx="20" dy="20" /><feGaussianBlur result="blurOut" in="offOut" stdDeviation="10" /><feBlend in="SourceGraphic" in2="blurOut" mode="normal" /></filter>';
					//visDefs += '<radialGradient id="gradGlow" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" style="stop-color:#ffffff; stop-opacity:1" /><stop offset="100%" style="stop-color:#66e0ff;stop-opacity:0" /></radialGradient>';
					visDefs += '<radialGradient id="gradRound" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="80%" style="stop-color:rgb('+node.data.nodeColorRGB.r+','+node.data.nodeColorRGB.g+','+node.data.nodeColorRGB.b+'); stop-opacity:1" /><stop offset="100%" style="stop-color:rgb('+(node.data.nodeColorRGB.r-100) +','+(node.data.nodeColorRGB.g-100)+','+(node.data.nodeColorRGB.b-100)+');stop-opacity:1" /></radialGradient>';
					visDefs += '</defs>'; 
					ui.innerHTML = visDefs;
					
					
					node.data.UI.fullUI = ui;
					node.data.UI.bodyUI = nodeBody;
					node.data.UI.imageUI = nodeBodyImage;
					node.data.UI.displayTextUI = displayText;
					node.data.UI.popoutBodyUI = popoutBodyUI;
					node.data.UI.popoutTextUI = popoutTextUI;

					//if (cnf.loadNodePopouts){ui.append(node.data.UI.bodyUI);}//else{ui.append(rectblank);}
					if (cnf.loadNodePopouts){ui.append(node.data.UI.popoutBodyUI);}
					ui.append(node.data.UI.bodyUI);
					if (nodeConfig.image){ui.append(node.data.UI.imageUI);}
					//ui.append(node.data.UI.focusUI);
					if (cnf.showLabels){ui.append(node.data.UI.displayTextUI);}
					if (cnf.loadNodePopouts){ui.append(node.data.UI.popoutTextUI);}
					
				//NODE EVENTS
					// events (http://www.w3.org/TR/SVG/interact.html#SVGEvents ),
					// including mouse events:
					$(ui).mousedown(function() { // MOUSE CLICK
						highlightSelectedNode(node.id);
						layout.pinNode(node, true);
						node.data.isPinned = true;
					}),
					//$(ui).mousedown(function() { // MOUSE CLICK
						//detailsUI.text = node.data.properties[0];
						//refreshNodeAppearance(detailsUI.attr('nodeid'));				
					//}),
					$(ui).dblclick(function() { // MOUSE CLICK
						Neo4jFetchEntitiesForNode(node.id, node.data.sourceConfig);				
					}),
					$(ui).hover(function() { // MOUSE HOVER
						if (viewOptions.highlightRelated){highlightRelatedNodes(node.id, true);}
						if (viewOptions.highlightdescendants){highlightdescendantNodes(node.id, true);}
						if (viewOptions.highlightAncestors){highlightAncestorNodes(node.id, true);}
					}, function() { // mouse out
						if (viewOptions.highlightRelated){highlightRelatedNodes(node.id, false);}
						if (viewOptions.highlightdescendants){highlightdescendantNodes(node.id, false);}
						if (viewOptions){highlightAncestorNodes(node.id, false);}
					});
				}
				
				ui.attr('class','node');
				ui.attr('nodeSize',node.data.nodeSize);
				ui.attr('nodeid',node.id);
				ui.attr('dragging', false);
				ui.attr('nodetype',node.data.nodeType);
                return ui;
            });
			
			//====== NODE DRAWING/RENDERING ...occurs continuously ========================================================================================================
			graphics.placeNode(function(nodeUI, pos) {
                //nodeUI.attr('x', pos.x - nodeSize / 2).attr('y', pos.y - nodeSize / 2);
				var nodesize = nodeUI.attr('nodeSize');
				var nodeid = nodeUI.attr('nodeid');
				var nodetype = nodeUI.attr('nodetype');
				var nodeDragging = nodeUI.attr('dragging');
				//if (nodetype != 'window'){
				nodeUI.attr('transform','translate(' +(pos.x) + ',' + (pos.y) + ')');
				
				if (nodeDragging == 'true' && nodetype=='subnode')
				{
					var parentNodeId = nodeUI.attr('parentnodeid')
					var parentPos = layout.getNodePosition(parentNodeId);
					var thisPos = layout.getNodePosition(nodeid);
					var distance = calculateDistance(parentPos, thisPos);
					
					nodeUI.children[0].attr('r', distance/5);
					//nodeUI.children[1].text(Math.ceil(distance/5)+'%');
					fixTextWidth4Node(GRAPH.getNode(nodeid));
				}
				//}
				//else
				//{
					//nodeUI.attr('transform','translate(' +(pos.x) + ',' + (pos.y) + ')');
					//nodeUI.attr('transform','translate(' +(pos.x) + ',' + (pos.y) + ')');
				//}
				//if (nodeid == selectedNodeID)
				//{					
					//detailsUI.attr('transform','translate(' +(pos.x) + ',' + (pos.y) + ')');
				//}
				
				
            });

			//====== LINKS ========================================================================================================
			// To render an arrow we have to address two problems:
            //  1. Links should start/stop at node's bounding box, not at the node center.
            //  2. Render an arrow shape at the end of the link.

            // Rendering arrow shape is achieved by using SVG markers, part of the SVG
            // standard: http://www.w3.org/TR/SVG/painting.html#Markers
			
			//** COMMON REFERENCES ************************************************		
			//MARKER: TRAINGLE
			var markerTraingle = Viva.Graph.svg('marker')
                               .attr('id', 'Triangle')
                               .attr('viewBox', "0 0 10 10")
                               .attr('refX', "30")
                               .attr('refY', "5")
                               .attr('refY', "5")
                               .attr('markerUnits', "userSpaceOnUse")
                               .attr('markerWidth', "10")
                               .attr('markerHeight', "10")
                               .attr('orient', "auto")
							   
            var markerArrow =  Viva.Graph.svg('path')
				.attr('d', 'M 0 0 L 12 5 L 0 10 z')
				.attr('fill',currentTheme.sourceConfig.displaySettings.linkColor);
            markerTraingle.append(markerArrow)
			
							   
			//MARKER: DOUBLE-DASH
			var markerDoubleDash = Viva.Graph.svg('marker')
				.attr('id', 'DoubleDash')
				.attr('viewBox', "-4 -6 8 12")
				.attr('refX', "-20")
                .attr('refY', "0")
				.attr('markerWidth', "20")
                .attr('markerHeight', "20")
				.attr('markerUnits', "userSpaceOnUse")
				.attr('orient', "auto");
			var markerrect1 = Viva.Graph.svg('rect')
					.attr('x', '-3')
					.attr('y', '-5')
					.attr('width', '2')
					.attr('height', '10')
					.attr('fill',currentTheme.sourceConfig.displaySettings.linkColor);
			var markerrect2 = Viva.Graph.svg('rect')
					.attr('x', '1')
					.attr('y', '-5')
					.attr('width', '2')
					.attr('height', '10')
					.attr('fill',currentTheme.sourceConfig.displaySettings.linkColor);
			markerDoubleDash.append(markerrect1);
			markerDoubleDash.append(markerrect2);
			
			// Marker should be defined only once in <defs> child element of root <svg> element:
            var defs = graphics.getSvgRoot().append('defs');
            defs.append(markerTraingle);
			defs.append(markerDoubleDash);
			
			//LINKS SETUP (occurs once for every link...)
            //** UNIQUE REFERENCES ************************************************
			graphics.link(function(link){ //...get called for every link
				//====== DATA LINKS ========================================================================================================
				if (link.data.linkType == 'data')
				{
					var linklabelId = link.data.id;//'link'+link.fromId + 'To' + link.toId;
					if (link.data.sourceConfig.displaySettings.showRelationships == "all" || link.data.sourceConfig.displaySettings.showRelationships == "on-highlight")
					{

						//MARKER: TEXT
						var midMarker = Viva.Graph.svg('marker')
							.attr('class', 'markertextmain')
							.attr('id', 'mid'+linklabelId )
							.attr('viewBox', "-4 -6 8 12")
							.attr('refX', "0")
							.attr('refY', "0")
							.attr('markerWidth', "500")
							.attr('markerHeight', "100")
							.attr('markerUnits', "userSpaceOnUse")
							.attr('orient', "auto");
						
						//MARKER: ARROW
						var endMarker = Viva.Graph.svg('marker')
							//.attr('class', 'markertextmain')
							.attr('id', 'end'+linklabelId )
							.attr('viewBox', "-4 -6 8 12")
							.attr('refX', "0")
							.attr('refY', "0")
							.attr('markerWidth', "50")
							.attr('markerHeight', "100")
							.attr('markerUnits', "userSpaceOnUse")
							.attr('orient', "auto");
							
						var endArrow =  Viva.Graph.svg('path')
							.attr('stroke-width',0)
							.attr('d', 'M 0 -0.7 L 2 0 L 0 0.7 z')
							.attr('fill',link.data.color);
							if (!link.data.sourceConfig.displaySettings.opaque) {endArrow.attr('opacity', 0.5);}
							//markerTraingle.append(markerArrow)
						/*var markerLabel = Viva.Graph.svg('text')
								.attr('class','markertextlabel')
								.attr('x', '0')
								.attr('y', '0')
								.attr('fill',link.data.sourceConfig.displaySettings.linkMainTextColor)
								.attr('font-family','Arial, Helvetica, sans-serif')
								.attr('font-size','1.5')
								.text(link.data.name);
						if (link.data.sourceConfig.displaySettings.showRelationships == "on-highlight") {markerLabel.attr('fill','transparent')}
						
						
						//var propertyList = link.data.properties.forEach(function(prop){var x = ''; prop})
						var markerProperties = Viva.Graph.svg('text')
								.attr('class','markertextsub')
								.attr('x', '0')
								.attr('y', '.5')
								.attr('fill',link.data.sourceConfig.displaySettings.linkSubTextColor)
								.attr('font-family','Arial, Helvetica, sans-serif')
								.attr('font-size','1')
								.text('');
						markerProperties.innerHTML = propertyListToSvgList(link.data.properties, '<tspan x="0" dy="1.2em">', '</tspan>');
						
						if (link.data.sourceConfig.displaySettings.showRelationships == 'all'){
							midMarker.append(markerLabel);
							if (link.data.sourceConfig.displaySettings.showRelationProperties){midMarker.append(markerProperties);}
						}
						*/
						
						endMarker.append(endArrow);
						var defs = graphics.getSvgRoot().append('defs');
						defs.append(midMarker);
						defs.append(endMarker);

						link.data.UI.midMarkerUI = midMarker;
						link.data.UI.toMarkerUI = endMarker;
						//link.data.UI.nameTextUI = markerLabel; //...only added when markder is highlighted
						//link.data.UI.subTextUI = markerProperties;
					}

					var linkPath;
					var ui = Viva.Graph.svg('g')
					.attr('class','link')
					//.attr('refX', '50')
					//.attr('refY', '50')
					
					var linkPath = Viva.Graph.svg('path')
							   .attr('class','linkpath')
							   .attr('id',linklabelId)
							   .attr('stroke', link.data.color)
							   .attr('stroke-width', '3')
							   .attr('marker-mid', 'url(#mid' + linklabelId + ')')
							   //.attr('marker-end', 'url(#Triangle)')
							   .attr('marker-end', 'url(#end' + linklabelId + ')')
							   .attr("fill", 'transparent');
							   if (!link.data.sourceConfig.displaySettings.opaque) {linkPath.attr('stroke-opacity', 0.5);}

							   
					var linkPoputText = Viva.Graph.svg('text')
								.attr('class','linkPoputText')
								.attr('x',0)
								.attr('y',0)
								.attr('fill','#EB6A00')
								.attr('refx', '25')
								.attr('refy', '0')
								.attr('stroke-width', 0)
								.attr('font-family','Arial, Helvetica, sans-serif')
								.attr('font-size','10')
								.text('');
					/*
					var endArrow =  Viva.Graph.svg('path')
								.attr('stroke-width',3)
								.attr('d', 'M 0 -2 L 4 0 L 0 2 z')
								.attr('fill',link.data.color)
								.attr('stroke','red')*/

					var textwidth = 0;
					var proplist = ''; 
					link.data.properties.forEach(function(prop){
							linkPoputText.innerHTML += '<tspan dx="-' + textwidth + 'em" dy="1.5em" >' + prop.key + ": " + prop.value+  '</tspan>';
							textwidth = 5;
					});

					var linkRect = Viva.Graph.svg('rect')
								.attr('class','linkrect')
								.attr('refx', '30')
								.attr('width', '150')
								.attr('height', '25')
								.attr('fill','black')
								.attr('rx','5');
					//linkRect.attr('refy', Number(linkRect.attr('width'))/2 );
					//linkPoputText.attr('refy', Number(linkRect.attr('width'))/2 );
					//linkPath.innerHTML += '<text font-family="Verdana" font-size="42.5"><textPath xlink:href="#'+linklabelId+'">HELLO</textPath></text>';
					//linkPath.append('defs');

					ui.append(linkPath);
					//ui.append(endArrow);
					if (link.data.sourceConfig.displaySettings.loadRelationPopouts)
					{
						ui.append(linkRect);
						ui.append(linkPoputText);
					}

					$(linkPath).hover(function() { // MOUSE HOVER
						//markerLabel.attr('fill', 'yellow');
						if (link.data.checked){}
						//highlightLink(link);
					}, function() { // mouse out
						//unHighlightLink(link);
					});
					
					$(linkPath).click(function() { // MOUSE CLICK
						showLinkDetails(link);
						toggleLink(link);
					});
					
					
					link.data.UI.fullUI = ui;
					link.data.UI.pathUI = linkPath;
					link.data.UI.popoutBodyUI = linkRect;
					link.data.UI.popoutTextUI = linkPoputText;
					
					//var linkUI = graphics.getLinkUI(link.id);
					if (link.data.linkType == 'data'){
						ui.attr('fromNode',link.data.fromNodeID).attr('toNode',link.data.toNodeID);
						ui.attr('linkDataIndex',linkList.length);//default
					}
					ui.attr('fromNodeRadius',25); //default
					ui.attr('toNodeRadius',25);//default
					ui.attr('labelWidth',30);//default
					ui.attr('labelVisible',false);//default
					
					//ui.attr('linkPos', getDataLinks(link.data.fromNodeID, link.data.toNodeID).length);//will be adjusted later				
				
				
				}
				//====== INDICATOR LINKS ========================================================================================================
				else if(link.data.linkType == 'sub')
				{
					var linklabelId = link.data.id;//'link'+link.fromId + 'To' + link.toId;

					var linkPath;
					var ui = Viva.Graph.svg('g')
					.attr('class','link')
					var linkPath = Viva.Graph.svg('path')
							   .attr('id',linklabelId)
							   .attr('stroke', link.data.color)
							   .attr('stroke-width', '1')
							   .attr("fill", 'transparent');
							   if (!link.data.sourceConfig.displaySettings.opaque) {linkPath.attr('stroke-opacity', 0.5);}

					ui.append(linkPath);
					link.data.UI.fullUI = ui;
					link.data.UI.pathUI = linkPath;
					ui.attr('fromNodeRadius',25); //default
					ui.attr('toNodeRadius',25);//default
					ui.attr('labelWidth',30);//default
					ui.attr('labelVisible',false);//default
				}	
				//====== planned LINKS ========================================================================================================
				else if(link.data.linkType == 'planned')
				{
					var linklabelId = link.data.id;//'link'+link.fromId + 'To' + link.toId;

					var linkPath;
					var ui = Viva.Graph.svg('g')
					.attr('class','link')
					var linkPath = Viva.Graph.svg('path')
							   .attr('id',linklabelId)
							   .attr('stroke', link.data.color)
							   .attr('stroke-width', 5)
							   .attr("fill", 'transparent');
							   if (!link.data.sourceConfig.displaySettings.opaque) {linkPath.attr('stroke-opacity', 0.5);}

					ui.append(linkPath);
					link.data.UI.fullUI = ui;
					link.data.UI.pathUI = linkPath;
					ui.attr('fromNodeRadius',25); //default
					ui.attr('toNodeRadius',25);//default
					ui.attr('labelWidth',30);//default
					ui.attr('labelVisible',false);//default
					
				}
				
				ui.attr('linkType', link.data.linkType);
				return ui;   
            })
			
			//LINKS DRAWING/RENDERING (occurs continuously for every link...)
			//var geom = Viva.Graph.geom();
			graphics.placeLink(function(linkUI, fromPos, toPos) {
				var linkIndex = linkUI.attr('linkPos');

				var from = fromPos;
				var to = toPos;

				to.x = to.x - from.x;
				to.y = to.y - from.y;

				var skew = (linkIndex) *20 *(((linkIndex)%2 == 0)?-1:1); //...creates a bend in the middle for multiple relationships
				//var curvex = from.x + (to.x - from.x)/2; //...the middle point x
				//var curvey = from.y + (to.y - from.y)/2 + skew;//...the middle point y
				var curvex = (to.x)/2; //...the middle point x
				var curvey = (to.y)/2 + skew;//...the middle point y
				linkUI.attr('transform','translate(' +fromPos.x + ',' + fromPos.y + ')');

				var linkPath = linkUI.children[LINK_INDEX_0];
				
				for (var i = 0; i < linkUI.children.length; i++)
				{
					var child = linkUI.children[i];
					if (!child) continue;
					if (!child.attr) continue;
					if (!child.attr('refx')) continue;
					child.attr('x',curvex - child.attr('refx'));
					child.attr('y',curvey - child.attr('refy'));
					for (var h = 0; h < child.children.length; h++)
					{
						if (!child.children[h]) continue;
						//if (!child.children[h].attr) continue;
						//if (!child.children[h].attr('x')) continue;
						//child.children[h].attr('x', curvex);
					}
				}
				//linkUI.children.forEach(function (child){ 
				//	if (child.attr('refx'))
				//	{
				//		child.attr('x',to.x - Number(child.attr('refx')));
				//		child.attr('y',to.y - Number(child.attr('refy')));
				//	}
				//})
				var distance = Math.sqrt(Math.pow(to.x,2) + Math.pow(to.y,2));
				var data;
				if (linkIndex == 0)
				{
					data = 'M '+0+' '+0+' L '+curvex + ' '+curvey + ' L '+to.x + ','+to.y;
					
				}else{
					//var multiplier = (((linkIndex)%2 == 0)?-1:1);
					
					var arc = linkIndex*(distance);
					//For angled lines, with marker...
					//For curvey lines, but marker won't show...
					//var data = 'M '+0+' '+0+' q '+curvex + ' '+curvey + ' ' + to.x + ' ' + to.y;
					data = 'M0,0 A' +arc +','+arc +' 0 0,0 ' +to.x+','+to.y;
				}
				linkPath.attr("d", data);			
				linkPath.attr("stroke-dasharray", "0,0");
				
				var fromNodeRadius = Number(linkUI.attr('fromNodeRadius'));
				var toNodeRadius = Number(linkUI.attr('toNodeRadius'));
				if (linkIndex == 0 ){
					var linkTextWidth = 0;
					if (linkUI.attr('labelVisible') == 'true') {linkTextWidth = Number(linkUI.attr('labelWidth')) * 10;}
					
					var firstSegment = ((distance/2) - (fromNodeRadius + 5)) - (linkTextWidth/2);
					var secondSegment = ((distance/2) - (toNodeRadius + 10)) - (linkTextWidth/2);
					//set the dash-pattern of the path, to exclude the node space, and the text space...
					linkPath.attr("stroke-dasharray", "0," + (fromNodeRadius + 5) + "," + firstSegment + ","+ linkTextWidth + "," + secondSegment + "," + (toNodeRadius +10) + ",0");
				}
				
				
				//Place arrow marker...
				var linkDataIndex = linkUI.attr('linkDataIndex');			
				if (linkDataIndex){
					var rad = toNodeRadius/6.5 + 2.4 //...'2' is the height of the triangle
					if(linkList[Number(linkDataIndex)]){linkList[Number(linkDataIndex)].data.UI.toMarkerUI.attr('refX', rad);}
				}
				
				if (linkUI.attr('linkType') == 'planned'){linkPath.attr("stroke-dasharray", "5,5");}
				//if (linkUI)
				//linkPath.attr("stroke-dasharray", "0,40,50, 2, 10");
            
			});
			
			//==============================================================================================================
			//graphics.graphCenterChanged(function(x,y){
			
				//if (!graphContainer){return;}
				//graphContainer.style['background-position'] = x + 'px '+ y +'px';
				
			//});
				
			
			
            //graphics.link(function(link){
            //    return Viva.Graph.svg('path')
            //                  .attr('stroke', 'black');
			//				  //.attr('stroke-width', '2');
            //}).placeLink(function(linkUI, fromPos, toPos) {
            //    var data = 'M' + fromPos.x + ',' + fromPos.y +
            //               'L' + toPos.x + ',' + toPos.y;
            //    linkUI.attr("d", data);
            //})

            // Finally render the graph with our customized graphics object:
            renderer = Viva.Graph.View.renderer(graph, {
              layout   : layout, //Exclude custom physics
              graphics   : graphics,
              renderLinks : true,
              prerender  : true,
			  container : document.getElementById('graphContainer')
            });
			
			//var renderer2 = Viva.Graph.View.renderer(graph, {
			//  container : document.getElementById('schemaContainer')
            //});
			
			GRAPH = graph;
            renderer.run();
//========== STARTUP SETTINGS ===========================================================================================================================================================================
			graphContainer = document.getElementById('graphContainer')
			graphContainer.style.background=currentTheme.sourceConfig.displaySettings.graphBackground;
			//detailsUI = addWindowNode();
			if (currentTheme.sourceConfig.displaySettings.backgroundImage!=null){
				graphContainer.style['background-image'] =  'url('+currentTheme.sourceConfig.displaySettings.backgroundImage+')'
			};
				
//=========== ANIMATION ==========================================================================================================================================================================
		
				
		
//=====================================================================================================================================================================================
   
		}
		

    </script>

    <style type="text/css" media="screen">
        html, body { width: 100%; height: 100%; background-color: #3a3a3a;}
	
		body{
			height: 100%;
			width: 100%;
			position: absolute;
			overflow: hidden;
			left: 0;
			top: 0;
		  }
	
		svg, #graphContainer, #schemaContainer { 
			width: 100%; 
			height: 100%; 
			margin: 0px;
			float:left;
		}

		.node{
			opacity.5;
		}
		
		//.slideout {
		//	width:0px;
		//	transition: width 0.2s linear;
		//}
		//.slideText{
		//	opacity:0;
		//	transition: opacity 0.2s linear;
		//}	
		
		//* Chrome, Safari, Opera */
		@-webkit-keyframes dropeffect {
			from {opacity: .7;stroke-width:10;}
			to {opacity: 0;r:150px;stroke-width:5;}
		}
		@keyframes dropeffect {
			from {opacity: .7; stroke-width:10;}
			to {opacity: 0; r:150px; stroke-width:5;}
		}
		.droplet {
			opacity: 0;
			-webkit-animation: dropeffect 2s 1;
			animation: dropeffect 2s 1;
		}
		
		//* Chrome, Safari, Opera */
		@-webkit-keyframes rotation {
		  from {
			-webkit-transform: rotate(0deg);
		  }
		  to {
			-webkit-transform: rotate(360deg);
		  }
		}
		@keyframes rotation {
		  from {
			transform: rotate(0deg);
		  }
		  to {
			transform: rotate(360deg);
		  }
		}
		.rotatee {
			-webkit-animation: rotation 3s infinite linear;
			animation: rotation 3s infinite linear;
		}

		
		.node [class=slidebody]{
			width:0px;
			transition: width 0.2s linear;
		}
		.node:hover [class=slidebody]{
			width:inherit;
			transition: width 0.2s linear;
		}
		.node [class=slidetext]{
			opacity:0;
			transition: opacity 0.2s linear;
		}
		.node:hover [class=slidetext]{
			opacity:1;
			transition: opacity 0.2s linear;
		}

		////* Chrome, Safari, Opera */
		//@-webkit-keyframes widen {
		//	from {width:0px;}
		//	to {width:150px;}
		//}
		//@keyframes widen {
		//	from {width:0px;}
		//	to {width:150px; }
		//}
		//.popoutbox {
		//	-webkit-animation: widen .5s 1 linear;
		//	animation: widen .5s 1 linear;
		//}
		
		
		//.showNodePopoutBox {
		//	width:100px;
		//	transition: width 2s linear;
		//}
		//.hideNodePopoutBox {
		//	width:0px;
		//	transition: width 0.2s linear;
		//}
		//.showNodePopoutText {
		//	opacity:1;
		//	transition: opacity 0.2s linear;
		//}
		//.hideNodePopoutText {
		//	opacity:0;
		//	transition: opacity 0.2s linear;
		//}
		
		
		.link{
		}
		.link text{
			opacity:0;
			transition: opacity 0.2s linear;
		}
		.link rect{
			opacity:0;
			transition: opacity 0.2s linear;
		}
		.link:hover text{
			opacity:1;
			transition: width opacity 0.2s linear;
		}
		.showtext{
			opacity:1;
		}
		
		.link rect{
			opacity:.5;
			width:150px;
			height:0px;
			transition: width 0.2s linear;
		}
		.link:hover rect{
			height:50px;
			transition: height 0.2s linear;
		}
		
		.linkpath{
		}
		.linkpath:hover{
			transition: color stroke-width 0.2s linear;
		}
		.linkPoputText{

		}
		.linkPoputText:hover{

		}

		.markertextsub{
			opacity:1;
		}
		.markertextlabel{
			opacity:1;
		}
		
		.label {
			font-size: 12px;
			font-family: Verdana;
			font-weight: bold;
			cursor:pointer;
		}
		  
		  
		  #labelSelectorPanel {
			width:130px;
			//margin-top:5px;
			//margin-left:5px;
			padding:5px;
			border-style:solid;
			border-width:0px;
			border-color:#4d4d4d;
			color: #1a1a1a;
			background-color: #4d4d4d;
			background-opacity: 0.5;
			border-radius:15px;
			text-align: center;
		  }
		  .clearfix {
			//overflow-y: scroll;
		  }
		  
		  [draggable] {
			  -moz-user-select: none;
			  -khtml-user-select: none;
			  -webkit-user-select: none;
			  user-select: none;
			  /* Required to make elements draggable in old WebKit */
			  -khtml-user-drag: element;
			  -webkit-user-drag: element;
			}

		  .toolPanel {
			width:200px;
			margin:5px;
			margin-left:5px;
			padding:5px;
			border-style:solid;
			border-width:2px;
			border-color:#0d0d0d;
			color: deepskyblue;
			background-color:#1a1a1a;
			border-radius:10px;
			font-family:"Palatino Linotype", "Book Antiqua", Palatino, serif;
			font-size: 12px;
			letter-spacing: 0px;
			opacity:0.9;
			//font-family: Arial, Helvetica, sans-serif;
			//font-family: Verdana;
			//font-family:"Arial Black", Gadget, sans-serif;			
			//font-weight: bold;
			//font-family:"Lucida Console", Monaco, monospace;
		  }

		  .clearfix {
		  }
		  .panelheader {
			margin:0px;
			margin-bottom:5px;
			padding:0px;
			font-size: 10px;
			color: deepskyblue;
			text-decoration: underline;
			float:top;
			letter-spacing: 1px;
		  }
			.dataNameLabel{
				color: #ff6600;
			}
			.dataValueLabel{
				color: #ffc299;
			}
			.labelSelectorDisplay
			{
				overflow-y: auto;
				overflow-x: hidden;
				max-height: 200px;
			}

		  #leftColumn {
			left:10px;
			top:50px;
			width:250px;
			margin:0px;
			padding:0px;
			border-width:0px;
			max-height: 92%;
			overflow: auto;
			position: fixed;
		  }
		  
		  #rightColumn {
			top:50px;
			right:0px;
			width:230px;
			margin:0px;
			padding:0px;
			border-width:0px;
			overflow: auto;
			max-height: 92%;
			position: fixed;
		  }
		  
		  #noColumn {
			visibility: hidden;
		  }
		  
		  #topBar {
			top:5px;
			//left:20px;
			right: 100px;
			height:27px;
			margin-right:15px;
			margin-left:10px;
			padding:5px;
			border-style:solid;
			border-width:2px;
			border-color:#cccccc;
			color: deepskyblue;
			background-color:#a6a6a6;
			border-radius:5px;
			font-family:"Palatino Linotype", "Book Antiqua", Palatino, serif;
			font-size: 12px;
			letter-spacing: 0px;
			opacity:0.7;
		  }
		  .over {
			background-color:red;
			border: 2px dashed #000;
		  }
		  
		  #graphPanel {
			top:0px;
			left:0px;
			width:100%;
			height:100%;
			margin:0px;
			padding:0px;
			border-width:0px;
			background-color: #1a1a1a;
			position: fixed;
		  }
		  .clearfix {
			//overflow: none;
		  }
button {
    background-color: #b3b3b3; 
    color: black; 
	height: 20px;
    border: none;
    text-align: top;
    text-decoration: none;
    display: inline-block;
    font-size: 10px;
    margin: 3px 1px;
    -webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
    cursor: pointer;
	border-radius: 3px;
}

button:hover {
    background-color: #00a3cc; 
    color: white;
}
.toolPanelIcon{
	background-color: #4d4d4d; 
	text-align: center;
	color: #f2f2f2;
	margin: 0px 3px;
	height: 25px;
	width: 25px;
	padding: 2px 2px 2px 2px;
	border-radius: 3px;
	right: 0px;
}
.fortext {
	text-align: center;
	margin: 0px 5px;
	height: 15px;
	width: 15px;
	padding: 2px 2px 2px 2px;
	border-radius: 6px;
	right: 0px;
}
.forlabelselector {
	text-align: center;
	margin: 0px 5px;
	height: 15px;
	min-width: 15px;
	padding: 2px 2px 2px 2px;
	border-radius: 5px;
	right: 0px;
}
.paneloption {
	text-align: center;
	margin: 0px 5px;
	height: 12px;
	width: 12px;
	padding: 0px;
	background-color: #1a1a1a;
	color:gray;
}

/* Tooltip container */
.tooltip {
    position: relative;
	outline:0;
    display: inline-block;
}
/* Tooltip text */
.tooltip .tooltiptext {
    visibility: hidden;
    width: 120px;
    background-color: #555;
    color: #fff;
    text-align: center;
    padding: 5px 0;
    border-radius: 6px;

    /* Position the tooltip text */
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -60px;

    /* Fade in tooltip */
    opacity: 0;
    transition: opacity 1s;
}

/* Tooltip arrow */
.tooltip .tooltiptext::after {
    content: "";
    position: relative;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #555 transparent transparent transparent;
	position: absolute;
}
/* Show the tooltip text when you mouse over the tooltip container */
.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}



/* popup container */
.popup {
    position: relative;
	outline:0;
    display: inline-block;
}
/* popup text */
.popup .popuptext {
    visibility: hidden;
    width: 120px;
    background-color: #555;
    color: #fff;
	font-size:15px;
    text-align: left;
	list-style-type: circle;
    padding: 5px;
    border-radius: 6px;

    /* Position the popup text */
    position: absolute;
    z-index: 0;
    bottom: 100%;
    left: 50%;
    margin-left: -20px;
	
    /* Fade in popup */
    opacity: 0;
    transition: opacity 1s;
}


/* Show the popup text when you mouse over the popup container */
.popup:hover .popuptext {
    visibility: visible;
    opacity: 1;
}

input {
	width:100px;
	height:12px;
	margin:2px;
	border-radius: 6px;
	background-color: #b3ffff;
	border-color: transparent;
	font-size:12px;
}
.check{width:10px;}
.dynamic{
	background-color: #1a1a1a;
	margin-top:2px;
	height:15px; 
	border-width: 1px;
	border-color: black;
	color: gray;
	width: 80px;
}
.dynamic2
{
	width:80px;
	height:12px;
	margin:2px;
	border-radius: 6px;
	background-color: #b3ffff;
	border-color: transparent;
	font-size:12px;
	
}

select {
	width:100px;
	height:18px;
	margin:2px;
	border-radius: 6px;
	background-color: #b3ffff;
	border-color: transparent;
    font-size:12px;
}

#hovertext:hover {
	font-size: 15px;
	text-decoration: underline;
}

dialog {
	width:400px;
	height:200px;
	//margin:5px;
	//margin-left:10px;
	padding:10px;
	border-style:solid;
	border-width:2px;
	border-color:#0d0d0d;
	color: deepskyblue;
	background-color:#4d4d4d;
	border-radius:10px;
	background-opacity:0.8;
	font-family:"Palatino Linotype", "Book Antiqua", Palatino, serif;
	font-size: 12px;
	letter-spacing: 0px;
}
dialog textarea{
	resize: none;
	//margin:5px;
	border-radius:5px;
	background-color:#4d4d4d;
	color:white;
	width:98%;
	//max-width:190px;
	height:85%;
	//max-height:90%;
}

hr {
	border-color:#262626; 
	margin:0px;
}

#slider {
    //position: absolute;
    width: 100px;
    height: 100px;
    //background: blue;
    //transform: translateX(-100%);
    //-webkit-transform: translateX(-100%);
	transform: scaleY(0);
    -webkit-transform: scaleY(0);
	
}


.slide-in {
    animation: slide-in 0.5s forwards;
    -webkit-animation: slide-in 0.5s forwards;
}

.slide-out {
    animation: slide-out 0.5s forwards;
    -webkit-animation: slide-out 0.5s forwards;
}
    
@keyframes slide-in {
	100% { transform: scaleY(0);}
	
    //100% { transform: translateX(0%); }
}

@-webkit-keyframes slide-in {
	100% { -webkit-transform: scaleY(0);}
	
    //100% { -webkit-transform: translateX(0%); }
}
    
@keyframes slide-out {
    0% { transform: scaleY(0);}
	100% { transform: scaleY(1);}
	
	//0% { transform: translateX(0%); }
    //100% { transform: translateX(-100%); }
}

@-webkit-keyframes slide-out {
	0% { -webkit-transform: scaleY(0);}
	100% { -webkit-transform: scaleY(1);}
	
    //0% { -webkit-transform: translateX(0%); }
    //100% { -webkit-transform: translateX(-100%); }
}
		
    </style>
</head>

<body onload='main()'>

	<!--canvas id="myCanvas" width="200" height="100" style="border:5px solid #000000;" fill="#3a3a3a">
	</canvas-->

	<div id='graphPanel'>
		<div id='graphContainer'></div>
	</div>
	
	<div id='topBar'>
		<button class='toolPanelIcon'>1</button>
		<button class='toolPanelIcon'>2</button>
		<button class='toolPanelIcon'>3</button>
	</div>
	
	<div id='leftColumn'>
	</div>
	
	
	<div id='rightColumn'>
	</div>
	
	<!--div id="nodeOptions">
		<button onclick='relateSelectedToNode()'>Relate entity</button>
		<button onclick='deleteNode()'>Delete entity</button>
	</div-->

	

</body>

	<div id='noColumn'>
	
		<div class="labelSelectorDisplay toolPanel" id='panel.labelselectors'>
			<table id="selectorLabels" class="label">
			</table>
		</div>
		
		<div class='toolPanel' id='panel.config'>
			Configuration: <select onchange="changeConfig()" id="configSelector">
			</select>
		</div>
		
		<div class='toolPanel' id='panel.nodedetails'>
			<div id='selectedNode'></div>
			<hr>
			<div id='nodeDetails'>
			</div>
		</div>
		
		<div class='toolPanel' id='panel.linkdetails'>
			<div id='selectedLink'></div>
			<hr>
			<div id='linkDetails'>
			</div>
		</div>
		
		<div class='toolPanel' id='panel.simplequery'>		

			<div class="panelheader">Build Query:</div> 
			<table>
			<tr>
				<td>from entity:</td>
				<td>
					<select onchange="Neo4jQbuilder('qbuilder.from.entity')" id="qbuilder.from.entity">
					</select>
				</td>
			</tr>
			<tr >
				<td>where:</td>
				<td>
				<select onchange="Neo4jQbuilder('qbuilder.from.property')" id="qbuilder.from.property"></select>
				<!--input onchange="Neo4jQbuilder('qbuilder.from.property')" type="text" name="" list="qbuilder.from.property">
					<datalist id="qbuilder.from.property"></datalist-->
					
				</td>
			</tr>
			<tr>
				<td>is:</td>
				<td>
					<!--select onchange="qbuilder('qbuilder.from.value')" id="qbuilder.from.value"></select-->
					<input onfocus="Neo4jQbuilder_ClearValue('qbuilder.from.value')" onchange="Neo4jQbuilder('qbuilder.from.value')" id="qbuilder.from.value" type="text" name="" list="qbuilder.from.selectvalue">
					<datalist id="qbuilder.from.selectvalue"></datalist>
					
				</td>
			</tr>
			</table>
			<button onclick='ButtonSimpleSearch()'>Search</button>
			<!--button onclick='Neo4jQueryRecursiveSearch()'>Tree Search</button-->
		</div>
		
		<div class='toolPanel' id='panel.functions'>		
			<div class="panelheader">Functions:</div>
			<button onclick='createJsonFromSelectedNodes()'>Create Json</button>
			<button class="popup" >Monitor
				<div class="popuptext">
					<div id="hovertext" onclick="monitorCheckedItems()">Monitor checked</div>
					<div id="hovertext" onclick="clearAllMonitored()">Clear all</div>
				</div>
			</button>
			<button onclick='animateTest()'>Add Indicator</button>
			<button onclick='json2GraphDlg.showModal()'>Create from json</button>
			<!--button onclick='testFunction()'>Test2</button-->
			
		</div>
		
		<!--div id="slider" draggable="true" class="toolPanel slide-in">
			<ul>
				<li>Lorem</li>
				<li>Ipsum</li>
				<li>Dolor</li>
			</ul>
		</div-->
		<!--button id="toggle" style="position:absolute; top: 120px;">Toggle</button-->
		
		<div class='toolPanel labelSelectorDisplay' draggable="true" id='panel.monitoring'>
			<div id='newNode'>
			  <div class="panelheader">Monitored Nodes</div>
			  <table id='nodelist.monitored'>
			  </table>
			</div>
		</div>
		
		<div class='toolPanel' id='panel.entity.create'>		
			<div class="panelheader">Entity Management</div> 
			<table>
			<tr>
				<td>entity name:</td> <td> <input id='new.entity.name' value=''></input></td>
			</tr>
			</table>
			<hr>
			<table>
				<tr>
					<td><button class="paneloption tooltip" onclick="panelAddKeyValue('panel.entity.props', 'new.entity')">V<div class="tooltiptext">Add property</div></button></td>
					<td><button class="paneloption tooltip" onclick="panelRemoveKeyValue('panel.entity.props', 'new.entity')">X<div class="tooltiptext">Remove property</div></button></td>
				</tr>
			</table>
			<hr>
			<table id='panel.entity.props'>
			</table>
			<hr>
			<button onclick='Neo4jCreateEntity()'>Create New Entity</button>
			<button onclick='Neo4jUpdateEntity()'>Update Selected</button>
			<button onclick='deleteNode()'>Delete Selected</button>
		</div>

		
		<div class='toolPanel' id='panel.relationship.create'>		
			<div class="panelheader">Create Relationship</div> 
			<table>
			<tr>
				<td>relation name:</td> <td> <input id='new.relation.name' value=''></input></td>
			</tr>
			</table>
			<hr style="border-color:#262626;">
			<table>
				<tr>
					<td><button class="paneloption tooltip" onclick="panelAddKeyValue('panel.relation.props', 'new.relation')">V<div class="tooltiptext">Add property</div></button></td>
					<td><button class="paneloption tooltip" onclick="panelRemoveKeyValue('panel.relation.props', 'new.relation')">X<div class="tooltiptext">Remove property</div></button></td>
				</tr>
			</table>
			<hr style="border-color:#262626;">
			<table id='panel.relation.props'>
			</table>
			<hr style="border-color:#262626;">
			<button onclick='relateSelectedToNode()'>Create Relation To...</button>
			<button onclick='planRelateSelectedToNode()'>Plan Relation To...</button>
		</div>

		<div class='toolPanel' id='panel.bulkactions'>
			<div> 
				<div class="panelheader">Apply to ALL</div>
				<button class="popup" >Check
					<div class="popuptext">
						<div id="hovertext" onclick='uncheckAll()'>Uncheck all</div>
						<div id="hovertext" onclick='checkAll()'>Check all</div>
					</div>
				</button>
				<button onclick='Neo4jInitAllNodes()'>Fetch</button>
				<button onclick='unPinAllNodes()'>Unpin</button>
				<button onclick='arrangeBy()'>Arrange</button>
			</div>
		</div>

		<div class='toolPanel' id='panel.appearance'>
			<div class="panelheader">Appearance</div>
			<button class="popup">Node
				<div class="popuptext">
					<div id="hovertext" onclick='unPinNode()'>Unpin</div>
					<div id="hovertext" onclick='refreshNodeAppearance()'>Refresh Visual</div>
					<div id="hovertext" onclick='increaseNodeSize()'>Increase Size</div>
					<div id="hovertext" onclick='decreaseNodeSize()'>Decrease Size</div>
					<div id="hovertext" onclick='increaseNodeMass()'>Increase Mass</div>
					<div id="hovertext" onclick='decreaseNodeMass()'>Decrease Mass</div>
					<div id="hovertext" onclick='increaseNodeSprings()'>Increase Spring</div>
					<div id="hovertext" onclick='decreaseNodeSprings()'>Decrease Spring</div>
				</div>
			</button>
			
			<button class="popup">Font
				<div class="popuptext">
						<div id="hovertext" onclick='fontGrow()'>Increase font size</div>
						<div id="hovertext" onclick='fontShrink()'>Decrease font size</div>
						<div id="hovertext" onclick='fontUp()'>Move text up</div>
						<div id="hovertext" onclick='fontDown()'>Move text down</div>
				</div>
			</button>
			<button onclick='removeNodeFromStage()'>Hide Entity</button>
		</div>
		<!--div class='toolPanel' id='panelData'>	
			<div class="panelheader">Data</div>
			<input id="nodeLabel" type="text" name="lname">
			<button onclick='getEntityNode()'>Get Entity</button>
		</div-->
		
		<!--div class='toolPanel'>
			<div> 
				<div class="panelheader">Planning</div>
				<button onclick='planEntity()'>create entity</button>
				<button onclick='unPinAllNodes()'>create relation</button>
				<button onclick='arrangeBy()'>Arrange</button>
			</div>
		</div-->
		
		<div class='toolPanel' id='panel.selection'>
			<div id='newNode'>
			  <div class="panelheader">Selection Options:</div>
			  <input class="check" id="vo.ch" onclick="updateInteractionOptions()" type="checkbox" name="descendants" value=""> Multi Select<br>
			</div>
		</div>
		
		<div class='toolPanel' id='panel.highlight'>
			<div id='newNode'>
			  <div class="panelheader">View Options: (on entity hover)</div>
			  <form action="">
			  <input class="check" id="vo.hr" onclick="updateViewOptions()" type="radio" name="related" value="" checked="true"> Highlight Related<br>
			  <input class="check" id="vo.ha" onclick="updateViewOptions()" type="radio" name="related" value=""> Highlight Ancestors<br>
			  <input class="check" id="vo.hd" onclick="updateViewOptions()" type="radio" name="related" value=""> Highlight Descendants<br>
			  </form>
			</div>
		</div>
	
		<div class='toolPanel' id='panel.navigation'>
			<div id='newNode'>
			  <div class="panelheader">Navigation: (on entity double-click)</div>
			  <form action="">
			  <input class="check" id="vo.nav.direction" onclick="updateViewOptions_Nav('parent')" type="radio" name="related" value="" > fetch parents<br>
			  <input class="check" id="vo.nav.direction" onclick="updateViewOptions_Nav('child')" type="radio" name="related" value=""> fetch children<br>
			  <input class="check" id="vo.nav.direction" onclick="updateViewOptions_Nav('both')" type="radio" name="related" value="" checked> fetch both<br>
			  </form>
			</div>
		</div>
	</div>
	<dialog class='dialog' id="myDialog">
		<textarea id="myDialogText"></textarea>
		<button onclick="closeDialog('myDialog')">Close</button>
		
	</dialog>	
	
	<dialog class='dialog' id="json2GraphDlg">
		<textarea id="dlg.text.json"></textarea>
		<button onclick="submitJsonForGraph()">Submit</button>
		<button onclick="closeDialog('json2GraphDlg')">Cancel</button>
	</dialog>	
	

</html>
