<!DOCTYPE html>
<html>
<head>
    <title>Graph Engine</title>
    <script type="text/javascript" src="dist/vivagraph.js"></script>
	<script type="text/javascript" src="custom/Data1.json"></script>
    <!--
    This example uses jQuery, but it's only for convenience of listenting
    to DOM events. The jQuery can be replaced with your favorite library.
     -->
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript">

//==========Globals ==================================================================================================================================================================			
		//const UI_SHADOW_INDEX = 0;
		var UI_GLOW_INDEX = -1;
		var UI_MAIN_INDEX = 0;
		var UI_SELECTOR_INDEX = 1;
		var UI_TEXT_INDEX = 2;
		//.....Functional variables.......
		var labelsList = []; //list of neoLabel objects
		var nodeList = []; //list of node objects
		var linkList = []; //list of link objects
		var checkedNodes = []; //list of node objects
		var selectedNodeID = '';
		var selectedNodeData = '';
		var selectedNode = '';
		var selectedNodeUI = '';
		var bRelate = false;
		var counter = 10;	
		//......Connection settings........
		var defaultNeo4jUsername = 'neo4j';
		var defaultNeo4jPassword = 'password1234$';
		var neo4jUserToken = '';
		var neo4jServerURL = 'http://localhost:7474';
		var config = Configuration(connectUser);
	
		//......Filter settings.............
		var viewOptions = new viewOptionsType();
		var interactionOptions = new interactionOptionsType();
		
		//......Display settings............
		var THEMES = [];
		var currentTheme = new theme();
		var startupLabels = ["SCHEMA_ROOT", "ROOT"]; //list of strings // 
		var MaxLabelLength = 5; //the amount of characters allowed before elipse
		var labelSize = 30;
		
		//Theme 0
		var themeX = new theme({min:100,max:200},'#cccccc', '#0d0d0d', 'rect'); //light 
		themeX.shadow = true;
		themeX.glow = false;
		THEMES.push(themeX);
		themeX.linkColor = 'gray';
		
		//Theme 1
		themeX = new theme({min:70,max:150},'#0d0d0d', '#cccccc', 'rect'); //dark
		themeX.shadow = true;
		themeX.glow = false;
		THEMES.push(themeX); //dark
		themeX.linkColor = 'gray';
		
		//Theme 2 (Black hole)
		themeX = new theme({min:0,max:10},'#0d0d0d', '#cccccc', 'rect'); //dark
		THEMES.push(themeX);
		themeX.shadow = false;
		themeX.rounded = false;
		themeX.glow = true;
		themeX.linkColor = '#3333ff';
		themeX.entityLabelColor = '#ccffff';
		
		//Theme 3 (eco 1)
		themeX = new theme({min:50,max:100},'#262626', '#262626', 'rect'); //dark
		THEMES.push(themeX);
		themeX.shadow = false;
		themeX.glow = false;
		themeX.rounded = false;
		themeX.linkColor = '#999999';
		themeX.entityLabelColor = '#e6e6e6';
		themeX.opaque = true;
		themeX.labelSizing = 'none';
		
		
		currentTheme = THEMES[2];
		
		//Singletons...
		var GRAPH = '';
		var graphics = '';
		var layout = '';
		var renderer = '';
		
		
//VISUAL SETTINGS		
		var hiddenLabels = [
			'JOBJ',
			'JCOL',
			'JSON_OBJECT', 
			'ELEMENT', 
			'JSON_NUMBER',
			'JSON_STRING',
			'SCHEMA_ROOT',
			'ROOT',
			'COLLECTION'
		];

		
//MODELS	
		function datax() {
		  this.id = 0;
		  this.labels = [];
		  this.nodeSize = 25;
		  this.nodeColor = '#808080';
		  this.nodeColorRGB = {r:0,g:0,b:0};
		  this.nodeOpacity = '0.9'
		  this.textColor = '#ffffff';
		  this.displayLabel = '';
		  this.isPinned = false; 
		  this.properties = [];
		  this.toLinks = [];
		  this.fromLinks = [];
		  this.toNodes = [];
		  this.fromNodes = [];
		}
		
		function neoPropertyList(obj)
		{
			var propArray = [];
			for (var thiskey in obj) {
				propArray.push({key: thiskey, value:obj[thiskey]})
			}
			return propArray;
		}
		
		function neoLabel(setName, setColor, setColorRGB)
		{
			this.name = setName;
			this.color = setColor;
			this.colorRGB = setColorRGB;
			return this;
		}
		
		function linkType(fromNodeID, toNodeID)
		{
			this.FromNodeID = fromNodeID;
			this.ToNodeID = toNodeID;
			return this;
		}
		
		function viewOptionsType()
		{
			this.highlightRelated = true;
			this.highlightAncestors = false;
			this.highlightdescendants = false;
			return this;
		}
		
		function interactionOptionsType()
		{
			this.checkNodes = false;
			return this;
		}
		
		function theme(entityRgbRange, graphBackground, entityLabelColor, entityShape)
		{
			this.entityRgbRange = (entityRgbRange)?entityRgbRange: {min:100,max:200};
			/*The 4bit rgb range from which label colors can be automatically generated.*/
			this.graphBackground = (graphBackground)?graphBackground: '#1a1a1a';
			this.entityLabelColor = (entityLabelColor)?entityLabelColor: 'white';
			this.entityShape = (entityShape)?entityShape: 'rect';
			this.opaque = false;
			/*choices: 
				rect (entities are rectangular)
				circle (entities are circles)
			*/
			this.labelSizing = "fontsize"; 
			/*choices: 
				"hyphenate" (make labels shorter)
				"fontsize" (make the font size smaller)
				"" (no sizing, labels may extend past the boundaries of the node)
			*/
			this.shadow = true;
			this.glow = false;
			this.linkColor = 'red';
			this.rounded = false;
		}
		
		function getNeoLabel(byName)
		{
			var x;
				labelsList.forEach(function(labelobj, index){
				if (labelobj.name == byName){
					x = labelobj;
					return labelobj;
				}
			});
			return x;
		}
		function getDataLink(fromNodeID, toNodeID)
		{
			var x;
				linkList.forEach(function(link, index){
				if (link.FromNodeID == fromNodeID && link.ToNodeID == toNodeID){
					x = link;
					return link;
				}
			});
			return x;
		}
		function getDataNode(nodeID)
		{
			var x;
				nodeList.forEach(function(node, index){
				if (node.id == nodeID){
					x = node;
					return node;
				}
			});
			return x;
		}
		
		function neo_APIcall()
		{
			this.statements = [];
			return this;
		}
		
		function neo_Statement(statement)
		{
			this.statement = statement;
			return this;
		}
//CUSTOM GRAPH FUNCTIONS
		function Neo4j_Connect()
		{ //This just creates a base64 string from the users Neo4j creds, 
		  //which then gets passed in as authentication along with their API call.
			//connectUser(config);
			//Neo4j_InitAllNodes();

			hideNeo4jConnect();
		}
		
		
		function addDataNode(nodeId, nodeData)
		{
			//if (GRAPH.getNode(nodeId))return;
			var dataNode = getDataNode(nodeId);
			if (!dataNode){
				dataNode = addNodeToGraph(nodeId,nodeData);				
				nodeList.push(dataNode);
			}
			else
			{
				dataNode.data.labels = nodeData.labels;
				dataNode.data.properties = nodeData.properties;
			}
			
			dataNode.data.displayLabel = "";
			dataNode.data.labels.forEach(function(label, index){
				if(!getNeoLabel(label)) {
					var rgb = {r: Math.ceil(getRandomArbitrary(currentTheme.entityRgbRange.min, currentTheme.entityRgbRange.max)),
							   g: Math.ceil(getRandomArbitrary(currentTheme.entityRgbRange.min, currentTheme.entityRgbRange.max)),
							   b: Math.ceil(getRandomArbitrary(currentTheme.entityRgbRange.min, currentTheme.entityRgbRange.max))
					}
					var randomColor = rgb2hex(rgb.r, rgb.g, rgb.b);
					var newLabel = new neoLabel(label, randomColor, rgb);
					
					labelsList.push(newLabel);
					//addVisLabel(newLabel, labelsList.length-1);
				}
				
				//Don't show hidden labels...
				if (hiddenLabels.indexOf(label) < 0){
					if (dataNode.data.displayLabel) {dataNode.data.displayLabel += ','}
					dataNode.data.displayLabel = dataNode.data.displayLabel + label;
				}
			});
			//nodeData.displayLabel;
			var aNeoLabel = getNeoLabel(dataNode.data.labels[0]);
			if (aNeoLabel) {dataNode.data.nodeColor = aNeoLabel.color; dataNode.data.nodeColorRGB = aNeoLabel.colorRGB;}


			//var newNodeUI = graphics.getNodeUI(nodeId);
			//var textWidth = newNodeUI.children[2];
			//newNodeUI.children[2].attr('x', -textWidth/2);
			//
			addNodeToGraph(dataNode.id,dataNode.data);
			showNodeDetails(dataNode);
			return dataNode;
			
		}
				
		function addDataLink(fromNodeID, toNodeID, relationshipData)
		{
			//var linkData = {};relationshipData;
			//linkData.connectionStrength = 110;
			var link = GRAPH.addLink(fromNodeID, toNodeID, relationshipData);
			linkList.push(new linkType(fromNodeID,toNodeID)); 
			//var otherLinks = GRAPH.getLinks(fromNodeID);
			//otherLinks.forEach(function(otherlink) {
			//	otherlink.data.connectionStrength+= 1;
			//});
			var toNode = GRAPH.getNode(toNodeID);
			var fromNode = GRAPH.getNode(fromNodeID);
			var linkUI = graphics.getLinkUI(link.id);
			linkUI.attr('fromNode',fromNodeID).attr('toNode',toNodeID);
			
			toNode.data.fromLinks.push(link);
			toNode.data.fromNodes.push(fromNode);
			
			fromNode.data.toLinks.push(link);
			fromNode.data.toNodes.push(toNode);
			
			increaseNodeSize(fromNodeID);
		}
			
		function unPinNode()
		{
			layout.pinNode(selectedNode, false);
			selectedNode.data.isPinned = false;
		}
		
		function updateViewOptions()
		{
			viewOptions.highlightRelated = document.getElementById('vo.hr').checked;
			viewOptions.highlightAncestors = document.getElementById('vo.ha').checked;
			viewOptions.highlightdescendants = document.getElementById('vo.hd').checked;
		}
		
		function updateInteractionOptions()
		{
			interactionOptions.checkNodes = document.getElementById('vo.ch').checked;
		}
		
		function unPinAllNodes()
		{
			nodeList.forEach(function(node){
				layout.pinNode(node, false);
				node.data.isPinned = false;
			});
		}
		
		function getDataRootNodes()
		{
			var rootNodes = [];
			nodeList.forEach(function(node){
				if (node.data.fromNodes.length == 0)
				{
					rootNodes.push(node);
				}
			});
			return rootNodes;
		}
		
		
		function arrangeBy(rootNode, processedNodeIds, maxxRight, maxxLeft, level, startY)
		{
			
			if (!rootNode){
				
				var startPos = layout.getNodePosition(nodeList[0].id);
				var rootNodes = getDataRootNodes();
				processedNodeIds = [];
				
				nodeList.forEach(function(node){
					layout.setNodePosition(node.id, startPos.x, startPos.y);
				});
			
				maxxRight = startPos.x;
				maxxLeft = startPos.x;
				startY = startPos.y;
				rootNodes.forEach(function(rootNode, index){
					console.log(rootNode);
					layout.setNodePosition(rootNode.id, maxxRight, startPos.y);
					maxxRight = arrangeBy(rootNode, processedNodeIds, maxxRight,maxxLeft, 0, startY);
					layout.setNodePosition(rootNode.id, maxxRight, startPos.y);
				});
			}
			else{
				
				console.log('arranging child node: ' + rootNode.id + ' level: ' + level);
				level++;
				layout.pinNode(rootNode, true);
				rootNode.data.isPinned = true;
				processedNodeIds.push(rootNode.id);
				var rootNodePos = layout.getNodePosition(rootNode.id);
				var cb = rootNodePos.x - ((rootNode.data.toNodes.length*100) /2)
				rootNode.data.toNodes.forEach(function(childNode, index){
					console.log('parent pos: ' + rootNodePos.x + ":" + rootNodePos.y);
					var childNodePos = layout.getNodePosition(childNode.id);
					//console.log('child  pos: ' + childNodePos.x + ":" + childNodePos.y);
					childNodePos.x = cb + (100 * index);
					console.log('max bef   : ' + maxxRight);
					if (childNodePos.x >= maxxRight) {maxxRight = childNodePos.x + 100;}
					if (childNodePos.x <= maxxLeft) {maxxLeft = maxxLeft - 100; maxxRight = maxxRight + 100;}
					console.log('max after : ' + maxxRight);
					console.log('child  x  : ' + childNodePos.x);
					console.log('child  pos: ' + childNodePos.x + ":" + childNodePos.y);
					var childLevel = startY + (level * 150);
					if (childLevel > childNodePos.y) {childNodePos.y = childLevel};
					layout.setNodePosition(childNode.id, childNodePos.x, childNodePos.y);
					
					if (processedNodeIds.indexOf(childNode.id) < 0){
						//console.log('arranging node' + childNode.id);
						arrangeBy(childNode, processedNodeIds, maxxRight, maxxLeft, level, startY);
					}
				});
			}
			return maxxRight;
			/*/------------------------------------------------------------------------------------
			var startPos = layout.getNodePosition(nodeList[0].id);
			var rootNodes = getDataRootNodes();
			var allNodes = [];
			var xpos = startPos.x;

			rootNodes.forEach(function(node){
				allNodes.push(node.id);
			});

			nodeList.forEach(function(node){
				xpos = xpos + node.data.nodeSize * 2;
				var currentNodePos = layout.getNodePosition(node.id);
				layout.setNodePosition(node.id, xpos, startPos.y);
				layout.pinNode(node, true);
				node.data.isPinned = true;
				node.data.maxlevel = 0;
			});
				
			for (var i = 0; i< 2; i++)
			{
				nodeList.forEach(function(node){
					node.data.toNodes.forEach(function(othernode, index){
						if (othernode.data.maxlevel <= node.data.maxlevel){othernode.data.maxlevel = node.data.maxlevel+1}
						var currentParentPos = layout.getNodePosition(othernode.id);
						var currentNodePos = layout.getNodePosition(othernode.id);
						//var newYPos = (currentParentPos<currentNodePos)?currentParentPos.y:currentNodePos.y + 100;
						var newYPos = startPos.y + (othernode.data.maxlevel * 100);
						//var newXPos = (currentParentPos.x + currentNodePos.y)/2;
						layout.setNodePosition(othernode.id, currentNodePos.x, newYPos);
					});
				});
			}

			return;
			*/
		}
		
		function addNodeToGraph(nodeId, nodeData)
		{
			var newNode = GRAPH.addNode(nodeId, nodeData);
			fixTextWidth(graphics.getNodeUI(nodeId));
			return newNode;
		}
		
		function increaseNodeSize(nodeId)
		{
			if (!nodeId){nodeId = selectedNodeID;}
			var node = GRAPH.getNode(nodeId);
			node.data.nodeSize = node.data.nodeSize * 1.05;
			addNodeToGraph(node.id,node.data);
			//node.data.toLinks.forEach(function(link){
				//var linkUI = graphics.getLinkUI(link.id);
				//linkUI.attr('stroke-width',node.data.nodeSize/5);
			//});			
		}		

		function decreaseNodeSize(nodeId)
		{
			if (!nodeId){nodeId = selectedNodeID;}
			var node = GRAPH.getNode(nodeId);
			node.data.nodeSize = node.data.nodeSize / 1.1;
			addNodeToGraph(node.id,node.data);
		}	
		
		function highlightLabel(labelIndex)
		{
			var label = labelsList[labelIndex];
			checkedNodes.forEach(function(node){
				var nodeUI = graphics.getNodeUI(node.id);
				nodeUI.children[UI_MAIN_INDEX].attr('stroke','transparent');
			});
			
			checkedNodes = [];
			nodeList.forEach(function(node){
				var nodeUI = graphics.getNodeUI(node.id);
				//node.data.toLinks.forEach(function(link){
				//	var linkUI = graphics.getLinkUI(link);
				//	linkUI.attr('stroke-opacity','0.1');
				//});
				
				if (node.data.labels.indexOf(label.name) > -1){
					nodeUI.children[UI_GLOW_INDEX].attr('fill-opacity','0.8');
					nodeUI.children[UI_MAIN_INDEX].attr('fill-opacity','0.8');
					nodeUI.children[UI_TEXT_INDEX].attr('fill-opacity','1');
					checkedNodes.push(node);
				}
				else{
					nodeUI.children[UI_GLOW_INDEX].attr('fill-opacity','0');
					nodeUI.children[UI_MAIN_INDEX].attr('fill-opacity','0.2');
					nodeUI.children[UI_TEXT_INDEX].attr('fill-opacity','0.1');
				}
					
			});
		}
		
		function createLabelDiplay()
		{
			labelsList.sort(sort_by('name', false, function(a){return a.toUpperCase()}));
			var LabelsDiv = document.getElementById('availableLabels');
			LabelsDiv.innerHTML = '';
			labelsList.forEach(function(label,index){
				LabelsDiv.innerHTML = LabelsDiv.innerHTML + 
					'<div onclick="highlightLabel('+index+')" id="labelPanel" style="background-color:gray;">' + label.name + 
					'</div>';
			});
		}
//USEFULL FUNCTIONS
		//convert string to Base64
		//var encodedData = window.btoa(stringToEncode);

		var sort_by = function(field, reverse, primer){
		   var key = primer ? 
			   function(x) {return primer(x[field])} : 
			   function(x) {return x[field]};
		   reverse = !reverse ? 1 : -1;
		   return function (a, b) {
			   return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
			 } 
		}

		// Returns a random number between min (inclusive) and max (exclusive)
		function getRandomArbitrary(min, max) {
			return Math.random() * (max - min) + min;
		}
		//RGB to #HEX
		function rgb2hex(red, green, blue) {
				var rgb = blue | (green << 8) | (red << 16);
				return '#' + (0x1000000 + rgb).toString(16).slice(1)
		  }

		
		function sleepFor( sleepDuration ){
			var now = new Date().getTime();
			while(new Date().getTime() < now + sleepDuration){ /* do nothing */ } 
		}
		

//AJAX CALLS
		
		
		function Neo4j_Command(statements, successCallback, failCallback)
		{
			var body = new neo_APIcall(); 
			statements.forEach(function(statement){
				body.statements.push(new neo_Statement(statement));
			});
			
			$.ajax({
					url: neo4jServerURL + "/db/data/transaction/commit",
					type: 'post',
					data: JSON.stringify(body),
					headers: {
						"Accept":'application/json; charset=UTF-8',
						"Content-Type": 'application/json',
						"Authorization": 'Basic ' + neo4jUserToken
					},
					dataType: 'json',				
					
					success: function (returnbody){
						if (successCallback){
							successCallback(returnbody);
						}
					},
					error: function (returnbody){
						if (failCallback){failCallback(returnbody);}
					}()
					
					
				});
				
		}
		

		
		function GetNodesForSelected()
		{
			Neo4j_GetChildNodesFor(selectedNodeID);
		}
		
		function Configuration(callback)
		{
			var body;
			$(document).ready(function(e) {
				callback(jsonObject.Configuration);
			});
		}
		function Neo4j_GetChildNodesFor(neo_nodeid)
		{
			var statements = [];
			statements.push("MATCH (n)-[*1]->(m) where id(n) = "+ neo_nodeid +" RETURN id(n), id(m), labels(m), (m)");
			var body = new neo_APIcall(); 
			statements.forEach(function(statement){
				body.statements.push(new neo_Statement(statement));
			});
			
			
			$.ajax({
					url: neo4jServerURL + "/db/data/transaction/commit",
					type: 'post',
					data: JSON.stringify(body),//{//access_token: 'XXXXXXXXXXXXXXXXXXX'},
					headers: {
						"Accept":'application/json; charset=UTF-8',
						"Content-Type": 'application/json',
						"Authorization": 'Basic ' + neo4jUserToken
					},
					dataType: 'json',
					success: function (returnbody) {
						for (var i = 0; i < returnbody.results.length; i++){
							
							var result = returnbody.results[i];
							for (var d = 0; d < result.data.length; d++){
								var row = result.data[d].row;
								var dat = new datax;
								dat.id =row[1];
								if (row[2]){dat.labels = row[2];}
								if (row[3]){dat.properties = new neoPropertyList(row[3]);}
								var node = addDataNode(row[1], dat);
								if (!GRAPH.getNode(row[1])){
									var pos = layout.getNodePosition(row[0]);
									layout.setNodePosition(row[1], pos.x, pos.y);
								}
								if (!getDataLink(row[0], row[1]))
								{
									addDataLink(row[0], row[1]);
								}
								//fixTextWidth();
							}
						}
						createLabelDiplay();
					}
				});
		}
		
		function Neo4j_GetNodeById(neo_nodeid)
		{
			//var URL = neo4jServerURL + "/db/data/transaction HTTP/1.1";
			var body = new neo_APIcall(); 
			body.statements.push(new neo_Statement('MATCH (n) WHERE ID(n) = '+neo_nodeid+'  RETURN id(n), labels(n), (n)'));
			$.ajax({
					url: neo4jServerURL + "/db/data/transaction/commit",
					type: 'post',
					data: JSON.stringify(body),//{//access_token: 'XXXXXXXXXXXXXXXXXXX'},
					headers: {
						"Accept":'application/json; charset=UTF-8',
						"Content-Type": 'application/json',
						"Authorization": 'Basic ' + neo4jUserToken
					},
					dataType: 'json',
					success: function (returnbody) {
						for (var i = 0; i < returnbody.results.length; i++){
							var result = returnbody.results[i];
							for (var d = 0; d < result.data.length; d++){
								var row = result.data[d].row;
								var dat = new datax;
								dat.id =row[0];
								if (row[1]){dat.labels = row[1];}
								if (row[2]){dat.properties = new neoPropertyList(row[2]);}
								addDataNode(row[0], dat);
							}
						}
						createLabelDiplay();
					}
				});
		}
		
		function Neo4j_GetNodesByLabel(byLabel)
		{
			
			var matchPattern = 'n';
			if (byLabel) {matchPattern += ":" + byLabel;}
			//var URL = neo4jServerURL + "/db/data/transaction HTTP/1.1";
			var body = new neo_APIcall(); 
			body.statements.push(new neo_Statement('MATCH ('+matchPattern+') RETURN id(n), labels(n), (n)'));
			$.ajax({
					url: neo4jServerURL + "/db/data/transaction/commit",
					type: 'post',
					data: JSON.stringify(body),//{//access_token: 'XXXXXXXXXXXXXXXXXXX'},
					headers: {
						"Accept":'application/json; charset=UTF-8',
						"Content-Type": 'application/json',
						"Authorization": 'Basic ' + neo4jUserToken
					},
					dataType: 'json',
					success: function (returnbody) {
						for (var i = 0; i < returnbody.results.length; i++){
							var result = returnbody.results[i];
							for (var d = 0; d < result.data.length; d++){
								var row = result.data[d].row;
								var dat = new datax;
								dat.id =row[0];
								if (row[1]){dat.labels = row[1];}
								if (row[2]){dat.properties = new neoPropertyList(row[2]);}
								addDataNode(row[0], dat);
							}
						}
						createLabelDiplay();
					}
				});
		}
		
		function Neo4j_InitAllNodes(byLabel)
		{
		
			var matchPattern = 'n';
			if (byLabel) {matchPattern += ":" + matchPattern;}
		//var bodyStart = '{"statements" : [ { "statement" : "MATCH (n) RETURN id(n),labels(n)"} ]}';
			//var URL = neo4jServerURL + "/db/data/transaction HTTP/1.1";
			var body = new neo_APIcall(); 
			body.statements.push(new neo_Statement('MATCH ('+matchPattern+') RETURN id(n), labels(n), (n)'));

	
			$.ajax({
					url: neo4jServerURL + "/db/data/transaction/commit",
					type: 'post',
					data: JSON.stringify(body),//{//access_token: 'XXXXXXXXXXXXXXXXXXX'},
					headers: {
						"Accept":'application/json; charset=UTF-8',
						"Content-Type": 'application/json',
						"Authorization": 'Basic ' + neo4jUserToken
					},
					dataType: 'json',
					success: function (returnbody) {
						for (var i = 0; i < returnbody.results.length; i++){
							var result = returnbody.results[i];
							for (var d = 0; d < result.data.length; d++){
								var row = result.data[d].row;
								var dat = new datax;
								dat.id =row[0];
								if (row[2]){dat.properties = new neoPropertyList(row[2]);}
								if (row[1]){dat.labels = row[1];}
								//if (!GRAPH.getNode(row[0])){
								addDataNode(row[0], dat);
								//}
							}
						}
						createLabelDiplay();
						Neo4j_InitAllRelations();
					}
				});
				
				
		}
	
		function Neo4j_InitAllRelations()
		{
		
			//var URL = neo4jServerURL + "/db/data/transaction HTTP/1.1";
			var body = '{"statements" : [ { "statement" : "MATCH (n)-[*1]->(m) RETURN id(n), id(m)"} ]}';
	
			$.ajax({
					url: neo4jServerURL + "/db/data/transaction/commit",
					type: 'post',
					data: body,//{//access_token: 'XXXXXXXXXXXXXXXXXXX'},
					headers: {
						"Accept":'application/json; charset=UTF-8',
						"Content-Type": 'application/json',
						"Authorization": 'Basic ' + neo4jUserToken
					},
					dataType: 'json',
					success: function (returnbody) {
						for (var i = 0; i < returnbody.results.length; i++){
							
							var result = returnbody.results[i];
							for (var d = 0; d < result.data.length; d++){
								var row = result.data[d].row;
								if (!getDataLink(row[0], row[1]))
								{
									addDataLink(row[0], row[1]);
									increaseNodeSize(row[0]);
								}
							}
						}
						
					}
				});
		}
		
		function Neo4j_CreateNode(labelName)
		{
			//var URL = neo4jServerURL + "/db/data/transaction HTTP/1.1";
			var body = '{"statements" : [ { "statement" : "CREATE (n:' + labelName + ') RETURN id(n)"} ]}';
	
			$.ajax({
					url: neo4jServerURL + "/db/data/transaction/commit",
					type: 'post',
					data: body,
					headers: {
						"Accept":'application/json; charset=UTF-8',
						"Content-Type": 'application/json',
						"Authorization": 'Basic ' + neo4jUserToken
					},
					dataType: 'json',
					success: function (returnbody) {	
						for (var i = 0; i < returnbody.results.length; i++){
							
							var result = returnbody.results[i];
							for (var d = 0; d < result.data.length; d++){
								var row = result.data[d].row;
								var dat = new datax;
								dat.id = row[0];
								if (labelName) {dat.labels.push(labelName);}
								//if (!GRAPH.getNode(row[0])){
								addDataNode(row[0],dat);
								//}
							}
						}					
					}
				});
		}

		function Neo4j_DeleteNode(NodeID)
		{
			//var URL = neo4jServerURL + "/db/data/transaction HTTP/1.1";
			var body = '{"statements" : [ { "statement" : "MATCH (n) where ID(n) = '+ NodeID +' DETACH DELETE (n) RETURN ID(n)"} ]}';
	
			$.ajax({
					url: neo4jServerURL + "/db/data/transaction/commit",
					type: 'post',
					data: body,
					headers: {
						"Accept":'application/json; charset=UTF-8',
						"Content-Type": 'application/json',
						"Authorization": 'Basic ' + neo4jUserToken
					},
					dataType: 'json',
					success: function (returnbody) {	

						for (var i = 0; i < returnbody.results.length; i++){
							
							var result = returnbody.results[i];
							for (var d = 0; d < result.data.length; d++){
								var row = result.data[d].row;
								if (row[0]){
									GRAPH.removeNode(row[0]);
									selectedNodeID = '';
									selectedNodeData = '';
									selectedNode = '';
								}
							}
						}					
					}
				});
		}
		
		function Neo4j_CreateRelation(NodeID1, NodeID2, Relation)
		{
		
			//var URL = neo4jServerURL + "/db/data/transaction HTTP/1.1";
			var body = '{"statements" : [ { "statement" : "';
			body += ' match (n) where ID(n) = ' + NodeID1;
			body += ' match (m) where ID(m) = ' + NodeID2;
			body += ' create (n)-[r:TEST]->(m)';
			body += ' RETURN id(r)"}]}';
			

			
			$.ajax({
					url: neo4jServerURL + "/db/data/transaction/commit",
					type: 'post',
					data: body,
					headers: {
						"Accept":'application/json; charset=UTF-8',
						"Content-Type": 'application/json',
						"Authorization": 'Basic ' + neo4jUserToken
					},
					dataType: 'json',
					success: function (returnbody) {	
						for (var i = 0; i < returnbody.results.length; i++){
							
							var result = returnbody.results[i];
							for (var d = 0; d < result.data.length; d++){
								var row = result.data[d].row;
								if (row[0]){

									var link = GRAPH.addLink(NodeID1, NodeID2);
									var linkUI = graphics.getLinkUI(link.id);
									linkUI.attr('fromNode',NodeID1).attr('toNode',NodeID2);
									//increaseNodeSize(NodeID1);
								}
									
								//var dat = new datax;
								//	dat.id = row[0];
								//	if (labelName) {dat.labels = labelName;}
								//GRAPH.addNode(row[0],dat);
							}
						}					
					},
					error: function (msg) {
					}
					
				});
		}
		

		
		
//UI MANIPULATION
		
		function connectUser(config){
			
			var userName, userPassword;
			userPassword = config.neo4jconnection.password;
			userName = config.neo4jconnection.username;
			neo4jServerURL = config.neo4jconnection.server;
			
			//Call Base64 function to get token...
			neo4jUserToken =  window.btoa(userName + ':' + userPassword);
			
			startupLabels.forEach(function(label){
					Neo4j_GetNodesByLabel(label);
				});
				
			
		}
		
		function hideNeo4jConnect(){
			document.getElementById("connectDets").remove();
		}
		
		function createNode(){
			var newNodeValue = document.getElementById('newNodeData').value;
			Neo4j_CreateNode(newNodeValue);
		}
		
		function deleteNode(){
			Neo4j_DeleteNode(selectedNodeID);
		}
		
		function refreshNodeAppearance(){
			var node = GRAPH.getNode(selectedNodeID);
			addNodeToGraph(selectedNodeID,node.data);
		}
		
		function Neo4jRowReturn(returnbody, callback) {
			for (var r = 0; r < returnbody.results.length; r++){
				var result = returnbody.results[r];
				for (var c = 0; c < result.data.length; c++){
					callback(result.data[c].row);
				}
			}
		}
					
		function relateSelectedToNode(){
			bRelate = true;
		}
		
		function fontGrow()
		{
			var fontsize = Number(selectedNodeUI.children[UI_TEXT_INDEX].attr('font-size'));
			selectedNodeUI.children[UI_TEXT_INDEX].attr('font-size', fontsize + 1);
		}
		function fontShrink()
		{
			var fontsize = Number(selectedNodeUI.children[UI_TEXT_INDEX].attr('font-size'));
			selectedNodeUI.children[UI_TEXT_INDEX].attr('font-size', fontsize - 1);
		}
		function fontDown()
		{
			var fontsize = Number(selectedNodeUI.children[UI_TEXT_INDEX].attr('y'));
			selectedNodeUI.children[UI_TEXT_INDEX].attr('y', fontsize + 1);
		}
		function fontUp()
		{
			var fontsize = Number(selectedNodeUI.children[UI_TEXT_INDEX].attr('y'));
			selectedNodeUI.children[UI_TEXT_INDEX].attr('y', fontsize - 1);
		}
		
		function fixTextWidth(nodeUI)
		{
			var widthOfNode = Number(nodeUI.children[UI_MAIN_INDEX].getBBox().width);
			var minWidth = widthOfNode - widthOfNode * 0.1;
			var widthOfText = Number(nodeUI.children[UI_TEXT_INDEX].getBBox().width);
			var text = nodeUI.children[UI_TEXT_INDEX].text();
			if (!text || text.length == 0) {return;}
			
			var failer = 0;
			
			if (widthOfText > minWidth)
			{
				while (widthOfText >= minWidth)
				{
					failer++;
					if (currentTheme.labelSizing == 'hyphenate')
					{
						text = (text).substring(0, text.length-2) + "'";
						nodeUI.children[UI_TEXT_INDEX].text(text);
					}
					else if (currentTheme.labelSizing == 'fontsize')
					{
						var fontsize = Number(nodeUI.children[UI_TEXT_INDEX].attr('font-size'));
						nodeUI.children[UI_TEXT_INDEX].attr('font-size', fontsize*0.9);
					}
					else return;
					widthOfText = Number(nodeUI.children[UI_TEXT_INDEX].getBBox().width);
					if (failer > 1000) return;
				}
			}
			else if (currentTheme.labelSizing == 'fontsize')
			{	failer = 0;			
				while (widthOfText < minWidth - (widthOfText *0.2))
				{
					failer++;
					var fontsize = Number(nodeUI.children[UI_TEXT_INDEX].attr('font-size'));
					nodeUI.children[UI_TEXT_INDEX].attr('font-size', fontsize*1.1);
					widthOfText = Number(nodeUI.children[UI_TEXT_INDEX].getBBox().width);
					if (failer > 1000) return;
				}
			}
			nodeUI.children[UI_TEXT_INDEX].attr('x', -minWidth/5);
			var heightOfNode = Number(nodeUI.children[UI_MAIN_INDEX].getBBox().height);
			nodeUI.children[UI_TEXT_INDEX].attr('y', heightOfNode/3);
		}
		
		function deleteLabel(nodeId, labelName)
		{
			var command = "MATCH (n) where ID(n) = " + nodeId + " REMOVE n:" + labelName;
			var callback = function(){Neo4j_GetNodeById(selectedNodeID)};
			Neo4j_Command([command], callback, callback);
		}	

		function addProperty(nodeId)
		{
			if (!nodeId) {nodeId=selectedNodeID}
			var elePropKey = document.getElementById('add.property.key').value;
			var elePropVal = document.getElementById('add.property.value').value;
			var elePropType = document.getElementById('add.property.type').value;
			if (!elePropType) {elePropType ="string";}
			if (elePropType == "string"){elePropVal = '"' + elePropVal + '"'}
			var command = "MATCH (n) where ID(n) = " + nodeId + " SET n +={" + elePropKey + ":" + elePropVal + "}";
			
			var callback = function(){Neo4j_GetNodeById(selectedNodeID)};
			Neo4j_Command([command], callback, callback);
		}
		
		function addPropertyToChecked()
		{
			checkedNodes.forEach(function(node){
				addProperty(node.id);
			});
		}
		
		function addPropertyToAll()
		{
			nodeList.forEach(function(node){
				addProperty(node.id);
			});
		}
		
		function addLabel()
		{
			var processingElement = document.getElementById('log');
			//node.data.labels.push(processingElement.value);
			if(!processingElement) return;
			if(!processingElement.value) return;
			var command = "MATCH (n) where ID(n) = " + selectedNodeID + " SET n:" + processingElement.value;
			var callback = function(){Neo4j_GetNodeById(selectedNodeID)};
			Neo4j_Command([command], callback, callback);
		}
		
		function showNodeDetails(node)
		{
			var processingElement = document.getElementById('selectedNode');
			var labellist = ''
			node.data.labels.forEach(function(label, index){
				if (index!=0){labellist += ', ';}
				var button_onclick = 'deleteLabel(' + node.id + ', \'' + label + '\')';
				labellist += '<a>' + label + '<button class="fortext tooltip" onclick="'+button_onclick+'" >X<div class="tooltiptext">delete label</div></button></a>'
				
			});
			var html = '<a style="text-decoration: underline; font-weight: bold;">Selected entity ID<a>: ' + selectedNodeID;
			html += '<br/><a style="text-decoration: underline; font-weight: bold;">Entity type<a>:<br/>' + labellist;
			processingElement.innerHTML = html;
			
			html = '<a style="text-decoration: underline; font-weight: bold;">Properties<a>:';
			var processingElement = document.getElementById('nodeDetails');
			node.data.properties.forEach(function(property, index){
				html += '<br/>  ' + property.key + ': ' + property.value;
			});
			processingElement.innerHTML = html;
		}
		

		
		//function fetchInfo(id) {
		//	var root = 'https://secure.gravatar.com/avatar/91bad8ceeec43ae303790f8fe238164b';
		//	return $.getJSON(root);
			//var root = 'https://secure.gravatar.com/avatar/' + node.data';
			//return $.getJSON(root + '/photos/' + id);
		//}

//==========Outside graph ==================================================================================================================================================================		
		function main () {

		

//==========Inside graph ==================================================================================================================================================================
			var graph = Viva.Graph.graph();
			
            //graph.addNode('anvaka', 'test1'); //'91bad8ceeec43ae303790f8fe238164b');
            //graph.addNode('indexzero',function(){var d = new Date(); return d.getTime() }()); // 'd43e8ea63b61e7669ded5b9d3c2e980f');
			//graph.addNode('asdasd', 'test3'); //'d43e8ea63b61e7669ded5b9d3c2e980f');
            //graph.addLink('anvaka', 'indexzero'); //'indexzero');
			
			// Custom physics... (include/exclude in the 'renderer' at the bottom of the script)
			var idealLength = 150;
			layout = Viva.Graph.Layout.forceDirected(graph, {
			   springLength: idealLength,
			   springCoeff : 0.00008,
			   //dragCoeff : 0.01,
			   //gravity : -1.2,
			   //theta : 1
			   springTransform: function (link, spring) {
                    spring.length = idealLength;// + link.data.connectionStrength;
               }
				  
			});
		
			// Custom functions...
            graphics = Viva.Graph.View.svgGraphics(),
                nodeSize = 24,
				//------------------------------------------------------------------------------------
                // we use this method to highlight all realted links
                // when user hovers mouse over a node:
                highlightRelatedNodes = function(nodeId, isOn) {				   
				   // just enumerate all realted nodes and update link color:
                   graph.forEachLinkedNode(nodeId, function(node, link){
                       var linkUI = graphics.getLinkUI(link.id);
                       //var strokeWidth = Number(linkUI.attr('stroke-width'));
					   if (linkUI) {
                           // linkUI is a UI object created by graphics below
                           linkUI.attr('stroke', isOn ? '#cc3300' : currentTheme.linkColor)
							.attr('stroke-width', isOn ? 4 : 3)
							//.attr('markerHeight', "20");
							//.attr('fill', isOn ? '#cc3300' : 'gray');
                       }
                   });
                },
				//------------------------------------------------------------------------------------
				highlightdescendantNodes = function(nodeId, isOn) {				   
				   // just enumerate all realted nodes and update link color:
                   var descendantNodes = [];
				   descendantNodes.push(nodeId);
				   var i = 0;
				   while (i < (descendantNodes.length))
				   {
						var descendantNode = getDataNode(descendantNodes[i]);
						descendantNode.data.toLinks.forEach(function(link){
							var linkUI = graphics.getLinkUI(link.id);
							if (linkUI) {
								linkUI.attr('stroke', isOn ? '#cc3300' : currentTheme.linkColor)
									.attr('stroke-width', isOn ? 4 : 3)
							}
							//highlightedUILinks.push(linkUI);
							//descendantNodes.pop();
						});
						
						descendantNode.data.toNodes.forEach(function (node){
							if (descendantNodes.indexOf(node.id)< 0){descendantNodes.push(node.id);}
						});
						
						i++;
						//descendantNodes.concat(descendantNode.data.toNodes);
				   }
                },
				
				highlightAncestorNodes = function(nodeId, isOn) {				   
                   var ancestorNodes = [];
				   ancestorNodes.push(nodeId);
				   var i = 0;
				   while (i < (ancestorNodes.length))
				   {
						var ancestorNode = getDataNode(ancestorNodes[i]);
						ancestorNode.data.fromLinks.forEach(function(link){
							var linkUI = graphics.getLinkUI(link.id);
							if (linkUI) {
								linkUI.attr('stroke', isOn ? '#cc3300' : currentTheme.linkColor)
									.attr('stroke-width', isOn ? 4 : 3)
							}
						});
						ancestorNode.data.fromNodes.forEach(function (node){
							if (ancestorNodes.indexOf(node.id)< 0){ancestorNodes.push(node.id);}
						});
						i++;
				   }
                },
				
				
				//------------------------------------------------------------------------------------
				highlightSelectedNode = function(nodeId) {
				
				   var nodeUI;
				   if (selectedNodeID != ''){
						nodeUI = graphics.getNodeUI(selectedNodeID);
						nodeUI.children[UI_SELECTOR_INDEX].attr('stroke','transparent');
				   }
				   if (bRelate==true)
				   {
						if (nodeId != selectedNodeID){
							Neo4j_CreateRelation(selectedNodeID, nodeId, 'TEST');
						}
						bRelate=false;
				   }
				   
				   nodeUI = graphics.getNodeUI(nodeId);
				   var node = graph.getNode(nodeId);
				   
				   if (interactionOptions.checkNodes){
					checkedNodes.push(node);
					nodeUI.children[UI_MAIN_INDEX].attr('stroke','yellow');
				   }
				   else{
					checkedNodes.forEach(function(nodex){
						var checkednodeUI = graphics.getNodeUI(nodex.id);
						checkednodeUI.children[UI_MAIN_INDEX].attr('stroke','transparent');
					});
				   }
				   
				   nodeUI.children[UI_SELECTOR_INDEX].attr('stroke','red');
				   
				   showNodeDetails(node);
				   selectedNodeID = nodeId;
				   selectedNodeData = node.data;
				   selectedNode = node;
				   selectedNodeUI = nodeUI;
				   //node.addMass = -10;
				   
				   //fetchInfo(nodeId);
				   
                };
				//------------------------------------------------------------------------------------

            
			//Node elements...
			graphics.node(function(node) {				
				ui = Viva.Graph.svg('g');
				if (!node.data) node.data = new datax;
				if (node.data.labels.indexOf("COLLECTION") > -1)
				{
					node.data.nodeOpacity = '0.1';
					node.data.textColor = 'transparent';
					//node.data.nodeSize = 10;
				}
				//Image elements...
				//img = Viva.Graph.svg('image')
                //     .attr('width', nodeSize)
                //     .attr('height', nodeSize)
                //     .link('https://secure.gravatar.com/avatar/' + node.data),
					
				//rectangle elements NODE-CIRCLE
				
				//shadow = Viva.Graph.svg('rect')
				//	.attr('x', -node.data.nodeSize/2 + 5)
				//	.attr('y', -node.data.nodeSize/2 + 5)
				//	.attr('rx', node.data.nodeSize/4)
				//	.attr('width', node.data.nodeSize*2)
				//	.attr('height', node.data.nodeSize*2)
				//	.attr('fill','#000000')//'#4dffc3')
				//	.attr('stroke-width','0')
				//	.attr('fill-opacity','0')
					
					
				rectx = Viva.Graph.svg('rect')
					.attr('x', -node.data.nodeSize/2)
					.attr('y', -node.data.nodeSize/2)
					.attr('rx', node.data.nodeSize/4)
					.attr('r', node.data.nodeSize)
					.attr('width', node.data.nodeSize*2)
					.attr('height', node.data.nodeSize*2)
					//.attr('fill','url(#gradGlow)')//node.data.nodeColor)//'#4dffc3')
					.attr('stroke-width','10')
					.attr('stroke-opacity','0.5')
					.attr('stroke-color','transparent')
					//.attr('fill-opacity','0.3'),
					//.attr('filter','url(#f3)')
				if (!currentTheme.opaque) {rectx.attr('fill-opacity',0.3);}
				
				//Circle elements NODE-CIRCLE
				circleGlow = Viva.Graph.svg('circle')
					.attr('cx', node.data.nodeSize/2)
					.attr('cy', node.data.nodeSize/2)
					.attr('r', node.data.nodeSize*1.7)
					.attr('fill','transparent')//node.data.nodeColor)//'#4dffc3')
					//.attr('stroke-width','5')
					//.attr('stroke-opacity','0.6')
					//.attr('filter','url(#f3)')
					//.attr('fill-opacity',0.5);
				if (currentTheme.glow) {circleGlow.attr('fill','url(#gradGlow)');}
				if (!currentTheme.opaque) {circleGlow.attr('fill-opacity',0.5);}
				
				//Circle elements NODE-CIRCLE
				circlex = Viva.Graph.svg('circle')
					.attr('cx', node.data.nodeSize/2)
					.attr('cy', node.data.nodeSize/2)
					.attr('r', node.data.nodeSize)
					.attr('fill',node.data.nodeColor)//node.data.nodeColor)//'#4dffc3')
					.attr('stroke-width','5')
					.attr('stroke-opacity','0.6')
					//.attr('fill-opacity',node.data.nodeOpacity);
				if (currentTheme.shadow) {circlex.attr('filter','url(#f3)');} //shadow
				if (currentTheme.rounded) {circlex.attr('fill','url(#gradRound)');}
				if (!currentTheme.opaque) {circlex.attr('fill-opacity',node.data.nodeOpacity);}
				
				uiSelected = Viva.Graph.svg('circle')
					.attr('cx', node.data.nodeSize/2) //...for circle
					.attr('cy', node.data.nodeSize/2)//...for circle
					.attr('r', node.data.nodeSize+ node.data.nodeSize/3)//...for circle
					//.attr('x', -node.data.nodeSize/2 - 5)//...for rect
					//.attr('y', -node.data.nodeSize/2 - 5)//...for rect
					//.attr('rx', node.data.nodeSize/4)//...for rect
					//.attr('width', node.data.nodeSize*2 + 10)//...for rect
					//.attr('height', node.data.nodeSize*2 + 10)//...for rect
					.attr('fill','transparent')//'#4dffc3')
					.attr('stroke-color','transparent')
					.attr('stroke-opacity','0.5')
					.attr('stroke-width',node.data.nodeSize/5)
					//.attr('fill-opacity',0.2),
					if (!currentTheme.opaque) {uiSelected.attr('fill-opacity',0.2);}
					
				//Text elements... NODE-ID
				svgText_Data = Viva.Graph.svg('text')
					.attr('y', 0) //node.data.nodeSize/2 + 5)
					.attr('x', -10)// - node.data.displayLabel.length)
					.attr('fill',currentTheme.entityLabelColor)
					.attr('stroke-width','0')
					.attr('font-family','Calibri')
					.attr('font-size','20')
					//.attr('font-size',node.data.nodeSize)
					.attr('text-decoration', 'underline')
					//.attr('font-weight', 'bold')
					.text(node.data.displayLabel),
					//if (!currentTheme.opaque) {svgText_Data.attr('fill-opacity',1);}
				
				//Text elements... NODE-DATA
				//svgText = Viva.Graph.svg('text')
				//	.attr('y', (node.data.nodeSize/2) + 10)
				//	.attr('x', (node.data.nodeSize/2) - 10)
				//	.attr('fill',node.data.textColor)
				//	.attr('stroke-width','0')
				//	.attr('font-size',(node.data.nodeSize/2))
				//	.text(node.data.labels),
				
				//Circle elements
				//circley = Viva.Graph.svg('circle')
				//	.attr('cx', 25)
				//	.attr('cy', 25)
				//	.attr('r', 5)
				//	.attr('fill','blue')
				//	.attr('stroke-width','0')
				//	.attr('stroke-opacity','0.5')
				//	.attr('fill-opacity','0.3'),
					
					
								
            // Since we are using SVG we can easily subscribe to any supported
            // events (http://www.w3.org/TR/SVG/interact.html#SVGEvents ),
            // including mouse events:
				///Node events...
                $(ui).click(function() { // MOUSE CLICK
                    highlightSelectedNode(node.id);
					layout.pinNode(node, true);
					node.data.isPinned = true;
					
                }),
				
				$(ui).dblclick(function() { // MOUSE CLICK
                    GetNodesForSelected();
					//layout.pinNode(node, true);
					//selectedNodeUI.children[UI_MAIN_INDEX].attr('filter',''); //it works, just doesn't contribute to the look & feel.
					//node.data.isPinned = true;
					
                }),
				
				$(ui).hover(function() { // MOUSE HOVER
                    if (viewOptions.highlightRelated){highlightRelatedNodes(node.id, true);}
					if (viewOptions.highlightdescendants){highlightdescendantNodes(node.id, true);}
					if (viewOptions.highlightAncestors){highlightAncestorNodes(node.id, true);}
                }, function() { // mouse out
                    if (viewOptions.highlightRelated){highlightRelatedNodes(node.id, false);}
					if (viewOptions.highlightdescendants){highlightdescendantNodes(node.id, false);}
					if (viewOptions){highlightAncestorNodes(node.id, false);}
                });
  
				//ui.append(circlex);
				
				//ui.append(img);
				//ui.append(svgText);
				//ui.innerHTML = '<defs><filter id="f1" x="0" y="0"><feGaussianBlur in="SourceGraphic" stdDeviation="15" /></filter></defs>';

				var visDefs = '<defs>';
				visDefs += '<filter id="f3" x="0" y="0" width="200%" height="200%"><feOffset result="offOut" in="SourceAlpha" dx="20" dy="20" /><feGaussianBlur result="blurOut" in="offOut" stdDeviation="10" /><feBlend in="SourceGraphic" in2="blurOut" mode="normal" /></filter>';
				visDefs += '<radialGradient id="gradGlow" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" style="stop-color:#ffffff; stop-opacity:1" /><stop offset="100%" style="stop-color:#66e0ff;stop-opacity:0" /></radialGradient>';
				visDefs += '<radialGradient id="gradRound" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="80%" style="stop-color:rgb('+node.data.nodeColorRGB.r+','+node.data.nodeColorRGB.g+','+node.data.nodeColorRGB.b+'); stop-opacity:1" /><stop offset="100%" style="stop-color:rgb('+(node.data.nodeColorRGB.r-100) +','+(node.data.nodeColorRGB.g-100)+','+(node.data.nodeColorRGB.b-100)+');stop-opacity:1" /></radialGradient>';
				//visDefs += '<radialGradient id="gradRound" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" style="stop-color:rgb(255.23,255,255); stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(0,0,255.45);stop-opacity:1" /></radialGradient>';
				visDefs += '</defs>'; 
				ui.innerHTML = visDefs;
				
				UI_GLOW_INDEX = 0;
				UI_MAIN_INDEX = 1;
				UI_SELECTOR_INDEX = 2;
				UI_TEXT_INDEX = 3;
				
				if (currentTheme.glow){ui.append(circleGlow); UI_GLOW_INDEX++; UI_MAIN_INDEX++; UI_SELECTOR_INDEX++; UI_TEXT_INDEX++;}
				ui.append(circlex);
				ui.append(uiSelected);
				ui.append(svgText_Data);
				

				
				ui.attr('nodeSize',node.data.nodeSize);
				
                return ui;
				
				
				
            }).placeNode(function(nodeUI, pos) {
                //nodeUI.attr('x', pos.x - nodeSize / 2).attr('y', pos.y - nodeSize / 2);
				var nodesize = nodeUI.attr('nodeSize');
				nodeUI.attr('transform','translate(' +(pos.x - nodesize/2) + ',' + (pos.y - nodesize/2) + ')');
            });

			//====== LINK DRAWING ========================================================================================================
			// To render an arrow we have to address two problems:
            //  1. Links should start/stop at node's bounding box, not at the node center.
            //  2. Render an arrow shape at the end of the link.

            // Rendering arrow shape is achieved by using SVG markers, part of the SVG
            // standard: http://www.w3.org/TR/SVG/painting.html#Markers
            var createMarker = function(id) {
                    return Viva.Graph.svg('marker')
                               .attr('id', id)
                               .attr('viewBox', "0 0 10 10")
                               .attr('refX', "10")
                               .attr('refY', "5")
                               .attr('markerUnits', "strokeWidth")
                               .attr('markerWidth', "4")
                               .attr('markerHeight', "4")
                               .attr('orient', "auto");
							   
                },
			
            markerTraingle = createMarker('Triangle');
            markerTraingle.append('path')
			//.attr('stroke-width', '3')
			.attr('d', 'M 0 0 L 12 5 L 0 10 z')
			.attr('fill',currentTheme.linkColor);

            // Marker should be defined only once in <defs> child element of root <svg> element:
            var defs = graphics.getSvgRoot().append('defs');
            defs.append(markerTraingle);

            var geom = Viva.Graph.geom();

            graphics.link(function(link){
				
                // Notice the Triangle marker-end attribe:
                var linkPath = Viva.Graph.svg('path')
                           .attr('stroke', currentTheme.linkColor)
                           .attr('stroke-width', '3')
						   .attr('marker-end', 'url(#Triangle)')
						   if (!currentTheme.opaque) {linkPath.attr('stroke-opacity', 0.5);}
				return linkPath;   
            }).placeLink(function(linkUI, fromPos, toPos) {
                // Here we should take care about
                //  "Links should start/stop at node's bounding box, not at the node center."

                // For rectangular nodes Viva.Graph.geom() provides efficient way to find
                // an intersection point between segment and rectangle
                var fromNodeID = linkUI.attr('fromNode');
				var toNodeID = linkUI.attr('toNode');
				var fromNode =GRAPH.getNode(fromNodeID);
				var toNode =GRAPH.getNode(toNodeID);
				toNodeSize = toNode.data.nodeSize;
				fromNodeSize = fromNode.data.nodeSize;
				
				var toNodeSize = nodeSize * 2,
                    fromNodeSize = nodeSize * 2;
				
				toNodeSize = toNode.data.nodeSize * 2;
				fromNodeSize = fromNode.data.nodeSize * 2;
				
                var from = geom.intersectRect(
                        // rectangle:
                                fromPos.x - fromNodeSize / 2, // left
                                fromPos.y - fromNodeSize / 2, // top
                                fromPos.x + fromNodeSize / 2, // right
                                fromPos.y + fromNodeSize / 2, // bottom
                        // segment:
                                fromPos.x, fromPos.y, toPos.x, toPos.y)
                           || fromPos; // if no intersection found - return center of the node

                var to = geom.intersectRect(
                        // rectangle:
                                toPos.x - toNodeSize / 2, // left
                                toPos.y - toNodeSize / 2, // top
                                toPos.x + toNodeSize / 2, // right
                                toPos.y + toNodeSize / 2, // bottom
                        // segment:
                                toPos.x, toPos.y, fromPos.x, fromPos.y)
                            || toPos; // if no intersection found - return center of the node

                var data = 'M' + from.x + ',' + from.y +
                           'L' + to.x + ',' + to.y;

                linkUI.attr("d", data);
            });
			//==============================================================================================================

            //graphics.link(function(link){
            //    return Viva.Graph.svg('path')
            //                  .attr('stroke', 'black');
			//				  //.attr('stroke-width', '2');
            //}).placeLink(function(linkUI, fromPos, toPos) {
            //    var data = 'M' + fromPos.x + ',' + fromPos.y +
            //               'L' + toPos.x + ',' + toPos.y;
            //    linkUI.attr("d", data);
            //})

            // Finally render the graph with our customized graphics object:
            renderer = Viva.Graph.View.renderer(graph, {
              layout   : layout, //Exclude custom physics
              graphics   : graphics,
              renderLinks : true,
              prerender  : true,
			  container : document.getElementById('graphContainer')
            });
			
			//var renderer2 = Viva.Graph.View.renderer(graph, {
			//  container : document.getElementById('schemaContainer')
            //});
			
			GRAPH = graph;
				
            renderer.run();
			//renderer2.run();
//=====================================================================================================================================================================================
			//connectUser();
			//Neo4j_InitAllNodes();
			//startupLabels.forEach(function(label){
			//		Neo4j_GetNodesByLabel(label);
			//});
			document.getElementById('graphContainer').style.background=currentTheme.graphBackground;
			
			
//=====================================================================================================================================================================================
        }
    </script>

    <style type="text/css" media="screen">
        html, body { width: 100%; height: 100%; background-color: #3a3a3a;}
	
		body{
			height: 100%;
			width: 100%;
			position: absolute;
			overflow: hidden;
			left: 0;
			top: 0;
		  }
	
		svg, #graphContainer, #schemaContainer { 
			width: 100%; 
			height: 100%; 
			//background-color: #3a3a3a;
			margin: 0px;
			float:left;
		}
		.label {
			//position: absolute;
			top: 10px;
			color: white;
			font-size: 12px;
			left: 10px;
			font-family: Verdana;
			font-weight: bold;
		}
		  
		  #labelPanel {
			width:90%;
			margin-top:5px;
			margin-left:5px;
			padding:5px;
			border-style:solid;
			border-width:0px;
			border-color:#4d4d4d;
			color: #1a1a1a;
			background-color: #4d4d4d;
			border-radius:15px;
			text-align: center;
			
		  }
		  .clearfix {
			overflow: auto;
		  }
		  
		  #toolPanel {
			float:left;
			width:200px;
			margin:5px;
			margin-left:5px;
			padding:5px;
			border-style:solid;
			border-width:2px;
			border-color:#0d0d0d;
			color: deepskyblue;
			background-color:#1a1a1a;
			border-radius:10px;
			
		  }
		  .clearfix {
			overflow: auto;
		  }
		  .panelheader {
			margin:0px;
			padding:0px;
			font-size: 10px;
			color: deepskyblue;
			text-decoration: underline;
			float:top;
			letter-spacing: 1px;
		  }

		  #leftColumn {
			float:left;
			width:250px;
			margin:0px;
			padding:0px;
			border-style:solid;
			border-width:0px;
			overflow: none;
		  }
		  
		  #graphPanel {
			float:left;
			width:60%;
			height:80%;
			margin-top:5px;
			margin-left:10px;
			padding:5px;
			border-style:solid;
			border-width:2px;
			border-color:#0d0d0d;
			color: deepskyblue;
			background-color: #1a1a1a;
			border-radius:10px;
		  }
		  .clearfix {
			overflow: auto;
		  }
		  

button {
    background-color: #b3b3b3; 
    color: black; 
    //border: 2px solid #8c8c8c;
	height: 20px;
    border: none;
    //padding: 16px 32px;
    text-align: top;
    text-decoration: none;
    display: inline-block;
    font-size: 10px;
    margin: 3px 1px;
    -webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
    cursor: pointer;
	border-radius: 3px;
}

button:hover {
    background-color: #00a3cc; //#4CAF50;
    color: white;
}
//button:focus {outline:0;}
.fortext {
	margin: 0px 5px;
	height: 12px;
	padding: 2px 2px 2px 2px;
}
/* Tooltip container */
.tooltip {
    position: relative;
	outline:0;
    display: inline-block;
    //border-bottom: 1px dotted black; /* If you want dots under the hoverable text */
}

/* Tooltip text */
.tooltip .tooltiptext {
    visibility: hidden;
    width: 120px;
    background-color: #555;
    color: #fff;
    text-align: center;
    padding: 5px 0;
    border-radius: 6px;

    /* Position the tooltip text */
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -60px;

    /* Fade in tooltip */
    opacity: 0;
    transition: opacity 1s;
}

/* Tooltip arrow */
.tooltip .tooltiptext::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #555 transparent transparent transparent;
	
}

input {
	width:100px;
	height:10px;
	margin:2px;
	border-radius: 6px;
	background-color: #b3ffff;
	border-color: transparent;
}.check{width:10px;}
select {
	width:100px;
	height:18px;
	margin:2px;
	border-radius: 6px;
	background-color: #b3ffff;
	border-color: transparent;
}

/* Show the tooltip text when you mouse over the tooltip container */
.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}
		
#hovertext:hover {
	font-size: 15px;
    //color: red;
	text-decoration: underline;
}



		
    </style>
</head>

<body onload='main()'>

	<!--canvas id="myCanvas" width="200" height="100" style="border:5px solid #000000;" fill="#3a3a3a">
	</canvas-->

	<div id='leftColumn' style='height:100%; width:220px; overflow:auto;'>
		<div id='toolPanel' style='overflow:auto;'>
			<span id="availableLabels" class="label"></span>
		</div>
		
		<div id='toolPanel'>
			<div id='newNode'>
			  <div class="panelheader">View Options:</div>
			  <input class="check" id="vo.hr" onclick="updateViewOptions()" type="checkbox" name="related" value="" checked="true"> Highlight Related<br>
			  <input class="check" id="vo.ha" onclick="updateViewOptions()" type="checkbox" name="ancestors" value=""> Highlight Ancestors<br>
			  <input class="check" id="vo.hd" onclick="updateViewOptions()" type="checkbox" name="descendants" value=""> Highlight Descendants<br>
			</div>
		</div>
	
		<div id='toolPanel'>
			<div id='newNode'>
			  <div class="panelheader">Selection Options:</div>
			  <input class="check" id="vo.ch" onclick="updateInteractionOptions()" type="checkbox" name="descendants" value=""> Multi Select<br>
			</div>
		</div>
	</div>
	
	<div id='graphPanel'>
		<div id='graphContainer'></div>
	</div>
	
	<!--div id='graphPanel'>
		<div id='schemaContainer'></div>
	</div-->

	<div id='toolPanel'>
		<div id='selectedNode'></div>
	</div>
	<div id='toolPanel'>
		<div id='nodeDetails'>
		</div>
	</div>
	
	</div>
		<div id='toolPanel'>
		<div> 
			<div class="panelheader">Bulk</div>
			<button onclick='Neo4j_InitAllNodes()'>Get All</button>
			<button onclick='unPinAllNodes()'>Unpin All</button>
			<button onclick='arrangeBy()'>Arrange</button>
		</div>
	</div>

	</div>
		<div id='toolPanel'>
		<div>
			<div class="panelheader">Data</div>
			<button onclick='GetNodesForSelected()'>Get Next</button>
		</div>
	</div>
	

	</div>
		<div id='toolPanel'>
		<div>
			<div class="panelheader">Appearance</div>
			<button class="tooltip">Node
				<div class="tooltiptext">
					<div id="hovertext" onclick='increaseNodeSize()'>Grow</div>
					<div id="hovertext" onclick='decreaseNodeSize()'>Shrink</div>
					<div id="hovertext" onclick='unPinNode()'>Unpin</div>	
					<div id="hovertext" onclick='refreshNodeAppearance()'>Refresh Visual</div>
				</div>
			</button>
			
			<button class="tooltip">Font
				<div class="tooltiptext">
						<div id="hovertext" onclick='fontGrow()'>Grow</div>
						<div id="hovertext" onclick='fontShrink()'>Shrink</div>
						<div id="hovertext" onclick='fontUp()'>Move Up</div>
						<div id="hovertext" onclick='fontDown()'>Move Down</div>
				</div>
			</button>
			
			
		</div>
	</div>
	
	<div id='toolPanel'>
		<div>
			<button onclick='relateSelectedToNode()'>Relate entity</button>
			<button onclick='deleteNode()'>Delete entity</button>
		</div>
	</div>
	
	<div id='toolPanel'>		
		<div class="panelheader">Update selected entity:</div> 
		<input id='log' value=''></input>
		<button onclick='addLabel()'>Add Label</button>
	</div>
	
	<div id='toolPanel'>		
		<div class="panelheader">Add/Update Property:</div> 
		Name: <input id='add.property.key' value=''></input><br>
		Value: <input id='add.property.value' value=''></input><br>
		Type:
		<select id='add.property.type'>
		  <option value="string">Text</option>
		  <option value="number">Number</option>
		  <option value="bool">True/False</option>
		</select>
		<button onclick='addProperty()'>Selected</button>
		<button onclick='addPropertyToChecked()'>Highlighted</button>
		<button onclick='addPropertyToAll()'>All</button>
	</div>
	
	<div id='toolPanel'>
		<div id='newNode'>
		  <div class="panelheader">Label:</div>
		  <input id="newNodeData" type="text" name="lname"><br>
		  <button onclick='createNode()'>Add new entity</button>
		</div>
	</div>
	

	


</body>

</html>
